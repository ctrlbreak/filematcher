# Milestone v1.3: Code Unification

**Status:** SHIPPED 2026-01-23
**Phases:** 5-10
**Total Plans:** 18

## Overview

Unified output architecture across modes and added machine-readable JSON output for scripting and automation. Culminated in refactoring compare mode to use the same ActionFormatter hierarchy as action modes, eliminating 513 lines of duplicate code.

## Phases

### Phase 5: Formatter Abstraction

**Goal**: Create unified output abstraction layer without changing user-visible behavior
**Depends on**: Phase 4
**Requirements**: OUT-04
**Plans**: 3 plans
**Completed**: 2026-01-22

Plans:
- [x] 05-01: Define ABC hierarchy (CompareFormatter, ActionFormatter) and TextFormatter implementations
- [x] 05-02: Wire TextActionFormatter into main() action mode branches
- [x] 05-03: Wire TextCompareFormatter into main() compare mode branches

**Details:**
- Created CompareFormatter and ActionFormatter abstract base classes
- TextCompareFormatter and TextActionFormatter implementations
- Deterministic output via sorted hash iteration (OUT-04)
- All existing tests pass with byte-identical output

### Phase 6: JSON Output

**Goal**: Expose JSON output through CLI with stable schema and comprehensive metadata
**Depends on**: Phase 5
**Requirements**: JSON-01, JSON-02, JSON-03, JSON-04
**Plans**: 3 plans
**Completed**: 2026-01-23

Plans:
- [x] 06-01: Implement JsonCompareFormatter and JsonActionFormatter classes
- [x] 06-02: Add --json CLI flag and wire formatters into main()
- [x] 06-03: JSON output tests and README schema documentation

**Details:**
- JsonCompareFormatter and JsonActionFormatter using accumulator pattern
- camelCase field names, RFC 3339 timestamps
- Logger to stderr when --json for clean stdout
- 31 JSON tests, schema documented with jq examples

### Phase 7: Output Unification

**Goal**: Consistent output structure across compare and action modes with statistics in all modes
**Depends on**: Phase 6
**Requirements**: OUT-01, OUT-02, OUT-03
**Plans**: 4 plans
**Completed**: 2026-01-23

Plans:
- [x] 07-01: Stream separation (stderr routing) and --quiet flag
- [x] 07-02: Unified header format and summary line for both modes
- [x] 07-03: Statistics footer in compare mode
- [x] 07-04: Tests for output unification and README updates

**Details:**
- All progress/status to stderr, data to stdout (Unix convention)
- --quiet flag suppresses progress (ERROR level only)
- Unified headers with mode indicator
- Statistics footer in all modes

### Phase 8: Color Enhancement

**Goal**: TTY-aware color output highlighting key information
**Depends on**: Phase 7
**Requirements**: UX-01, UX-02, UX-03
**Plans**: 3 plans
**Completed**: 2026-01-23

Plans:
- [x] 08-01: ColorConfig class, ANSI constants, and colorize helper functions
- [x] 08-02: Add --color/--no-color CLI flags and integrate color into Text formatters
- [x] 08-03: Tests for color output and README documentation

**Details:**
- ColorConfig with TTY auto-detection
- 16-color SGR codes for terminal compatibility
- NO_COLOR and FORCE_COLOR environment support
- --color/--no-color flags with last-wins semantics
- JSON never colored

### Phase 9: Unify Group Output

**Goal**: Unify output format between compare mode and action mode for duplicate groups
**Depends on**: Phase 8
**Plans**: 1 plan
**Completed**: 2026-01-23

Plans:
- [x] 09-01: Update TextCompareFormatter.format_match_group for hierarchical output

**Details:**
- Hierarchical format (primary unindented, secondary indented)
- [dir1]/[dir2] labels matching action mode's [MASTER]/[WOULD X] pattern
- Green for dir1, yellow for dir2 (consistent with action mode)
- Hash as trailing detail, truncated to 10 chars

### Phase 10: Unify Compare as Action

**Goal**: Refactor default compare mode into a "compare" action that reuses the action code path
**Depends on**: Phase 9
**Plans**: 4 plans
**Completed**: 2026-01-23

Plans:
- [x] 10-01: Add compare to action choices with default and validation
- [x] 10-02: Extend ActionFormatter classes to handle compare action
- [x] 10-03: Unify main() to use action path for all modes
- [x] 10-04: Delete CompareFormatter hierarchy and dead code

**Details:**
- compare is default action (not None)
- ActionFormatter extended to handle compare mode
- Unified main() code path for all action types
- Deleted CompareFormatter ABC, TextCompareFormatter, JsonCompareFormatter
- 513 lines removed (2951 -> 2438)

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Phase |
|----------|-----------|-------|
| ABC vs typing.Protocol | Explicit inheritance with runtime checks | 05-01 |
| Accumulator pattern for JSON | format_* methods collect data, finalize() serializes | 06-01 |
| camelCase field names | JavaScript conventions for JSON | 06-01 |
| stderr for progress | Unix convention: status to stderr, data to stdout | 07-01 |
| 16-color SGR codes | Maximum terminal compatibility | 08-01 |
| compare is default action | Always have meaningful action value | 10-01 |
| Single ActionFormatter hierarchy | Unified code path, 513 lines removed | 10-04 |

**Issues Resolved:**

- Inconsistent output between compare and action modes
- No machine-readable output format
- No color highlighting for key information
- Duplicate code paths for compare vs action modes

**Issues Deferred:**

- 6 edge-case print() calls bypass formatters (tech debt, minor impact)
- Null-separated output (-0 flag)
- JSON Lines streaming (--jsonl flag)
- Custom format templates (--format flag)

**Technical Debt Incurred:**

- 6 edge-case print statements in main() bypass formatters (empty results, abort, section headers)
  - Recommendation: Add format_empty_result(), format_user_abort() methods in future cleanup

---

_For current project status, see .planning/MILESTONES.md_

---
*Archived: 2026-01-23 as part of v1.3 milestone completion*
