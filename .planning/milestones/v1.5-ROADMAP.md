# Milestone v1.5: Interactive Execute

**Status:** ✅ SHIPPED 2026-01-31
**Phases:** 18-21 (including 20.1 inserted)
**Total Plans:** 10

## Overview

Transform execute mode from batch-only to interactive-by-default with per-file y/n/a/q confirmation. This milestone extends the existing formatter architecture with new prompt methods, builds the interactive execution loop, integrates flag validation into CLI, and ensures robust error handling with comprehensive summaries.

## Phases

### Phase 18: Formatter Extensions

**Goal**: Establish formatter foundation for interactive prompts using existing Strategy pattern
**Depends on**: Phase 17
**Requirements**: OUT-02, OUT-04, ARCH-01, ARCH-02
**Plans**: 2 plans

Plans:
- [x] 18-01-PLAN.md - Extend ActionFormatter ABC with prompt methods
- [x] 18-02-PLAN.md - Add unit tests for new formatter methods

**Details:**
- Added `format_group_prompt()`, `format_confirmation_status()`, `format_remaining_count()` to ActionFormatter ABC
- TextActionFormatter implements with colors and Unicode symbols (✓/✗)
- JsonActionFormatter implements as no-ops (JSON mode requires --yes)
- _ACTION_PROMPT_VERBS constant mapping for action-specific prompts

### Phase 19: Interactive Core

**Goal**: Implement per-group display-prompt-decide loop in cli.py
**Depends on**: Phase 18
**Requirements**: INT-01, INT-02, INT-03, OUT-03
**Plans**: 2 plans

Plans:
- [x] 19-01-PLAN.md - Core interactive functions (interactive_execute, prompt_for_group, _normalize_response)
- [x] 19-02-PLAN.md - Unit tests for interactive loop functions

**Details:**
- `interactive_execute()` function with per-group confirmation loop
- `prompt_for_group()` for validated user input with re-prompt on invalid
- `_normalize_response()` helper using casefold() for Unicode handling
- Immediate execution after 'y' response (not batched)
- Extended return tuple with confirmed_count and user_skipped_count

### Phase 20: CLI Integration

**Goal**: Wire interactive mode into CLI with proper flag validation
**Depends on**: Phase 19
**Requirements**: INT-04, INT-05, FLAG-01, FLAG-02, OUT-01
**Plans**: 2 plans

Plans:
- [x] 20-01-PLAN.md - Fail-fast flag validation and banner formatting
- [x] 20-02-PLAN.md - Mode routing and integration tests

**Details:**
- Fail-fast validation at parser level (exit code 2 before file scanning)
- Non-TTY stdin detection with clear error message
- --json --execute requires --yes validation
- --quiet --execute requires --yes validation
- Unified banner display for interactive and batch modes

### Phase 20.1: JSON Header Object Format (INSERTED)

**Goal**: Restructure JSON output with unified header object for better machine parsing
**Depends on**: Phase 20
**Requirements**: JSON-01 (new)
**Plans**: 1 plan

Plans:
- [x] 20.1-01-PLAN.md - Update JsonActionFormatter and tests for header structure

**Details:**
- Version 2.0 indicates breaking schema change
- Header object contains: name, version, timestamp, mode, action, hashAlgorithm, directories
- Directory keys unified to master/duplicate across all modes
- Header constructed in finalize() (timestamp at output time)
- Compare mode has no action field

### Phase 21: Error Handling & Polish

**Goal**: Ensure robust error recovery and comprehensive feedback
**Depends on**: Phase 20.1
**Requirements**: ERR-01, ERR-02, ERR-03
**Plans**: 3 plans

Plans:
- [x] 21-01-PLAN.md - Inline error display and quit summary
- [x] 21-02-PLAN.md - Enhanced final summary and tests
- [x] 21-03-PLAN.md - Integration tests for error handling

**Details:**
- EXIT_USER_QUIT = 130 (Unix convention 128 + SIGINT)
- Inline error display with red X marker
- Failed operations still logged to audit trail
- Audit log failure aborts early (exit 2)
- Three-way distinction in summary: confirmed/skipped/failed
- Dual-format space display (human-readable + bytes)
- EXIT_PARTIAL (2) on any execution failures

---

## Milestone Summary

**Decimal Phases:**
- Phase 20.1: JSON Header Object Format (inserted after Phase 20 for schema restructuring)

**Key Decisions:**
- Interactive by default for --execute (safer UX, --yes for scripts)
- y/n/a/q response pattern (follows git add -p convention)
- JSON schema v2.0 with header object (breaking change)
- Exit code 130 for user quit (Unix convention)
- Fail-fast flag validation (errors before file scanning)
- casefold() instead of lower() for Unicode handling
- Execute immediately after 'y' (not batched)

**Issues Resolved:**
- Batch confirmation was too coarse-grained for careful review
- JSON schema had inconsistent directory naming (dir1/dir2 vs master/duplicate)
- No way to quit mid-execution cleanly

**Issues Deferred:**
- Help command (?) during prompts
- Undo last action
- Progress bars for large operations

**Technical Debt Incurred:**
- confirm_execution() and format_confirmation_prompt() exist outside Strategy pattern (accepted as CLI-specific)

---

*For current project status, see .planning/PROJECT.md*
