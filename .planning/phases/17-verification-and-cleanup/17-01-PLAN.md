---
phase: 17-verification-and-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_file_hashing.py
  - tests/test_fast_mode.py
  - tests/test_directory_operations.py
  - tests/test_cli.py
  - tests/test_real_directories.py
  - tests/test_actions.py
  - tests/test_json_output.py
  - tests/test_color_output.py
  - tests/test_master_directory.py
  - tests/test_safe_defaults.py
autonomous: true

must_haves:
  truths:
    - "All 217 tests pass with from filematcher import X pattern"
    - "No circular imports exist when importing from filematcher package"
    - "Package imports cleanly from fresh Python subprocess"
    - "Subprocess CLI tests still use file_matcher.py for backward compatibility testing"
  artifacts:
    - path: "tests/test_file_hashing.py"
      provides: "Hashing tests with filematcher imports"
      contains: "from filematcher import"
    - path: "tests/test_fast_mode.py"
      provides: "Fast mode tests with filematcher imports"
      contains: "import filematcher"
    - path: "tests/test_directory_operations.py"
      provides: "Directory tests with filematcher imports and circular import verification"
      contains: "from filematcher import"
  key_links:
    - from: "tests/*.py"
      to: "filematcher/__init__.py"
      via: "from filematcher import"
      pattern: "from filematcher import"
    - from: "tests/test_fast_mode.py"
      to: "filematcher module reference"
      via: "import filematcher; filematcher.X"
      pattern: "filematcher\\.get_file_hash"
---

<objective>
Migrate all test imports from `file_matcher` (backward-compat wrapper) to `filematcher` (package) and verify no circular imports.

Purpose: Validates the Phase 11-16 refactoring is complete by ensuring tests use the new package import pattern directly, confirming the package structure works correctly.

Output: All 217 tests passing with `from filematcher import X` pattern, plus a circular import verification test.
</objective>

<execution_context>
@/Users/patrick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-verification-and-cleanup/17-RESEARCH.md

# Source files
@filematcher/__init__.py
@tests/test_fast_mode.py
@tests/test_color_output.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update test imports to filematcher package</name>
  <files>
    tests/test_file_hashing.py
    tests/test_fast_mode.py
    tests/test_directory_operations.py
    tests/test_cli.py
    tests/test_real_directories.py
    tests/test_actions.py
    tests/test_json_output.py
    tests/test_color_output.py
    tests/test_master_directory.py
    tests/test_safe_defaults.py
  </files>
  <action>
    Update all test file imports from `file_matcher` to `filematcher`:

    1. **Module-level simple imports** (7 files):
       - test_file_hashing.py line 8: `from file_matcher import` -> `from filematcher import`
       - test_cli.py line 12: `from file_matcher import` -> `from filematcher import`
       - test_real_directories.py line 6: `from file_matcher import` -> `from filematcher import`
       - test_master_directory.py line 14: `from file_matcher import` -> `from filematcher import`
       - test_safe_defaults.py line 12: `from file_matcher import` -> `from filematcher import`

    2. **Module-level multi-line imports** (2 files):
       - test_actions.py line 17: `from file_matcher import (` -> `from filematcher import (`
       - test_directory_operations.py line 9: `from file_matcher import (` -> `from filematcher import (`

    3. **Module import with attribute access** (1 file - test_fast_mode.py):
       - Line 7: `import file_matcher` -> `import filematcher`
       - Line 8: `from file_matcher import` -> `from filematcher import`
       - Line 117: `file_matcher.get_file_hash` -> `filematcher.get_file_hash` (2 occurrences)
       - Line 134: `file_matcher.get_file_hash` -> `filematcher.get_file_hash` (2 occurrences)

    4. **Local imports in test methods** (2 files):
       - test_json_output.py lines 21, 583, 619, 670: `from file_matcher import` -> `from filematcher import`
       - test_color_output.py lines 279, 284, 290, 296, 306, 312, 317, 327, 338: `from file_matcher import` -> `from filematcher import`

    **DO NOT MODIFY:**
    - tests/__init__.py (comment only, path setup)
    - test_output_unification.py (subprocess tests using file_matcher.py CLI - tests backward compat)
    - test_determinism.py (subprocess tests using file_matcher.py CLI - tests backward compat)
    - test_color_output.py subprocess calls to `file_matcher.py` (keep for backward compat testing)

    **Total: 19 import statements to update across 10 files**
  </action>
  <verify>
    Run: `python3 run_tests.py`
    Expected: 217 tests pass (same count as before)

    Run: `grep -r "from file_matcher import" tests/ | grep -v "__pycache__" | grep -v ".pyc"`
    Expected: Only results from tests/__init__.py (comment) and no module imports
  </verify>
  <done>
    All test files import from `filematcher` package (not `file_matcher` module).
    All 217 tests pass unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add circular import verification and run final checks</name>
  <files>tests/test_directory_operations.py</files>
  <action>
    Add a circular import verification test to test_directory_operations.py (it already tests package structure concerns).

    Add this test method to the TestDirectoryOperations class:

    ```python
    def test_no_circular_imports(self):
        """Verify filematcher package imports cleanly in fresh subprocess (PKG-04)."""
        import subprocess
        import sys

        # Test importing all major exports in fresh Python process
        result = subprocess.run(
            [sys.executable, '-c', '''
from filematcher import (
    main,
    find_matching_files,
    index_directory,
    get_file_hash,
    get_sparse_hash,
    execute_action,
    execute_all_actions,
    safe_replace_with_link,
    ColorConfig,
    ColorMode,
    ActionFormatter,
    TextActionFormatter,
    JsonActionFormatter,
    is_hardlink_to,
    is_symlink_to,
    check_cross_filesystem,
    create_audit_logger,
)
print("All imports successful")
'''],
            capture_output=True,
            text=True,
            cwd=str(Path(__file__).parent.parent)
        )
        self.assertEqual(result.returncode, 0, f"Import failed: {result.stderr}")
        self.assertIn("All imports successful", result.stdout)
        self.assertNotIn("ImportError", result.stderr)
        self.assertNotIn("circular", result.stderr.lower())
    ```

    Note: The `Path` import is already available in test_directory_operations.py via `from pathlib import Path`.
  </action>
  <verify>
    Run: `python3 -m tests.test_directory_operations`
    Expected: All tests pass including the new circular import test

    Run: `python3 run_tests.py`
    Expected: 218 tests pass (217 + 1 new test)

    Run fresh subprocess import check:
    ```
    python3 -c "from filematcher import main, find_matching_files, get_file_hash, ColorConfig; print('OK')"
    ```
    Expected: Prints "OK" with no errors
  </verify>
  <done>
    New test_no_circular_imports test added and passing.
    Total test count is 218 (217 original + 1 new).
    Package imports cleanly from fresh subprocess.
  </done>
</task>

</tasks>

<verification>
1. All 217 original tests pass with updated imports
2. New circular import test passes (test count now 218)
3. No imports from `file_matcher` in test modules (except backward compat subprocess tests)
4. Fresh subprocess import succeeds
5. Backward compatibility tests (test_output_unification, test_determinism, test_color_output CLI calls) still use file_matcher.py
</verification>

<success_criteria>
- [ ] 218 tests pass (217 original + 1 new circular import test)
- [ ] `grep -r "from file_matcher import" tests/` returns only comment in __init__.py
- [ ] `python3 -c "from filematcher import main"` succeeds in fresh subprocess
- [ ] Subprocess CLI tests in test_color_output.py, test_determinism.py, test_output_unification.py unchanged (they test backward compat)
</success_criteria>

<output>
After completion, create `.planning/phases/17-verification-and-cleanup/17-01-SUMMARY.md`
</output>
