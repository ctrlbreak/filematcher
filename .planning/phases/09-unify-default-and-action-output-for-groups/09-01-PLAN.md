---
phase: 09-unify-group-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - file_matcher.py
  - tests/test_master_directory.py
  - tests/test_cli.py
  - tests/test_output_unification.py
autonomous: true

must_haves:
  truths:
    - "Compare mode shows files with directory labels [dir1]/[dir2] instead of hash header"
    - "Compare mode uses hierarchical format (first file unindented, matches indented)"
    - "Hash is shown as trailing detail, not header"
    - "All existing tests pass with updated assertions"
  artifacts:
    - path: "file_matcher.py"
      provides: "Updated TextCompareFormatter.format_match_group()"
      contains: "\\[{self.dir1_name}\\]"
  key_links:
    - from: "TextCompareFormatter.format_match_group"
      to: "green/yellow color helpers"
      via: "colorized labels"
      pattern: "green\\(.*\\[.*self\\.dir"
---

<objective>
Unify compare mode group output with action mode's hierarchical format.

Purpose: Consistent visual structure across modes - files first with directory labels, hash as trailing detail. Plus code consolidation to remove duplication and unused code from the old output. This completes the output unification work started in Phase 7.

Output: Updated TextCompareFormatter producing hierarchical output matching action mode's [MASTER]/[WOULD X] pattern, using [dir1]/[dir2] labels.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-unify-default-and-action-output-for-groups/09-RESEARCH.md

# Current implementation to modify
@file_matcher.py (lines 508-524 - TextCompareFormatter.format_match_group)

# Tests that need updating
@tests/test_master_directory.py (lines 28-68 - "Hash:" assertions)
@tests/test_cli.py (lines 56, 74-75 - "Hash:" and "Files in" assertions)
@tests/test_output_unification.py (lines 37, 83, 107, 126, 271 - "Hash:" assertions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TextCompareFormatter.format_match_group</name>
  <files>file_matcher.py</files>
  <action>
Modify TextCompareFormatter.format_match_group() (around lines 508-524) to use hierarchical format:

**New format:**
```
[dir1] /path/to/primary_file.txt
    [dir1] /path/to/other_dir1_file.txt
    [dir2] /path/to/matching_file.txt
  Hash: bc746e25b4...
```

Implementation:
1. First file from sorted dir1 list is "primary" (unindented, green)
2. Additional dir1 files indented with 4 spaces (green)
3. All dir2 files indented with 4 spaces (yellow)
4. Hash as trailing detail line with 2-space indent (dim)
5. Blank line after each group

Use existing color helpers: green(), yellow(), dim() with self.cc (ColorConfig).

Example implementation:
```python
def format_match_group(self, file_hash: str, files_dir1: list[str], files_dir2: list[str]) -> None:
    """Format a group of matching files with unified hierarchical structure."""
    sorted_dir1 = sorted(files_dir1)
    sorted_dir2 = sorted(files_dir2)

    # Primary file: first from dir1 (green, unindented)
    primary = sorted_dir1[0]
    print(green(f"[{self.dir1_name}] {primary}", self.cc))

    # Additional dir1 files (indented, green)
    for f in sorted_dir1[1:]:
        print(green(f"    [{self.dir1_name}] {f}", self.cc))

    # Dir2 files (indented, yellow)
    for f in sorted_dir2:
        print(yellow(f"    [{self.dir2_name}] {f}", self.cc))

    # Hash as de-emphasized trailing detail
    print(dim(f"  Hash: {file_hash[:10]}...", self.cc))
    print()
```
  </action>
  <verify>
Run: `python3 file_matcher.py test_dir1 test_dir2`
Verify output shows:
- `[test_dir1]` and `[test_dir2]` labels
- Hierarchical format (first file unindented, rest indented)
- `Hash:` line appears after file list, not before
  </verify>
  <done>
Compare mode output uses [dir1]/[dir2] labels with hierarchical structure, hash as trailing detail.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tests for new output format</name>
  <files>tests/test_master_directory.py, tests/test_cli.py, tests/test_output_unification.py</files>
  <action>
Update test assertions to verify new format. The key change: "Hash:" still appears but in different position; "Files in" sub-headers are replaced by inline labels.

**tests/test_master_directory.py:**

1. test_compare_mode_works (line 28-33):
   - Change assertion from "Hash:" to check for directory labels
   - Update: `self.assertIn("[test_dir1]", output)` or use regex for `\[.*\]` pattern
   - Keep `self.assertIn("Hash:", output)` - hash still appears, just in different position

2. test_no_action_preserves_compare_format (line 64-68):
   - Update docstring: "Test that without --action, output uses hierarchical format"
   - Change assertion to verify new format

**tests/test_cli.py:**

1. test_summary_option (line 46):
   - "Files in" still appears in format_summary() output, NOT format_match_group
   - Check if this assertion is about summary stats (keep) or group output (update)
   - Read context: This is format_summary() which shows "Files in dir1_name with matches" - KEEP

2. test_summary_option (line 56):
   - assertNotIn("Hash:", output) for --summary mode - KEEP (summary shouldn't show Hash)

3. Default output test (line 74-75):
   - assertIn("Hash:", output) - KEEP (hash still appears)
   - assertIn("Files in", output) - CHANGE to assertIn("[test_dir1]", output)

**tests/test_output_unification.py:**

1. Line 37, 83, 107, 126, 271: assertIn("Hash:", result.stdout)
   - KEEP all - hash still appears in output, just at end of group
   - Line 271: Position check `hash_pos = result.stdout.find("Hash:")` - UPDATE
     The test checks stats comes after Hash, which remains true

2. No changes needed for Hash assertions since hash still appears

Key insight: The "Hash:" string still appears in output, just in a different position (trailing instead of leading). Most tests checking "Hash:" can remain unchanged. Only tests checking "Files in" within match groups need updates.
  </action>
  <verify>
Run: `python3 run_tests.py`
All 198+ tests pass.
  </verify>
  <done>
All test assertions updated to verify new hierarchical format with directory labels.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update README output examples</name>
  <files>README.md</files>
  <action>
Update any compare mode output examples in README.md to show new format.

Search for existing output examples showing the old format:
```
Hash: bc746e25b4...
  Files in dir1:
    /path/to/file
```

Replace with new format:
```
[dir1] /path/to/primary.txt
    [dir2] /path/to/matching.txt
  Hash: bc746e25b4...
```

If no compare mode examples exist in README, no changes needed. Focus on any "Usage" or "Examples" sections.
  </action>
  <verify>
Review README.md for any outdated output examples.
Run: `python3 file_matcher.py test_dir1 test_dir2` and visually compare with README examples.
  </verify>
  <done>
README output examples (if any) reflect the new hierarchical format.
  </done>
</task>

</tasks>

<verification>
1. Manual verification: `python3 file_matcher.py test_dir1 test_dir2`
   - Output shows [test_dir1] and [test_dir2] labels
   - First file unindented, subsequent files indented
   - Hash appears at end of each group

2. Test suite: `python3 run_tests.py`
   - All tests pass (198+)

3. Color verification: `python3 file_matcher.py test_dir1 test_dir2 --color`
   - dir1 files in green
   - dir2 files in yellow
   - Hash line dim

4. JSON unchanged: `python3 file_matcher.py test_dir1 test_dir2 --json`
   - JSON structure unchanged (already file-centric)
</verification>

<success_criteria>
1. Compare mode output uses hierarchical format with [dir1]/[dir2] labels
2. Hash displayed as trailing detail, not header
3. Colors applied consistently (green for dir1, yellow for dir2, dim for hash)
4. All tests pass
5. Action mode output unchanged
6. JSON output unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/09-unify-default-and-action-output-for-groups/09-01-SUMMARY.md`
</output>
