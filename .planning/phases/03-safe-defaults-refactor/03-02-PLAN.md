---
phase: 03-safe-defaults-refactor
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - tests/test_dry_run.py
  - tests/test_safe_defaults.py
autonomous: true

must_haves:
  truths:
    - "All tests pass after refactor"
    - "Tests verify preview-by-default behavior"
    - "Tests verify --execute flag triggers execution path"
    - "Tests verify confirmation prompt behavior"
    - "Tests verify --yes flag skips confirmation"
  artifacts:
    - path: "tests/test_safe_defaults.py"
      provides: "Tests for safe default behavior"
      min_lines: 150
      contains: "TestPreviewMode"
  key_links:
    - from: "tests/test_safe_defaults.py"
      to: "file_matcher.py"
      via: "from file_matcher import"
      pattern: "from file_matcher import.*PREVIEW_BANNER"
---

<objective>
Update and expand unit tests for the safe defaults refactor, ensuring preview-by-default behavior and --execute flag are thoroughly tested.

Purpose: Maintain test coverage and verify safe defaults behavior works correctly
Output: Updated test_safe_defaults.py (renamed from test_dry_run.py) with comprehensive tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-safe-defaults-refactor/03-CONTEXT.md
@.planning/phases/03-safe-defaults-refactor/03-RESEARCH.md
@tests/test_dry_run.py
@file_matcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename test file and update imports</name>
  <files>tests/test_dry_run.py, tests/test_safe_defaults.py</files>
  <action>
    Rename `tests/test_dry_run.py` to `tests/test_safe_defaults.py`.

    Update imports at top of file:
    - Change: `from file_matcher import main, DRY_RUN_BANNER`
    - To: `from file_matcher import main, PREVIEW_BANNER, EXECUTE_BANNER, confirm_execution`

    Update `run_tests.py` if it explicitly lists test modules to include the renamed file.

    Rename test classes:
    - `TestDryRunValidation` -> `TestFlagValidation`
    - `TestDryRunBanner` -> `TestPreviewBanner`
    - `TestDryRunStatistics` -> `TestPreviewStatistics`
    - `TestDryRunActionLabels` -> `TestPreviewActionLabels`
    - `TestDryRunCrossFilesystem` -> `TestCrossFilesystemWarnings`
  </action>
  <verify>
    File exists: `tests/test_safe_defaults.py`
    File does NOT exist: `tests/test_dry_run.py`
    Run: `python -c "from tests.test_safe_defaults import *; print('Imports OK')"`
  </verify>
  <done>
    - tests/test_dry_run.py renamed to tests/test_safe_defaults.py
    - Imports updated for new function/constant names
    - Test classes renamed to reflect new semantics
  </done>
</task>

<task type="auto">
  <name>Task 2: Update existing tests for new flag semantics</name>
  <files>tests/test_safe_defaults.py</files>
  <action>
    Update `TestFlagValidation` class:

    1. `test_dry_run_requires_master` -> `test_dry_run_flag_removed`:
       - Test that `--dry-run` produces "unrecognized arguments" error
       - Keep exit code 2 assertion

    2. `test_dry_run_with_master_succeeds` -> `test_action_with_master_shows_preview`:
       - Change args from `--dry-run` to just `--action hardlink`
       - Assert "PREVIEW MODE" in output (not "DRY RUN")

    3. `test_action_choices_valid` -> keep name, update to not use `--dry-run`:
       - Args should be: `--master dir1 --action {action}` (no --dry-run)
       - Assert "PREVIEW MODE" in output

    4. ADD new test `test_execute_requires_master_and_action`:
       - Test `--execute` without `--master` errors
       - Test `--execute` without `--action` errors
       - Both should show "--execute requires --master and --action"

    Update `TestPreviewBanner` class:

    1. Update all tests to use `--action hardlink` instead of `--dry-run`
    2. Change assertions from "DRY RUN" to "PREVIEW MODE"
    3. Change `DRY_RUN_BANNER` references to `PREVIEW_BANNER`
    4. `test_banner_not_shown_without_dry_run` -> `test_banner_not_shown_without_action`:
       - When no `--action` specified, no PREVIEW banner

    Update `TestPreviewStatistics` class:

    1. Update all tests to use `--action hardlink` instead of `--dry-run`
    2. ADD assertion: "Use --execute to apply changes" in footer

    Update `TestPreviewActionLabels` class:

    1. Change `[DUP:hardlink]` assertions to `[WOULD HARDLINK]`
    2. Change `[DUP:symlink]` assertions to `[WOULD SYMLINK]`
    3. Change `[DUP:delete]` assertions to `[WOULD DELETE]`
    4. Change `[DUP:?]` assertion to expect no action label or different behavior (if no --action, no duplicate labels shown)
  </action>
  <verify>
    Run: `python -m tests.test_safe_defaults`
    All existing tests should pass with updated assertions.
  </verify>
  <done>
    - All 18 existing tests updated for new flag semantics
    - Tests use --action instead of --dry-run
    - Tests assert "PREVIEW MODE" instead of "DRY RUN"
    - Tests assert "[WOULD X]" instead of "[DUP:X]"
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for --execute flag and confirmation prompt</name>
  <files>tests/test_safe_defaults.py</files>
  <action>
    Add new test class `TestExecuteMode`:

    ```python
    class TestExecuteMode(BaseFileMatcherTest):
        """Tests for --execute flag behavior."""

        def run_main_with_args(self, args: list[str]) -> str:
            """Helper to run main() with given args and capture stdout."""
            f = io.StringIO()
            with redirect_stdout(f):
                main()
            return f.getvalue()

        def test_execute_shows_preview_then_banner(self):
            """--execute should show preview output then EXECUTING banner."""
            with patch('sys.argv', ['file_matcher.py', self.test_dir1, self.test_dir2,
                       '--master', self.test_dir1, '--action', 'hardlink', '--execute']):
                with patch('builtins.input', return_value='n'):
                    output = self.run_main_with_args([])
                    self.assertIn("PREVIEW MODE", output)
                    self.assertIn("EXECUTING", output)

        def test_execute_prompts_for_confirmation(self):
            """--execute should prompt user before proceeding."""
            with patch('sys.argv', ['file_matcher.py', self.test_dir1, self.test_dir2,
                       '--master', self.test_dir1, '--action', 'hardlink', '--execute']):
                with patch('builtins.input', return_value='n') as mock_input:
                    self.run_main_with_args([])
                    mock_input.assert_called_once()
                    # Verify prompt text
                    call_args = mock_input.call_args[0][0] if mock_input.call_args[0] else ""
                    self.assertIn("[y/N]", call_args)

        def test_execute_abort_shows_message(self):
            """Declining confirmation should show abort message."""
            with patch('sys.argv', ['file_matcher.py', self.test_dir1, self.test_dir2,
                       '--master', self.test_dir1, '--action', 'hardlink', '--execute']):
                with patch('builtins.input', return_value='n'):
                    output = self.run_main_with_args([])
                    self.assertIn("Aborted", output)
                    self.assertIn("No changes made", output)

        def test_execute_abort_exit_code_zero(self):
            """Aborting should exit with code 0 (not an error)."""
            with patch('sys.argv', ['file_matcher.py', self.test_dir1, self.test_dir2,
                       '--master', self.test_dir1, '--action', 'hardlink', '--execute']):
                with patch('builtins.input', return_value='n'):
                    f = io.StringIO()
                    with redirect_stdout(f):
                        result = main()
                    self.assertEqual(result, 0)

        def test_yes_flag_skips_confirmation(self):
            """--yes should skip the confirmation prompt entirely."""
            with patch('sys.argv', ['file_matcher.py', self.test_dir1, self.test_dir2,
                       '--master', self.test_dir1, '--action', 'hardlink', '--execute', '--yes']):
                with patch('builtins.input') as mock_input:
                    self.run_main_with_args([])
                    mock_input.assert_not_called()

        def test_confirmation_accepts_y(self):
            """User typing 'y' should proceed."""
            with patch('sys.argv', ['file_matcher.py', self.test_dir1, self.test_dir2,
                       '--master', self.test_dir1, '--action', 'hardlink', '--execute']):
                with patch('builtins.input', return_value='y'):
                    output = self.run_main_with_args([])
                    # Should NOT show abort message
                    self.assertNotIn("Aborted", output)

        def test_confirmation_accepts_yes(self):
            """User typing 'yes' should proceed."""
            with patch('sys.argv', ['file_matcher.py', self.test_dir1, self.test_dir2,
                       '--master', self.test_dir1, '--action', 'hardlink', '--execute']):
                with patch('builtins.input', return_value='yes'):
                    output = self.run_main_with_args([])
                    self.assertNotIn("Aborted", output)

        def test_confirmation_case_insensitive(self):
            """Confirmation should accept 'Y' and 'YES' (case insensitive)."""
            for response in ['Y', 'YES', 'Yes']:
                with patch('sys.argv', ['file_matcher.py', self.test_dir1, self.test_dir2,
                           '--master', self.test_dir1, '--action', 'hardlink', '--execute']):
                    with patch('builtins.input', return_value=response):
                        output = self.run_main_with_args([])
                        self.assertNotIn("Aborted", output)
    ```

    Add new test class `TestNonInteractiveMode`:

    ```python
    class TestNonInteractiveMode(BaseFileMatcherTest):
        """Tests for non-interactive (piped/scripted) mode."""

        def test_non_tty_defaults_to_abort(self):
            """Non-interactive mode should default to abort without --yes."""
            with patch('sys.argv', ['file_matcher.py', self.test_dir1, self.test_dir2,
                       '--master', self.test_dir1, '--action', 'hardlink', '--execute']):
                with patch('sys.stdin.isatty', return_value=False):
                    stderr_capture = io.StringIO()
                    stdout_capture = io.StringIO()
                    with redirect_stderr(stderr_capture):
                        with redirect_stdout(stdout_capture):
                            result = main()
                    # Should show message about non-interactive mode
                    self.assertIn("Non-interactive", stderr_capture.getvalue())
                    # Should return 0 (not an error)
                    self.assertEqual(result, 0)

        def test_non_tty_with_yes_proceeds(self):
            """Non-interactive mode with --yes should proceed without prompt."""
            with patch('sys.argv', ['file_matcher.py', self.test_dir1, self.test_dir2,
                       '--master', self.test_dir1, '--action', 'hardlink', '--execute', '--yes']):
                with patch('sys.stdin.isatty', return_value=False):
                    f = io.StringIO()
                    with redirect_stdout(f):
                        main()
                    output = f.getvalue()
                    # Should NOT show abort message
                    self.assertNotIn("Aborted", output)
    ```
  </action>
  <verify>
    Run: `python -m tests.test_safe_defaults`
    All tests should pass (existing updated + new tests).

    Run: `python3 run_tests.py`
    Full test suite should pass.
  </verify>
  <done>
    - TestExecuteMode class with 9 tests for --execute behavior
    - TestNonInteractiveMode class with 2 tests for piped/scripted usage
    - All tests pass
  </done>
</task>

</tasks>

<verification>
TEST-03 requirement complete:

1. All existing tests updated for new semantics
2. Tests verify preview-by-default behavior
3. Tests verify --execute triggers execution path
4. Tests verify confirmation prompt accepts y/yes (case-insensitive)
5. Tests verify --yes skips confirmation
6. Tests verify non-interactive mode defaults to abort

Run full test suite:
```bash
python3 run_tests.py
```

Expected: All tests pass (53 existing + 11 new = 64 tests)
</verification>

<success_criteria>
- [ ] tests/test_dry_run.py renamed to tests/test_safe_defaults.py
- [ ] Imports updated for new function/constant names
- [ ] 18 existing tests updated for new flag semantics
- [ ] TestExecuteMode class with 9 tests
- [ ] TestNonInteractiveMode class with 2 tests
- [ ] All tests pass
- [ ] run_tests.py discovers and runs new test file
</success_criteria>

<output>
After completion, create `.planning/phases/03-safe-defaults-refactor/03-02-SUMMARY.md`
</output>
