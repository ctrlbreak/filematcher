---
phase: 03-safe-defaults-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "User running --action without --execute sees PREVIEW MODE banner"
    - "User running --action with --execute sees EXECUTING banner then confirmation prompt"
    - "User typing 'n' at confirmation aborts with exit code 0"
    - "User using --dry-run gets argparse error"
    - "Duplicate labels show [WOULD HARDLINK] not [DUP:hardlink] in preview"
  artifacts:
    - path: "file_matcher.py"
      provides: "Preview-by-default CLI with --execute flag"
      contains: "PREVIEW_BANNER"
      exports: ["confirm_execution", "format_preview_banner"]
  key_links:
    - from: "argparse --execute flag"
      to: "confirm_execution()"
      via: "main() conditional"
      pattern: "if args\\.execute.*confirm"
    - from: "format_duplicate_group"
      to: "WOULD prefix"
      via: "action label formatting"
      pattern: "WOULD.*HARDLINK|SYMLINK|DELETE"
---

<objective>
Refactor the CLI so preview mode is the default when `--action` is specified, and actual file modifications require explicit `--execute` flag.

Purpose: Safety-first design - users see what WOULD happen before committing to changes
Output: Updated file_matcher.py with preview-by-default behavior
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-safe-defaults-refactor/03-CONTEXT.md
@.planning/phases/03-safe-defaults-refactor/03-RESEARCH.md
@file_matcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove --dry-run flag, add --execute and --yes flags</name>
  <files>file_matcher.py</files>
  <action>
    Remove the `--dry-run`/`-n` argparse argument entirely (not hidden, fully removed).

    Add new argparse arguments:
    - `--execute` (no short flag, intentionally verbose for safety): `action='store_true'`, help='Execute the action (without this flag, only preview)'
    - `--yes`/`-y`: `action='store_true'`, help='Skip confirmation prompt'

    Update validation logic:
    - REMOVE: `if args.dry_run and not args.master` check
    - ADD: `if args.execute and not (args.master and args.action): parser.error("--execute requires --master and --action")`

    The validation should use `parser.error()` for consistent exit code 2 behavior (existing pattern).
  </action>
  <verify>
    Run: `python file_matcher.py test_dir1 test_dir2 --execute` - should error with "--execute requires --master and --action"
    Run: `python file_matcher.py test_dir1 test_dir2 --dry-run` - should error with "unrecognized arguments: --dry-run"
    Run: `python file_matcher.py --help` - should show --execute and --yes, NOT --dry-run
  </verify>
  <done>
    - --dry-run flag no longer exists in argparse
    - --execute flag added without short flag
    - --yes/-y flag added
    - Validation: --execute requires both --master and --action
  </done>
</task>

<task type="auto">
  <name>Task 2: Update banners and action labels for preview mode</name>
  <files>file_matcher.py</files>
  <action>
    Update banner constants and functions:
    - Rename `DRY_RUN_BANNER` to `PREVIEW_BANNER` with value: `"=== PREVIEW MODE - Use --execute to apply changes ==="`
    - Add `EXECUTE_BANNER` constant with value: `"=== EXECUTING ==="`
    - Rename `format_dry_run_banner()` to `format_preview_banner()` returning PREVIEW_BANNER
    - Add `format_execute_banner()` returning EXECUTE_BANNER

    Update `format_duplicate_group()` function:
    - Add a new parameter `preview_mode: bool = True`
    - When `preview_mode=True` and action is set, use "WOULD X" labels:
      - "hardlink" -> "[WOULD HARDLINK]"
      - "symlink" -> "[WOULD SYMLINK]"
      - "delete" -> "[WOULD DELETE]"
    - When `preview_mode=False` (execute mode), keep current "[DUP:action]" format for progress

    Update `format_statistics_footer()`:
    - Add parameter `preview_mode: bool = True`
    - Add line at end when `preview_mode=True`: "Use --execute to apply changes"
    - When `preview_mode=False`, omit this line
  </action>
  <verify>
    Python REPL test:
    ```python
    from file_matcher import format_preview_banner, format_execute_banner, PREVIEW_BANNER
    print(format_preview_banner())  # Should show "=== PREVIEW MODE - Use --execute to apply changes ==="
    print(format_execute_banner())  # Should show "=== EXECUTING ==="
    ```
  </verify>
  <done>
    - PREVIEW_BANNER and EXECUTE_BANNER constants defined
    - format_preview_banner() and format_execute_banner() functions exist
    - format_duplicate_group() uses "WOULD X" labels when preview_mode=True
    - format_statistics_footer() includes "--execute" hint when preview_mode=True
  </done>
</task>

<task type="auto">
  <name>Task 3: Add confirmation prompt and wire main() for preview-default</name>
  <files>file_matcher.py</files>
  <action>
    Add `confirm_execution()` function near top of file (after imports):
    ```python
    def confirm_execution(skip_confirm: bool = False) -> bool:
        """
        Prompt user for Y/N confirmation before executing changes.

        Args:
            skip_confirm: If True, skip prompt and return True (for --yes flag)

        Returns:
            True if user confirms, False otherwise
        """
        if skip_confirm:
            return True
        if not sys.stdin.isatty():
            print("Non-interactive mode detected. Use --yes to skip confirmation.", file=sys.stderr)
            return False
        response = input("Proceed? [y/N] ").strip().lower()
        return response in ('y', 'yes')
    ```

    Update `main()` function to implement preview-by-default:

    1. Replace `if args.dry_run:` condition with `if args.action and args.master:` (preview mode when action specified)

    2. In preview mode (action + master, no execute):
       - Print `format_preview_banner()`
       - Use `preview_mode=True` in format_duplicate_group() calls
       - Use `preview_mode=True` in format_statistics_footer() calls

    3. In execute mode (action + master + execute):
       - First show preview output with PREVIEW banner (so user sees what will happen)
       - Print `format_execute_banner()`
       - Call `confirm_execution(skip_confirm=args.yes)`
       - If False: print "Aborted. No changes made." and return 0
       - If True: (placeholder for Phase 4 - just print "Execution not yet implemented." for now)

    4. When neither action nor execute specified (original behavior):
       - Keep existing output format unchanged

    Note: For now, the actual execution logic is a placeholder - Phase 4 will implement file modifications.
  </action>
  <verify>
    Run: `python file_matcher.py test_dir1 test_dir2 --master test_dir1 --action hardlink`
    - Should show "PREVIEW MODE" banner
    - Should show "[WOULD HARDLINK]" labels
    - Should show "Use --execute to apply changes" in footer
    - NO files modified

    Run: `echo 'n' | python file_matcher.py test_dir1 test_dir2 --master test_dir1 --action hardlink --execute`
    - Should show preview, then "Aborted. No changes made."
    - Exit code 0

    Run: `python file_matcher.py test_dir1 test_dir2 --master test_dir1 --action hardlink --execute --yes`
    - Should show "Execution not yet implemented." (placeholder)
  </verify>
  <done>
    - confirm_execution() function handles Y/N prompt with TTY detection
    - Preview mode is default when --action is specified (no --execute)
    - Execute mode shows preview then prompts for confirmation
    - User abort returns exit code 0
    - --yes flag skips confirmation
  </done>
</task>

</tasks>

<verification>
All Phase 3 implementation requirements met:

1. SAFE-01: `filematcher dir1 dir2 --master dir1 --action hardlink` shows preview (no --dry-run needed)
2. SAFE-02: `--execute` flag triggers execution path (with placeholder for Phase 4)
3. SAFE-03: `--dry-run` flag produces "unrecognized arguments" error
4. SAFE-04: Banner shows "Use --execute to apply changes"

Run full test suite to ensure no regressions:
```bash
python3 run_tests.py
```

Note: Existing dry-run tests will FAIL after this plan - that's expected. Plan 03-02 updates the tests.
</verification>

<success_criteria>
- [ ] --dry-run flag removed from CLI
- [ ] --execute flag added (no short flag)
- [ ] --yes/-y flag added
- [ ] --execute requires --master and --action (validation)
- [ ] Preview mode is default when --action specified
- [ ] Banner shows "PREVIEW MODE - Use --execute to apply changes"
- [ ] Action labels show "[WOULD X]" in preview mode
- [ ] Statistics footer shows "--execute" hint
- [ ] confirm_execution() prompts with Y/N
- [ ] User abort exits with code 0
</success_criteria>

<output>
After completion, create `.planning/phases/03-safe-defaults-refactor/03-01-SUMMARY.md`
</output>
