---
phase: 01-master-directory-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - tests/test_master_directory.py
autonomous: true

must_haves:
  truths:
    - "Unit tests verify --master flag is accepted"
    - "Unit tests verify invalid master paths are rejected"
    - "Unit tests verify master-aware output formatting"
    - "Unit tests verify timestamp-based master selection"
    - "All tests pass when run with python3 run_tests.py"
  artifacts:
    - path: "tests/test_master_directory.py"
      provides: "Unit tests for master directory validation"
      min_lines: 80
      contains: "class TestMasterDirectory"
  key_links:
    - from: "tests/test_master_directory.py"
      to: "file_matcher.py"
      via: "imports validate_master_directory, main"
      pattern: "from file_matcher import"
    - from: "run_tests.py"
      to: "tests/test_master_directory.py"
      via: "test discovery"
      pattern: "test_master_directory"
---

<objective>
Create unit tests for master directory validation and output formatting (TEST-01).

Purpose: Ensures the master directory feature works correctly and catches regressions. Tests validate path resolution, error handling, and output formatting.

Output: New test file `tests/test_master_directory.py` with comprehensive tests for Phase 1 requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-master-directory-foundation/01-CONTEXT.md
@.planning/phases/01-master-directory-foundation/01-01-SUMMARY.md
@tests/test_base.py
@tests/test_cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_master_directory.py with validation tests</name>
  <files>tests/test_master_directory.py</files>
  <action>
Create `tests/test_master_directory.py` following existing test patterns:

1. Import structure (match test_cli.py pattern):
```python
#!/usr/bin/env python3

from __future__ import annotations

import io
import os
import unittest
from contextlib import redirect_stdout, redirect_stderr
from pathlib import Path
from unittest.mock import patch

from file_matcher import main, validate_master_directory
from tests.test_base import BaseFileMatcherTest
```

2. Create `TestMasterDirectoryValidation` class:
   - `test_valid_master_dir1`: --master with first directory passes
   - `test_valid_master_dir2`: --master with second directory passes
   - `test_valid_master_relative_path`: --master with `./dir` resolves correctly
   - `test_valid_master_parent_path`: --master with `../parent/dir` resolves correctly
   - `test_invalid_master_nonexistent`: --master with non-existent path exits code 2
   - `test_invalid_master_wrong_directory`: --master with unrelated directory exits code 2
   - `test_invalid_master_error_message`: error message contains expected text
   - `test_no_master_flag`: tool works without --master (backward compatibility)

3. For validation tests, use pattern from test_cli.py:
```python
def test_invalid_master_exits_code_2(self):
    with patch('sys.argv', ['file_matcher.py', self.test_dir1, self.test_dir2, '--master', '/tmp']):
        with self.assertRaises(SystemExit) as cm:
            main()
        self.assertEqual(cm.exception.code, 2)
```

4. Create `TestMasterDirectoryOutput` class:
   - `test_master_output_arrow_notation`: output contains `->` when --master set
   - `test_master_output_master_first`: master file appears before arrow
   - `test_no_master_preserves_old_format`: without --master, output has "Hash:" format
   - `test_master_summary_shows_counts`: --summary shows "master files" and "duplicates" counts
   - `test_master_verbose_shows_reasoning`: --verbose shows "Selected master:" text
  </action>
  <verify>
```bash
cd /Users/patrick/dev/cursor_projects/filematcher

# Run just the new test module
python3 -m tests.test_master_directory

# Run all tests to ensure no regressions
python3 run_tests.py
```
  </verify>
  <done>
`tests/test_master_directory.py` exists with `TestMasterDirectoryValidation` and `TestMasterDirectoryOutput` classes. All tests pass. No regressions in existing tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add timestamp-based master selection tests</name>
  <files>tests/test_master_directory.py</files>
  <action>
Add tests for timestamp-based master selection (duplicates within master directory):

1. Add `TestMasterDirectoryTimestamp` class:

2. Create test fixtures with controlled timestamps:
```python
def setUp(self):
    super().setUp()
    # Create duplicate files within master directory with different timestamps
    self.dup_in_master1 = os.path.join(self.test_dir1, "dup_a.txt")
    self.dup_in_master2 = os.path.join(self.test_dir1, "dup_b.txt")

    # Write same content to both
    content = "Duplicate content in master\n"
    with open(self.dup_in_master1, "w") as f:
        f.write(content)
    with open(self.dup_in_master2, "w") as f:
        f.write(content)

    # Set timestamps: dup_a is older, should be master
    import time
    old_time = time.time() - 3600  # 1 hour ago
    os.utime(self.dup_in_master1, (old_time, old_time))
```

3. Tests to add:
   - `test_oldest_file_becomes_master`: verify oldest file in master dir is selected
   - `test_timestamp_selection_in_verbose`: verbose output explains timestamp selection
   - `test_warning_multiple_masters`: warning printed when multiple files in master have same content

4. Also add test for cross-directory case:
   - `test_master_dir_file_preferred`: file in master dir chosen over older file in non-master dir
  </action>
  <verify>
```bash
cd /Users/patrick/dev/cursor_projects/filematcher

# Run the new test class specifically
python3 -m unittest tests.test_master_directory.TestMasterDirectoryTimestamp

# Run all tests
python3 run_tests.py
```
  </verify>
  <done>
`TestMasterDirectoryTimestamp` class exists with tests for timestamp-based master selection. Tests verify oldest file selected, verbose output explains selection, and warnings appear for duplicates within master directory.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Run full test suite:
```bash
python3 run_tests.py
```
All tests should pass including new master directory tests.

2. Run new tests in isolation:
```bash
python3 -m tests.test_master_directory -v
```
Should show all test methods running and passing.

3. Verify test coverage of requirements:
- MSTR-01 (`--master` flag): Covered by `TestMasterDirectoryValidation`
- MSTR-03 (validation): Covered by invalid master tests
- TEST-01 (unit tests): This entire plan fulfills it
- Timestamp selection: Covered by `TestMasterDirectoryTimestamp`
</verification>

<success_criteria>
- TEST-01: Unit tests for master directory validation exist and pass
- Test file follows existing patterns (BaseFileMatcherTest, patch sys.argv)
- Tests cover: valid master, invalid master, error messages, output formatting
- Tests cover: timestamp-based selection, warnings for duplicates in master
- All existing tests continue to pass (no regressions)
- `python3 run_tests.py` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/01-master-directory-foundation/01-02-SUMMARY.md`
</output>
