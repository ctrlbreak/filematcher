---
phase: 10-unify-compare-as-action
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "Compare mode flows through ActionFormatter code path"
    - "All compare mode output identical to previous behavior"
    - "JSON compare mode output maintains schema compatibility"
    - "No references to CompareFormatter from main()"
  artifacts:
    - path: "file_matcher.py"
      provides: "Unified main() function using action path for all modes"
      contains: "action_formatter = TextActionFormatter"
  key_links:
    - from: "main() compare handling"
      to: "ActionFormatter"
      via: "formatter instantiation"
      pattern: "action_formatter.*ActionFormatter"
---

<objective>
Unify main() to use the action code path for all modes, including compare.

Purpose: Remove the `if master_path:` branching and make compare mode flow through the same ActionFormatter code path as hardlink/symlink/delete actions.
Output: Single code path in main() handling all action types including compare.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-unify-compare-as-action/10-CONTEXT.md
@.planning/phases/10-unify-compare-as-action/10-RESEARCH.md
@.planning/phases/10-unify-compare-as-action/10-01-SUMMARY.md
@.planning/phases/10-unify-compare-as-action/10-02-SUMMARY.md
@file_matcher.py (lines 2268-2680 - master_path branching and main() code paths)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Always set master_path for unified action flow</name>
  <files>file_matcher.py</files>
  <action>
Modify the master_path assignment (around lines 2268-2271):

Current:
```python
# Set master to first directory when --action is used
master_path = None
if args.action:
    master_path = Path(args.dir1).resolve()
```

Since args.action now always has a value (default='compare'), this check becomes:
```python
# Set master to first directory - always set now (all modes are "action" modes)
# For compare action, master_path is used for display purposes only (no modifications)
master_path = Path(args.dir1).resolve()
```

The condition `if args.action:` is now always True since compare is the default, but keep master_path always set for the unified flow.

**Important:** After this change, the `if master_path:` block (line ~2312) will ALWAYS execute, so the `else:` block (lines 2601-2674) becomes dead code. This is intentional - Plan 04 will delete that code.
  </action>
  <verify>Run: `python file_matcher.py test_dir1 test_dir2` - should still work (now flows through action path)</verify>
  <done>master_path always set; compare mode enters action code path</done>
</task>

<task type="auto">
  <name>Task 2: Update formatter instantiation to pass action</name>
  <files>file_matcher.py</files>
  <action>
Update the formatter instantiation (around lines 2344-2356) to pass the action parameter:

Current:
```python
# Create formatter for action mode (always in preview mode for print_preview_output)
if args.json:
    action_formatter = JsonActionFormatter(
        verbose=args.verbose,
        preview_mode=not args.execute
    )
    action_formatter.set_directories(args.dir1, args.dir2)
else:
    action_formatter = TextActionFormatter(
        verbose=args.verbose,
        preview_mode=True,
        color_config=color_config
    )
```

Update to:
```python
# Create formatter for action mode (handles all actions including compare)
if args.json:
    action_formatter = JsonActionFormatter(
        verbose=args.verbose,
        preview_mode=not args.execute,
        action=args.action
    )
    action_formatter.set_directories(args.dir1, args.dir2)
else:
    action_formatter = TextActionFormatter(
        verbose=args.verbose,
        preview_mode=True,
        color_config=color_config,
        action=args.action
    )
```

This passes the action type to formatters so they can handle compare-specific formatting.
  </action>
  <verify>Run: `python file_matcher.py test_dir1 test_dir2 --action compare` - should show correct output</verify>
  <done>Formatters receive action parameter for compare-specific handling</done>
</task>

<task type="auto">
  <name>Task 3: Handle compare action in action mode flow</name>
  <files>file_matcher.py</files>
  <action>
Update the action mode flow (lines ~2340-2599) to handle compare action appropriately:

1. **Preview/execute mode determination** (around lines 2340-2342):
Current:
```python
preview_mode = args.action and not args.execute
execute_mode = args.action and args.execute
```

For compare action, there is no execute mode (validation prevents --execute with compare). Update to:
```python
# For compare action, always preview mode (no execute possible)
preview_mode = not args.execute  # True for compare (can't have --execute)
execute_mode = args.action != 'compare' and args.execute
```

Or simpler - the existing validation (Plan 01) prevents --execute with compare, so this code remains correct. `preview_mode` will be True for compare (since execute is False).

2. **Banner display in print_preview_output** (around line 2367-2368):
The `show_banner=True` parameter is passed, but TextActionFormatter.format_banner() now returns early for compare action (from Plan 02), so no change needed here.

3. **Verify the flow works for compare:**
- Compare action: preview_mode=True, execute_mode=False
- Goes through print_preview_output() which calls formatter methods
- formatter.format_banner() returns early for compare
- formatter.format_unified_header() shows "Compare mode:"
- Rest of output formatting works via existing ActionFormatter methods

Run tests to verify no issues with the unified flow.
  </action>
  <verify>Run: `python3 run_tests.py` - all tests should pass</verify>
  <done>Compare action flows through action mode path correctly; all tests pass</done>
</task>

</tasks>

<verification>
1. `python file_matcher.py test_dir1 test_dir2` produces same output as before
2. `python file_matcher.py test_dir1 test_dir2 --action compare` works identically
3. `python file_matcher.py test_dir1 test_dir2 --action hardlink` still works
4. `python file_matcher.py test_dir1 test_dir2 --json` produces valid JSON
5. `python3 run_tests.py` passes all 198 tests
</verification>

<success_criteria>
- Compare mode flows through ActionFormatter code path
- Output identical to previous CompareFormatter output
- All action modes (compare, hardlink, symlink, delete) work correctly
- All 198 existing tests pass without modification
- The else branch (lines 2601-2674) is now dead code (to be removed in Plan 04)
</success_criteria>

<output>
After completion, create `.planning/phases/10-unify-compare-as-action/10-03-SUMMARY.md`
</output>
