---
phase: 10-unify-compare-as-action
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "--action compare is accepted by argparse"
    - "Default mode (no --action) uses compare action internally"
    - "--execute with compare action produces error"
    - "--yes with compare action is silently ignored"
  artifacts:
    - path: "file_matcher.py"
      provides: "Updated argparse with compare action choice and validation"
      contains: "choices=['compare', 'hardlink', 'symlink', 'delete']"
  key_links:
    - from: "argparse.add_argument('--action')"
      to: "default='compare'"
      via: "default argument value"
      pattern: "default='compare'"
---

<objective>
Add "compare" as a valid action choice and set it as the default, with validation preventing --execute usage.

Purpose: Enable the CLI to accept `--action compare` explicitly while maintaining backward compatibility for users who run without any --action flag.
Output: Updated argparse configuration with compare as default action and validation for incompatible flag combinations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-unify-compare-as-action/10-CONTEXT.md
@.planning/phases/10-unify-compare-as-action/10-RESEARCH.md
@file_matcher.py (lines 2213-2270 - argparse setup and validation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add compare to action choices with default</name>
  <files>file_matcher.py</files>
  <action>
Modify the --action argument definition (around line 2225):

Current:
```python
parser.add_argument('--action', '-a', choices=['hardlink', 'symlink', 'delete'],
                    help='Action to take on duplicates (first directory is master, never modified)')
```

Change to:
```python
parser.add_argument('--action', '-a', choices=['compare', 'hardlink', 'symlink', 'delete'],
                    default='compare',
                    help='Action: compare (default, no changes), hardlink, symlink, or delete')
```

This makes "compare" the default action when no --action flag is provided, maintaining backward compatibility while enabling explicit `--action compare` for scripting clarity.
  </action>
  <verify>Run: `python file_matcher.py --help | grep -A2 '\-\-action'` - should show compare in choices and indicate default</verify>
  <done>--action argument accepts compare, hardlink, symlink, delete with compare as default</done>
</task>

<task type="auto">
  <name>Task 2: Update validation for compare action</name>
  <files>file_matcher.py</files>
  <action>
Update the validation block (around lines 2256-2266) to handle compare action:

1. Remove the existing "--execute requires --action" validation (line ~2257-2258) since action now always has a value (default='compare').

2. Add new validation for compare action with --execute:
```python
# Validate --execute not allowed with compare action (compare doesn't modify files)
if args.execute and args.action == 'compare':
    parser.error("compare action doesn't modify files - remove --execute flag")
```

Add this BEFORE the "--log requires --execute" validation.

3. The --yes flag with compare action needs no special handling - it's silently ignored since compare mode has no confirmation prompt. No code changes needed for this.

4. Update the "--fallback-symlink only applies to hardlink" validation is already correct.
  </action>
  <verify>Run: `python file_matcher.py test_dir1 test_dir2 --action compare --execute 2>&1 | grep -i error` - should show error about compare not modifying files</verify>
  <done>--execute with compare action produces clear error message; other validations still work</done>
</task>

<task type="auto">
  <name>Task 3: Verify backward compatibility</name>
  <files>file_matcher.py</files>
  <action>
No code changes needed - this task verifies the changes work correctly.

Test scenarios to verify:
1. `python file_matcher.py test_dir1 test_dir2` - should work as before (compare mode)
2. `python file_matcher.py test_dir1 test_dir2 --action compare` - should work identically
3. `python file_matcher.py test_dir1 test_dir2 --action hardlink` - should work as before
4. `python file_matcher.py test_dir1 test_dir2 --action compare --execute` - should error
5. `python file_matcher.py test_dir1 test_dir2 --action compare --yes` - should work (--yes ignored)

Run full test suite to verify no regressions.
  </action>
  <verify>Run: `python3 run_tests.py` - all 198 tests should pass</verify>
  <done>All existing tests pass; CLI accepts --action compare; backward compatibility confirmed</done>
</task>

</tasks>

<verification>
1. `python file_matcher.py --help` shows compare in action choices with default indication
2. `python file_matcher.py test_dir1 test_dir2` works (backward compatible)
3. `python file_matcher.py test_dir1 test_dir2 --action compare` works
4. `python file_matcher.py test_dir1 test_dir2 --action compare --execute 2>&1 | grep -i error` shows error
5. `python3 run_tests.py` passes all tests
</verification>

<success_criteria>
- argparse accepts compare|hardlink|symlink|delete with compare as default
- --execute with compare action produces clear error message
- All 198 existing tests pass without modification
- Default mode (no flags) behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/10-unify-compare-as-action/10-01-SUMMARY.md`
</output>
