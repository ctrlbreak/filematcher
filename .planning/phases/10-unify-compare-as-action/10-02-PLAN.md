---
phase: 10-unify-compare-as-action
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "Compare mode output shows no PREVIEW/EXECUTING banner"
    - "Compare mode header shows 'Compare mode:' not 'Action mode:'"
    - "Compare mode statistics show hint about --action for space calculations"
    - "JSON compare mode output includes hashAlgorithm, matches, and summary fields"
  artifacts:
    - path: "file_matcher.py"
      provides: "ActionFormatter classes updated to handle compare action"
      contains: "if self._action == 'compare'"
  key_links:
    - from: "TextActionFormatter.format_banner"
      to: "compare action check"
      via: "early return for compare"
      pattern: "action.*compare.*return"
    - from: "TextActionFormatter.format_unified_header"
      to: "compare header format"
      via: "conditional formatting"
      pattern: "Compare mode:"
---

<objective>
Extend ActionFormatter classes to handle the compare action case, producing output compatible with current CompareFormatter output.

Purpose: Make ActionFormatter the single formatter hierarchy by teaching it to handle compare mode, including appropriate header format and statistics messaging.
Output: TextActionFormatter and JsonActionFormatter updated to handle compare action with correct output format.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-unify-compare-as-action/10-CONTEXT.md
@.planning/phases/10-unify-compare-as-action/10-RESEARCH.md
@.planning/phases/10-unify-compare-as-action/10-01-SUMMARY.md
@file_matcher.py (lines 325-467 - ActionFormatter ABC, lines 797-1000 - JsonActionFormatter, lines 1007-1250 - TextActionFormatter)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TextActionFormatter for compare action</name>
  <files>file_matcher.py</files>
  <action>
Modify TextActionFormatter methods to handle compare action:

1. **Add _action attribute to store action type.** Update __init__ to accept an optional `action` parameter with consistent signature order (action after preview_mode):
```python
def __init__(self, verbose: bool = False, preview_mode: bool = True,
             action: str | None = None, color_config: ColorConfig | None = None):
    super().__init__(verbose, preview_mode, action)
    self.cc = color_config
```

2. **Update format_banner()** to skip banner for compare action:
```python
def format_banner(self) -> None:
    """Format and output the mode banner (PREVIEW or EXECUTE)."""
    if self._action == "compare":
        return  # Compare mode doesn't show PREVIEW/EXECUTING banner
    if self.preview_mode:
        print(bold_yellow(format_preview_banner(), self.cc))
    else:
        print(format_execute_banner())
    print()
```

3. **Update format_unified_header()** to show "Compare mode:" for compare action:
```python
def format_unified_header(self, action: str, dir1: str, dir2: str) -> None:
    """Format and output the unified mode header with directories."""
    if action == "compare":
        # Compare mode: no (PREVIEW)/(EXECUTING) state indicator
        header = f"Compare mode: {dir1} vs {dir2}"
    else:
        state = "PREVIEW" if self.preview_mode else "EXECUTING"
        header = f"Action mode ({state}): {action} {dir1} vs {dir2}"
    print(cyan(header, self.cc))
```

4. **Update format_statistics()** to handle compare action messaging:
The current implementation already has logic for showing "(run with --action to calculate)" message when space_savings is 0. Ensure this works for compare action by checking:
```python
if action == "compare":
    hint = " (run with --action to calculate)"
else:
    hint = ""
```
(Check existing code - may already be correct based on space_savings == 0 check)
  </action>
  <verify>Run manual test: `python file_matcher.py test_dir1 test_dir2 --action compare` should show "Compare mode:" header without PREVIEW banner</verify>
  <done>TextActionFormatter correctly handles compare action with appropriate header and no banner</done>
</task>

<task type="auto">
  <name>Task 2: Update JsonActionFormatter for compare action</name>
  <files>file_matcher.py</files>
  <action>
Modify JsonActionFormatter to produce backward-compatible JSON for compare action.

**Step 1: Document current JsonCompareFormatter schema fields (from lines 645-656):**
- timestamp: ISO timestamp
- directories: {dir1, dir2} absolute paths
- hashAlgorithm: "md5" or "sha256"
- matches: array of {hash, filesDir1, filesDir2}
- unmatchedDir1, unmatchedDir2: arrays
- summary: {matchCount, matchedFilesDir1, matchedFilesDir2, unmatchedFilesDir1, unmatchedFilesDir2}

**Step 2: Update __init__ with consistent signature order (action after preview_mode):**
```python
def __init__(self, verbose: bool = False, preview_mode: bool = True, action: str | None = None):
    super().__init__(verbose, preview_mode, action)
    # ... rest of initialization
```

**Step 3: Update finalize() to produce compare-compatible output when action is "compare":**

Add special-case at start of finalize():
```python
def finalize(self) -> None:
    if self._action == "compare":
        # Produce JsonCompareFormatter-compatible schema
        compare_data = {
            "timestamp": self._data["timestamp"],
            "directories": self._data["directories"],
            "hashAlgorithm": self._hash_algorithm,  # Need to store this
            "matches": self._data.get("duplicateGroups", []),  # Rename field
            "unmatchedDir1": [],  # Compare mode doesn't track these in action path
            "unmatchedDir2": [],
            "summary": self._convert_statistics_to_summary()
        }
        print(json.dumps(compare_data, indent=2))
        return
    # ... rest of existing finalize() for action modes
```

**Step 4: Add _hash_algorithm storage.** Store hash algorithm when format_unified_header() is called (or add parameter to __init__).

**Step 5: Add _convert_statistics_to_summary() helper:**
```python
def _convert_statistics_to_summary(self) -> dict:
    """Convert action-mode statistics to compare-mode summary format."""
    stats = self._data.get("statistics", {})
    return {
        "matchCount": stats.get("duplicateGroups", 0),
        "matchedFilesDir1": stats.get("totalFilesWithMatches", 0),
        "matchedFilesDir2": stats.get("totalFilesWithMatches", 0),
        "unmatchedFilesDir1": 0,
        "unmatchedFilesDir2": 0
    }
```
  </action>
  <verify>
Run verification commands:
1. `python file_matcher.py test_dir1 test_dir2 --json | python -m json.tool` - valid JSON
2. `python file_matcher.py test_dir1 test_dir2 --json | python3 -c "import sys,json; d=json.load(sys.stdin); assert 'hashAlgorithm' in d; assert 'matches' in d; assert 'summary' in d; print('Schema OK')"` - verify required fields
  </verify>
  <done>JsonActionFormatter produces compare-compatible JSON with hashAlgorithm, matches, and summary fields</done>
</task>

<task type="auto">
  <name>Task 3: Update ActionFormatter ABC for action parameter</name>
  <files>file_matcher.py</files>
  <action>
Update the ActionFormatter ABC (lines ~325-467) to add action parameter with standardized signature order.

**Standardized __init__ signature for ActionFormatter hierarchy:**
```python
__init__(self, verbose: bool = False, preview_mode: bool = True, action: str | None = None)
```

Parameter order rationale:
- `verbose` - common across all formatters
- `preview_mode` - action-specific (preview vs execute)
- `action` - action type (compare, hardlink, symlink, delete)
- Subclass-specific params (like color_config) come AFTER base params

Update ActionFormatter ABC __init__:
```python
def __init__(self, verbose: bool = False, preview_mode: bool = True, action: str | None = None):
    """Initialize the formatter with configuration.

    Args:
        verbose: If True, show additional details in output
        preview_mode: If True, format for preview; if False, format for execution
        action: Action type (compare, hardlink, symlink, delete) for action-specific formatting
    """
    self.verbose = verbose
    self.preview_mode = preview_mode
    self._action = action
```

This ensures Task 1 (TextActionFormatter) and Task 2 (JsonActionFormatter) both inherit the action parameter consistently.
  </action>
  <verify>Run: `python3 run_tests.py` - all tests should pass</verify>
  <done>ActionFormatter ABC updated with standardized __init__(verbose, preview_mode, action) signature</done>
</task>

</tasks>

<verification>
1. `python file_matcher.py test_dir1 test_dir2 --action compare` shows "Compare mode:" header
2. `python file_matcher.py test_dir1 test_dir2 --action compare` does NOT show PREVIEW banner
3. `python file_matcher.py test_dir1 test_dir2 --action compare --json` produces valid JSON
4. `python file_matcher.py test_dir1 test_dir2 --action hardlink` still works with banner
5. `python3 run_tests.py` passes all tests
</verification>

<success_criteria>
- TextActionFormatter produces "Compare mode:" header for compare action
- TextActionFormatter skips PREVIEW/EXECUTING banner for compare action
- JsonActionFormatter produces valid JSON for compare action
- All existing tests pass without modification
- Action mode output unchanged for hardlink/symlink/delete
</success_criteria>

<output>
After completion, create `.planning/phases/10-unify-compare-as-action/10-02-SUMMARY.md`
</output>
