---
phase: 10-unify-compare-as-action
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "ActionFormatter handles compare action without banner"
    - "Compare mode header shows 'Compare mode:' not 'Action mode:'"
    - "Compare mode statistics show hint about --action for space calculations"
    - "ActionFormatter JSON output maintains backward-compatible schema for compare"
  artifacts:
    - path: "file_matcher.py"
      provides: "ActionFormatter classes updated to handle compare action"
      contains: "if self._action == 'compare'"
  key_links:
    - from: "TextActionFormatter.format_banner"
      to: "compare action check"
      via: "early return for compare"
      pattern: "action.*compare.*return"
    - from: "TextActionFormatter.format_unified_header"
      to: "compare header format"
      via: "conditional formatting"
      pattern: "Compare mode:"
---

<objective>
Extend ActionFormatter classes to handle the compare action case, producing output compatible with current CompareFormatter output.

Purpose: Make ActionFormatter the single formatter hierarchy by teaching it to handle compare mode, including appropriate header format and statistics messaging.
Output: TextActionFormatter and JsonActionFormatter updated to handle compare action with correct output format.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-unify-compare-as-action/10-CONTEXT.md
@.planning/phases/10-unify-compare-as-action/10-RESEARCH.md
@.planning/phases/10-unify-compare-as-action/10-01-SUMMARY.md
@file_matcher.py (lines 325-467 - ActionFormatter ABC, lines 797-1000 - JsonActionFormatter, lines 1007-1250 - TextActionFormatter)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TextActionFormatter for compare action</name>
  <files>file_matcher.py</files>
  <action>
Modify TextActionFormatter methods to handle compare action:

1. **Add _action attribute to store action type.** Update __init__ to accept an optional `action` parameter:
```python
def __init__(self, verbose: bool = False, preview_mode: bool = True,
             color_config: ColorConfig | None = None, action: str | None = None):
    super().__init__(verbose, preview_mode)
    self.cc = color_config
    self._action = action
```

2. **Update format_banner()** to skip banner for compare action:
```python
def format_banner(self) -> None:
    """Format and output the mode banner (PREVIEW or EXECUTE)."""
    if self._action == "compare":
        return  # Compare mode doesn't show PREVIEW/EXECUTING banner
    if self.preview_mode:
        print(bold_yellow(format_preview_banner(), self.cc))
    else:
        print(format_execute_banner())
    print()
```

3. **Update format_unified_header()** to show "Compare mode:" for compare action:
```python
def format_unified_header(self, action: str, dir1: str, dir2: str) -> None:
    """Format and output the unified mode header with directories."""
    if action == "compare":
        # Compare mode: no (PREVIEW)/(EXECUTING) state indicator
        header = f"Compare mode: {dir1} vs {dir2}"
    else:
        state = "PREVIEW" if self.preview_mode else "EXECUTING"
        header = f"Action mode ({state}): {action} {dir1} vs {dir2}"
    print(cyan(header, self.cc))
```

4. **Update format_statistics()** to handle compare action messaging:
The current implementation already has logic for showing "(run with --action to calculate)" message when space_savings is 0. Ensure this works for compare action by checking:
```python
if action == "compare":
    hint = " (run with --action to calculate)"
else:
    hint = ""
```
(Check existing code - may already be correct based on space_savings == 0 check)
  </action>
  <verify>Run manual test: `python file_matcher.py test_dir1 test_dir2 --action compare` should show "Compare mode:" header without PREVIEW banner</verify>
  <done>TextActionFormatter correctly handles compare action with appropriate header and no banner</done>
</task>

<task type="auto">
  <name>Task 2: Update JsonActionFormatter for compare action</name>
  <files>file_matcher.py</files>
  <action>
Modify JsonActionFormatter to produce backward-compatible JSON for compare action:

1. **Add _action attribute to store action type.** Update __init__:
```python
def __init__(self, verbose: bool = False, preview_mode: bool = True, action: str | None = None):
    super().__init__(verbose, preview_mode)
    self._action = action
    # ... rest of initialization
```

2. **Update finalize() to produce compare-compatible JSON schema when action is compare.**

Current JsonCompareFormatter produces:
```json
{
  "timestamp": "...",
  "directories": {"dir1": "...", "dir2": "..."},
  "hashAlgorithm": "md5",
  "matches": [...],
  "summary": {...}
}
```

JsonActionFormatter currently produces:
```json
{
  "timestamp": "...",
  "mode": "preview|execute",
  "action": "hardlink|symlink|delete",
  "directories": {...},
  "warnings": [...],
  "duplicateGroups": [...],
  "statistics": {...}
}
```

For backward compatibility, when action is "compare", produce the CompareFormatter schema:
- Use "matches" instead of "duplicateGroups"
- Include "hashAlgorithm" field
- Use "summary" instead of "statistics"
- Omit "mode" and "action" fields (or set action to "none")

This may require special-casing in finalize() or adding a translation layer.

**Alternative approach (simpler):** Keep the ActionFormatter schema for compare action, but add the missing fields (hashAlgorithm) and adjust field naming. Review test_json_output.py to see which fields are actually tested for compare mode.

After reviewing tests, implement the minimal changes needed to maintain JSON test compatibility.
  </action>
  <verify>Run: `python file_matcher.py test_dir1 test_dir2 --json | python -m json.tool` - should produce valid JSON</verify>
  <done>JsonActionFormatter produces valid, schema-compatible JSON for compare action</done>
</task>

<task type="auto">
  <name>Task 3: Update ActionFormatter ABC for action parameter</name>
  <files>file_matcher.py</files>
  <action>
Update the ActionFormatter ABC (lines ~325-467) to document the action parameter:

1. Update __init__ signature to accept action parameter (optional, for subclasses that need it):
```python
def __init__(self, verbose: bool = False, preview_mode: bool = True, action: str | None = None):
    """Initialize the formatter with configuration.

    Args:
        verbose: If True, show additional details in output
        preview_mode: If True, format for preview; if False, format for execution
        action: Action type (compare, hardlink, symlink, delete) for action-specific formatting
    """
    self.verbose = verbose
    self.preview_mode = preview_mode
    self._action = action
```

2. This provides a consistent interface for both Text and JSON implementations to access the action type.
  </action>
  <verify>Run: `python3 run_tests.py` - all tests should pass</verify>
  <done>ActionFormatter ABC updated to support action parameter; all tests pass</done>
</task>

</tasks>

<verification>
1. `python file_matcher.py test_dir1 test_dir2 --action compare` shows "Compare mode:" header
2. `python file_matcher.py test_dir1 test_dir2 --action compare` does NOT show PREVIEW banner
3. `python file_matcher.py test_dir1 test_dir2 --action compare --json` produces valid JSON
4. `python file_matcher.py test_dir1 test_dir2 --action hardlink` still works with banner
5. `python3 run_tests.py` passes all tests
</verification>

<success_criteria>
- TextActionFormatter produces "Compare mode:" header for compare action
- TextActionFormatter skips PREVIEW/EXECUTING banner for compare action
- JsonActionFormatter produces valid JSON for compare action
- All existing tests pass without modification
- Action mode output unchanged for hardlink/symlink/delete
</success_criteria>

<output>
After completion, create `.planning/phases/10-unify-compare-as-action/10-02-SUMMARY.md`
</output>
