---
phase: 14-extract-formatters-and-directory
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - filematcher/directory.py
  - filematcher/__init__.py
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "`from filematcher.directory import find_matching_files, index_directory` works"
    - "`from file_matcher import find_matching_files, index_directory` works (backward compat)"
    - "All 217 tests pass without modification"
  artifacts:
    - path: "filematcher/directory.py"
      provides: "Directory indexing and matching operations"
      contains: "def find_matching_files"
    - path: "filematcher/__init__.py"
      provides: "Direct import from directory module"
      contains: "from filematcher.directory import"
  key_links:
    - from: "filematcher/directory.py"
      to: "filematcher.hashing"
      via: "import for get_file_hash"
      pattern: "from filematcher\\.hashing import get_file_hash"
    - from: "filematcher/directory.py"
      to: "filematcher.actions"
      via: "import for format_file_size"
      pattern: "from filematcher\\.actions import format_file_size"
    - from: "filematcher/directory.py"
      to: "filematcher.filesystem"
      via: "import for is_in_directory"
      pattern: "from filematcher\\.filesystem import is_in_directory"
    - from: "file_matcher.py"
      to: "filematcher.directory"
      via: "import for backward compatibility"
      pattern: "from filematcher\\.directory import"
---

<objective>
Extract directory operations to filematcher/directory.py module.

Purpose: Continue package refactoring by extracting directory indexing and file matching operations into a dedicated module.

Output: filematcher/directory.py with index_directory, find_matching_files, select_master_file, and select_oldest functions.
</objective>

<execution_context>
@/Users/patrick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-extract-formatters-and-directory/14-RESEARCH.md
@.planning/phases/14-extract-formatters-and-directory/14-01-SUMMARY.md
@filematcher/__init__.py
@filematcher/hashing.py
@filematcher/actions.py
@filematcher/filesystem.py
@file_matcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create filematcher/directory.py</name>
  <files>filematcher/directory.py</files>
  <action>
Create filematcher/directory.py with:

1. Module docstring explaining purpose (directory indexing and file matching operations)

2. Imports:
   - Python stdlib: collections.defaultdict, logging, os, shutil, sys, pathlib.Path
   - Internal: from filematcher.hashing import get_file_hash
   - Internal: from filematcher.actions import format_file_size
   - Internal: from filematcher.filesystem import is_in_directory

3. Module-level logger:
   ```python
   logger = logging.getLogger(__name__)
   ```

4. Extract from file_matcher.py (copy entire implementations):
   - select_oldest() function (lines ~949-961)
   - select_master_file() function (lines ~1054-1097)
   - index_directory() function (lines ~1364-1421)
   - find_matching_files() function (lines ~1423-1480)

5. Use `from __future__ import annotations` at top for type hints

6. DO NOT import from file_matcher.py - the module must be self-contained using only hashing.py, actions.py, and filesystem.py

7. The module should be approximately 150-180 lines (4 functions plus imports/docstrings)
  </action>
  <verify>
python3 -c "from filematcher.directory import index_directory, find_matching_files, select_master_file, select_oldest; print('directory.py imports OK')"
  </verify>
  <done>filematcher/directory.py exists with all directory operation functions importable</done>
</task>

<task type="auto">
  <name>Task 2: Update imports and verify tests</name>
  <files>filematcher/__init__.py, file_matcher.py</files>
  <action>
1. Update filematcher/__init__.py:
   - Add direct import block after the formatters import:
     ```python
     # Import from directory submodule (extracted module)
     # This import depends on hashing.py, actions.py, and filesystem.py
     from filematcher.directory import (
         index_directory,
         find_matching_files,
         select_master_file,
         select_oldest,
     )
     ```
   - Remove these names from __getattr__ lazy loader (they're now directly imported)

2. Update file_matcher.py:
   - Add import from filematcher.directory for all extracted symbols
   - Remove the original definitions (select_oldest, select_master_file, index_directory, find_matching_files)
   - Remove ~135 lines of function definitions

3. Run full test suite to verify backward compatibility

NOTE: If any tests fail due to patch paths (like in Phase 13-02), update the patch paths from `file_matcher.X` to `filematcher.directory.X` in the test files.
  </action>
  <verify>
python3 run_tests.py 2>&1 | tail -5
  </verify>
  <done>All 217 tests pass, file_matcher.py reduced by ~135 lines, directory operations imported from filematcher.directory</done>
</task>

</tasks>

<verification>
1. `python3 -c "from filematcher.directory import index_directory, find_matching_files, select_master_file"` succeeds
2. `python3 -c "from file_matcher import find_matching_files, index_directory"` succeeds (backward compat)
3. `python3 run_tests.py` shows 217 tests pass with 0 failures
4. `wc -l filematcher/directory.py` shows approximately 150-180 lines
5. `wc -l file_matcher.py` shows approximately 920-970 lines (reduced from ~1050 after Plan 01)
</verification>

<success_criteria>
- filematcher/directory.py exists with all directory operation functions
- Direct import in __init__.py (not lazy __getattr__)
- All 217 tests pass (with test patch path updates if needed)
- file_matcher.py reduced by ~135 lines from Plan 01 state
- Both `from filematcher.directory import X` and `from file_matcher import X` work
</success_criteria>

<output>
After completion, create `.planning/phases/14-extract-formatters-and-directory/14-02-SUMMARY.md`
</output>
