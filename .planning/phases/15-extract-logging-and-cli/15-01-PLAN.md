---
phase: 15-extract-logging-and-cli
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - filematcher/cli.py
  - filematcher/__init__.py
  - filematcher/__main__.py
  - file_matcher.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "`from filematcher.cli import main` works"
    - "`filematcher --help` displays help after pip install -e ."
    - "`python -m filematcher --help` works"
    - "`python file_matcher.py --help` works (backward compat)"
    - "All 217 tests pass without modification"
  artifacts:
    - path: "filematcher/cli.py"
      provides: "CLI entry point and helper functions"
      contains: "def main():"
    - path: "filematcher/__init__.py"
      provides: "Direct import from cli module"
      contains: "from filematcher.cli import"
    - path: "pyproject.toml"
      provides: "Entry point configuration"
      contains: 'filematcher = "filematcher.cli:main"'
  key_links:
    - from: "filematcher/cli.py"
      to: "filematcher.colors"
      via: "import for ColorConfig, determine_color_mode"
      pattern: "from filematcher\\.colors import"
    - from: "filematcher/cli.py"
      to: "filematcher.directory"
      via: "import for find_matching_files"
      pattern: "from filematcher\\.directory import"
    - from: "filematcher/cli.py"
      to: "filematcher.actions"
      via: "import for audit logging and execution"
      pattern: "from filematcher\\.actions import"
    - from: "filematcher/cli.py"
      to: "filematcher.formatters"
      via: "import for formatter classes"
      pattern: "from filematcher\\.formatters import"
    - from: "filematcher/__main__.py"
      to: "filematcher.cli"
      via: "import for python -m invocation"
      pattern: "from filematcher\\.cli import main"
    - from: "file_matcher.py"
      to: "filematcher"
      via: "wildcard re-export for all public symbols"
      pattern: "from filematcher import \\*"
    - from: "file_matcher.py"
      to: "filematcher.cli"
      via: "explicit import for __main__ block clarity"
      pattern: "from filematcher\\.cli import main"
---

<objective>
Extract CLI module and finalize entry points for Phase 15.

Purpose: Complete the package refactoring by extracting all remaining functions from file_matcher.py to filematcher/cli.py, update pyproject.toml entry point to filematcher.cli:main, and establish file_matcher.py as a thin backward-compatibility wrapper.

Output: filematcher/cli.py with main() and helper functions, updated entry points in pyproject.toml and __main__.py.

Note: MOD-07 (audit logging extraction) was completed in Phase 13 - audit logging lives in filematcher/actions.py. This plan focuses on MOD-08 (CLI extraction) and PKG-03 (entry point update).
</objective>

<execution_context>
@/Users/patrick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-extract-logging-and-cli/15-RESEARCH.md
@filematcher/__init__.py
@filematcher/__main__.py
@filematcher/colors.py
@filematcher/hashing.py
@filematcher/filesystem.py
@filematcher/actions.py
@filematcher/formatters.py
@filematcher/directory.py
@file_matcher.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create filematcher/cli.py</name>
  <files>filematcher/cli.py</files>
  <action>
Create filematcher/cli.py with:

1. Module docstring:
```python
"""Command-line interface for File Matcher.

This module provides:
- main(): CLI entry point (returns exit code)
- confirm_execution(): User confirmation prompt
- Helper functions for building data structures
"""
```

2. Future annotations at top:
```python
from __future__ import annotations
```

3. Standard library imports:
```python
import argparse
import logging
import os
import sys
from pathlib import Path
```

4. Internal imports from filematcher modules (copy exactly from file_matcher.py lines 15-82):
```python
# Import color system from filematcher.colors module
from filematcher.colors import (
    ColorConfig, determine_color_mode,
)

# Import filesystem helpers from filematcher.filesystem module
from filematcher.filesystem import (
    check_cross_filesystem,
    filter_hardlinked_duplicates,
    is_in_directory,
)

# Import action execution and audit logging from filematcher.actions module
from filematcher.actions import (
    create_audit_logger,
    write_log_header,
    log_operation,
    write_log_footer,
    execute_all_actions,
    determine_exit_code,
)

# Import formatters from filematcher.formatters module
from filematcher.formatters import (
    SpaceInfo,
    TextActionFormatter,
    JsonActionFormatter,
    format_confirmation_prompt,
    calculate_space_savings,
)

# Import directory operations from filematcher.directory module
from filematcher.directory import (
    find_matching_files,
    select_master_file,
)
```

5. Module-level logger:
```python
logger = logging.getLogger(__name__)
```

6. Extract from file_matcher.py (copy entire implementations):
   - confirm_execution() function (lines 92-109)
   - build_file_hash_lookup() function (lines 112-125)
   - get_cross_fs_for_hardlink() function (lines 128-138)
   - get_cross_fs_count() function (lines 141-151)
   - build_file_sizes() function (lines 154-169)
   - build_log_flags() function (lines 172-200)
   - main() function (lines 203-643)

7. Important for main():
   - Update logger configuration to also configure 'filematcher.cli' logger
   - The function should be exactly as in file_matcher.py (just copy it)
   - No `if __name__ == "__main__"` block needed in cli.py

8. The module should be approximately 550-600 lines
  </action>
  <verify>
python3 -c "from filematcher.cli import main, confirm_execution, build_file_hash_lookup; print('cli.py imports OK')"
  </verify>
  <done>filematcher/cli.py exists with main() and all helper functions importable</done>
</task>

<task type="auto">
  <name>Task 2: Update filematcher/__init__.py</name>
  <files>filematcher/__init__.py</files>
  <action>
Update filematcher/__init__.py in this specific order (order matters - imports must exist before removing lazy loader):

**Step 1: Add direct import block** after the directory import section (around line 115):
```python
# Import from cli submodule (extracted module)
# This import depends on all other filematcher modules
from filematcher.cli import (
    main,
    confirm_execution,
    build_file_hash_lookup,
    get_cross_fs_for_hardlink,
    get_cross_fs_count,
    build_file_sizes,
    build_log_flags,
)
```

**Step 2: Remove the __getattr__ function entirely** (lines 118-152) - it was only for lazy loading CLI functions which are now directly imported via Step 1.

**Step 3: Keep __version__ and __all__** (they should already list these symbols).

The __init__.py should be shorter now (approximately 180-200 lines) since the __getattr__ function is removed.
  </action>
  <verify>
python3 -c "from filematcher import main, confirm_execution; print('__init__.py re-exports OK')"
  </verify>
  <done>filematcher/__init__.py directly imports from cli module, __getattr__ removed</done>
</task>

<task type="auto">
  <name>Task 3: Update filematcher/__main__.py</name>
  <files>filematcher/__main__.py</files>
  <action>
Update filematcher/__main__.py to import directly from cli module:

```python
"""Entry point for python -m filematcher."""

import sys
from filematcher.cli import main

if __name__ == "__main__":
    sys.exit(main())
```

This ensures `python -m filematcher` works correctly by importing directly from the cli module.
  </action>
  <verify>
python3 -m filematcher --help 2>&1 | head -3
  </verify>
  <done>__main__.py imports from filematcher.cli</done>
</task>

<task type="auto">
  <name>Task 4: Update file_matcher.py as thin wrapper</name>
  <files>file_matcher.py</files>
  <action>
Replace file_matcher.py with a thin backward-compatibility wrapper:

```python
#!/usr/bin/env python3
"""
File Matcher - Find files with identical content across two directory trees.

This script is preserved for backward compatibility.
The implementation has moved to the filematcher package.

Usage (all equivalent):
    python file_matcher.py <args>
    python -m filematcher <args>
    filematcher <args>  # after pip install

Version: 1.1.0
"""

from __future__ import annotations

# Re-export everything from the filematcher package for backward compatibility
# This allows `from file_matcher import get_file_hash, find_matching_files` to work
from filematcher import *  # noqa: F401, F403

# Import main explicitly for the entry point
from filematcher.cli import main

if __name__ == "__main__":
    import sys
    sys.exit(main())
```

The file should be approximately 25-30 lines - a simple re-export wrapper that:
1. Re-exports all symbols from filematcher package via `from filematcher import *`
2. Imports main from cli for the `if __name__` block
3. Provides backward compat for `python file_matcher.py` invocation
  </action>
  <verify>
python3 file_matcher.py --help 2>&1 | head -3
  </verify>
  <done>file_matcher.py is thin wrapper importing from filematcher package</done>
</task>

<task type="auto">
  <name>Task 5: Update pyproject.toml entry point</name>
  <files>pyproject.toml</files>
  <action>
Update pyproject.toml:

1. Change the entry point from file_matcher:main to filematcher.cli:main:
```toml
[project.scripts]
filematcher = "filematcher.cli:main"
```

2. Update [tool.setuptools] to include both the package and the compatibility module:
```toml
[tool.setuptools]
packages = ["filematcher"]
py-modules = ["file_matcher"]
```

This ensures:
- `filematcher` command runs filematcher.cli:main
- The filematcher package is installed
- The file_matcher.py module is installed for backward compatibility
  </action>
  <verify>
pip install -e /Users/patrick/dev/cursor_projects/filematcher && filematcher --help 2>&1 | head -3
  </verify>
  <done>pyproject.toml entry point updated to filematcher.cli:main</done>
</task>

<task type="auto">
  <name>Task 6: Run full test suite</name>
  <files></files>
  <action>
Run the full test suite to verify all 217 tests pass.

If any tests fail due to import paths, update the test files to import from the correct location. Based on research, tests should continue to work via `from file_matcher import X` due to the re-export wrapper.

Potential issues to check:
- Tests that patch `file_matcher.main` may need to patch `filematcher.cli.main`
- Tests that check __name__ may need adjustment

Run: python3 run_tests.py
  </action>
  <verify>
python3 /Users/patrick/dev/cursor_projects/filematcher/run_tests.py 2>&1 | tail -5
  </verify>
  <done>All 217 tests pass</done>
</task>

</tasks>

<verification>
1. `python3 -c "from filematcher.cli import main, confirm_execution"` succeeds
2. `python3 -c "from filematcher import main, confirm_execution"` succeeds (re-export)
3. `python3 -c "from file_matcher import main"` succeeds (backward compat)
4. `python3 -m filematcher --help` displays help text
5. `filematcher --help` displays help text (after pip install -e .)
6. `python3 file_matcher.py --help` displays help text (backward compat)
7. `python3 run_tests.py` shows 217 tests pass with 0 failures
8. `wc -l filematcher/cli.py` shows approximately 550-600 lines
9. `wc -l file_matcher.py` shows approximately 25-30 lines (thin wrapper)
10. `grep -q "filematcher.cli:main" pyproject.toml` succeeds (entry point updated)
</verification>

<success_criteria>
- filematcher/cli.py exists with main() and all CLI helper functions
- Direct import in __init__.py (no more __getattr__ lazy loader)
- __main__.py imports from filematcher.cli
- file_matcher.py is thin wrapper (~25-30 lines)
- pyproject.toml entry point is filematcher.cli:main
- All 217 tests pass
- All three invocation methods work: `filematcher`, `python -m filematcher`, `python file_matcher.py`
</success_criteria>

<output>
After completion, create `.planning/phases/15-extract-logging-and-cli/15-01-SUMMARY.md`
</output>
