---
phase: 02-dry-run-preview
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "Output shows [MASTER] prefix for master files"
    - "Output shows [DUP:?] prefix (indented) for duplicate files"
    - "Duplicate groups separated by blank lines"
    - "Groups ordered alphabetically by master file path"
    - "Verbose mode shows duplicate count with master line"
  artifacts:
    - path: "file_matcher.py"
      provides: "format_duplicate_group() function"
      contains: "[MASTER]"
  key_links:
    - from: "main()"
      to: "format_duplicate_group()"
      via: "function call in master-mode output"
      pattern: "format_duplicate_group"
---

<objective>
Refactor Phase 1 output from arrow notation to hierarchical [MASTER]/[DUP] format

Purpose: The new format supports action labels ([DUP:hardlink], [DUP:symlink], etc.) needed for dry-run preview. This is a prerequisite for Phase 2 dry-run functionality.

Output: Updated output formatting in file_matcher.py that displays master/duplicate relationships using [MASTER] and [DUP:?] prefixes instead of arrow notation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dry-run-preview/02-CONTEXT.md
@.planning/phases/02-dry-run-preview/02-RESEARCH.md
@file_matcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create format_duplicate_group() function</name>
  <files>file_matcher.py</files>
  <action>
Create a new function `format_duplicate_group()` that replaces `format_master_output()`:

```python
def format_duplicate_group(
    master_file: str,
    duplicates: list[str],
    action: str | None = None,
    verbose: bool = False,
    file_sizes: dict[str, int] | None = None
) -> list[str]:
    """
    Format a duplicate group for display.

    Args:
        master_file: Path to the master file
        duplicates: List of paths to duplicate files
        action: Action type (None, "hardlink", "symlink", "delete")
        verbose: If True, show additional details
        file_sizes: Dict mapping paths to file sizes (for verbose mode)

    Returns:
        List of formatted lines for this group
    """
```

Output format:
- Master line: `[MASTER] /path/to/master/file.txt`
- Duplicate lines (4-space indent): `    [DUP:?] /path/to/dup.txt` (or `[DUP:action]` when action provided)
- Verbose master line adds: `[MASTER] /path/file.txt (3 duplicates, 1.5 MB)`
- Sort duplicates alphabetically within the group

Keep `format_master_output()` temporarily for backward compatibility - we will remove it after tests are updated.
  </action>
  <verify>
Run `python3 -c "from file_matcher import format_duplicate_group; print(format_duplicate_group('/a/master.txt', ['/b/dup1.txt', '/b/dup2.txt']))"` and verify output shows [MASTER] and [DUP:?] format.
  </verify>
  <done>
format_duplicate_group() exists and returns properly formatted lines with [MASTER] prefix, indented [DUP:?] lines, and alphabetically sorted duplicates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update main() to use new output format</name>
  <files>file_matcher.py</files>
  <action>
Modify the master-mode output section in main() (around lines 424-443) to:

1. Replace the call to `format_master_output()` with `format_duplicate_group()`
2. Sort master_results by master file path before output (alphabetical per CONTEXT.md)
3. Print blank line between groups
4. Pass verbose flag and file_sizes dict (compute sizes for all files in group)

For verbose mode:
- Build file_sizes dict: `{path: os.path.getsize(path) for path in [master_file] + duplicates}`
- Pass to format_duplicate_group()

Update the non-verbose output path to use the new function:
```python
for line in format_duplicate_group(master_file, duplicates, action=None, verbose=args.verbose, file_sizes=file_sizes):
    print(line)
print()  # Blank line between groups
```

Also update tests in test_master_directory.py to expect the new [MASTER]/[DUP] format instead of arrow notation. Key tests to update:
- test_master_output_format_detailed
- test_master_appears_first
- Any test checking for "->" in output
  </action>
  <verify>
Run `python3 file_matcher.py test_dir1 test_dir2 --master test_dir1` and verify:
1. Output shows [MASTER] prefix for master files
2. Output shows indented [DUP:?] for duplicates
3. Groups are separated by blank lines

Run `python3 run_tests.py` to verify all tests pass (after updating test expectations).
  </verify>
  <done>
main() uses format_duplicate_group() for master-mode output. Output displays [MASTER]/[DUP:?] format. All tests pass with updated expectations.
  </done>
</task>

</tasks>

<verification>
1. `python3 file_matcher.py test_dir1 test_dir2 --master test_dir1` shows new format
2. `python3 file_matcher.py test_dir1 test_dir2 --master test_dir1 -v` shows verbose details (duplicate count, sizes)
3. `python3 run_tests.py` - all tests pass
4. Output is alphabetically sorted by master file path
</verification>

<success_criteria>
- Arrow notation removed from master-mode output
- [MASTER]/[DUP:?] format displays correctly
- Verbose mode shows duplicate count and file sizes
- Groups separated by blank lines
- All existing tests updated and passing
</success_criteria>

<output>
After completion, create `.planning/phases/02-dry-run-preview/02-01-SUMMARY.md`
</output>
