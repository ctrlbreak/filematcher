---
phase: 02-dry-run-preview
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "User can run with --dry-run flag"
    - "Dry-run requires --master flag (error if missing)"
    - "Dry-run banner displayed at top of output"
    - "Statistics footer shows duplicate groups, files, and space savings"
    - "No files are modified when --dry-run is active"
    - "[DUP:?] shown without --action, [DUP:action] shown with --action"
    - "Cross-filesystem warning shown when --action hardlink with cross-fs files"
  artifacts:
    - path: "file_matcher.py"
      provides: "--dry-run/-n flag"
      contains: "--dry-run"
    - path: "file_matcher.py"
      provides: "--action/-a flag"
      contains: "--action"
    - path: "file_matcher.py"
      provides: "format_dry_run_banner() function"
      contains: "DRY RUN"
    - path: "file_matcher.py"
      provides: "format_statistics_footer() function"
      contains: "def format_statistics_footer"
  key_links:
    - from: "main()"
      to: "format_dry_run_banner()"
      via: "function call when --dry-run"
      pattern: "if.*dry_run.*format_dry_run_banner"
    - from: "main()"
      to: "format_statistics_footer()"
      via: "function call at end of dry-run output"
      pattern: "format_statistics_footer"
    - from: "main()"
      to: "calculate_space_savings()"
      via: "function call for statistics"
      pattern: "calculate_space_savings"
    - from: "format_duplicate_group()"
      to: "action parameter"
      via: "action label in output"
      pattern: "\\[DUP:(hardlink|symlink|delete|\\?)\\]"
---

<objective>
Implement --dry-run flag with banner, statistics footer, and action preview

Purpose: Users can preview what would happen during deduplication and see aggregate statistics before any modifications occur. This is the core Phase 2 deliverable covering requirements DRY-01 through DRY-04 and STAT-01 through STAT-03.

Output: Working --dry-run mode with clear output showing planned changes, cross-filesystem warnings, and statistics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dry-run-preview/02-CONTEXT.md
@.planning/phases/02-dry-run-preview/02-RESEARCH.md
@.planning/phases/02-dry-run-preview/02-01-SUMMARY.md
@.planning/phases/02-dry-run-preview/02-02-SUMMARY.md
@file_matcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --dry-run and --action flags with validation</name>
  <files>file_matcher.py</files>
  <action>
Add two new CLI arguments in main():

```python
parser.add_argument('--dry-run', '-n', action='store_true',
                    help='Preview changes without executing them')
parser.add_argument('--action', '-a', choices=['hardlink', 'symlink', 'delete'],
                    help='Action to take on duplicates (used with --dry-run or --master)')
```

Add validation after argument parsing:
```python
if args.dry_run and not args.master:
    parser.error("--dry-run requires --master to be specified")
```

Note: --action without --dry-run is valid (will be used in Phase 3 for actual execution). But for Phase 2, when --dry-run is set, action determines the label shown (hardlink/symlink/delete vs ?).
  </action>
  <verify>
Run:
```bash
# Should fail with error
python3 file_matcher.py test_dir1 test_dir2 --dry-run 2>&1 | grep -q "requires --master" && echo "Validation works"

# Should succeed (parse only, may have other issues without master flag)
python3 file_matcher.py test_dir1 test_dir2 --master test_dir1 --dry-run --action hardlink -s 2>&1 | head -5
```
  </verify>
  <done>
--dry-run and --action flags are added. Validation ensures --dry-run requires --master. --action accepts hardlink/symlink/delete choices.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add banner and footer formatting functions</name>
  <files>file_matcher.py</files>
  <action>
Add two new functions:

```python
DRY_RUN_BANNER = "=== DRY RUN - No changes will be made ==="

def format_dry_run_banner() -> str:
    """Return the dry-run header banner."""
    return DRY_RUN_BANNER


def format_statistics_footer(
    group_count: int,
    duplicate_count: int,
    master_count: int,
    space_savings: int,
    action: str | None = None,
    verbose: bool = False,
    cross_fs_count: int = 0
) -> list[str]:
    """
    Format the statistics footer for dry-run output.

    Args:
        group_count: Number of duplicate groups
        duplicate_count: Total number of duplicate files
        master_count: Number of master files (preserved)
        space_savings: Bytes that would be saved
        action: Action type for action-specific messaging
        verbose: If True, show exact bytes
        cross_fs_count: Number of files that can't be hardlinked (cross-fs)

    Returns:
        List of lines for the footer
    """
```

Footer format:
```
--- Statistics ---
Duplicate groups: 5
Master files preserved: 5
Duplicate files: 12
Space to be reclaimed: 1.5 GB
```

Action-specific messaging when action is provided:
- hardlink: "Files to become hard links: 12" (and if cross_fs_count > 0: "  Warning: 3 files on different filesystem (cannot hardlink)")
- symlink: "Files to become symbolic links: 12"
- delete: "Files to be deleted: 12"

Verbose mode adds: `  (1,536,000,000 bytes)` after space line.
  </action>
  <verify>
Run:
```python
python3 -c "
from file_matcher import format_dry_run_banner, format_statistics_footer

print(format_dry_run_banner())
print()
for line in format_statistics_footer(5, 12, 5, 1536000000, action='hardlink', verbose=True, cross_fs_count=2):
    print(line)
"
```
Should show banner and properly formatted statistics with hardlink action and warning.
  </verify>
  <done>
format_dry_run_banner() and format_statistics_footer() exist. Footer shows action-specific messaging and cross-filesystem warnings. Verbose mode shows exact bytes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate dry-run mode into main()</name>
  <files>file_matcher.py</files>
  <action>
Modify main() to handle dry-run mode:

1. When `args.dry_run` is True:
   - Print banner first: `print(format_dry_run_banner())`
   - Print blank line after banner

2. Update the format_duplicate_group() calls to pass `action=args.action`:
   - This will show `[DUP:hardlink]`, `[DUP:symlink]`, `[DUP:delete]`, or `[DUP:?]`

3. For hardlink action, check cross-filesystem:
   ```python
   cross_fs_files = set()
   if args.action == 'hardlink':
       for master_file, duplicates, reason in master_results:
           cross_fs_files.update(check_cross_filesystem(master_file, duplicates))
   ```

4. Update format_duplicate_group() to accept and display cross-fs warnings:
   - Add `cross_fs_files: set[str] | None = None` parameter
   - When a duplicate is in cross_fs_files, append ` [!cross-fs]` to the line

5. After all groups printed, call format_statistics_footer():
   ```python
   bytes_saved, dup_count, grp_count = calculate_space_savings(master_results)
   cross_fs_count = len(cross_fs_files) if args.action == 'hardlink' else 0

   footer_lines = format_statistics_footer(
       group_count=grp_count,
       duplicate_count=dup_count,
       master_count=len(master_results),
       space_savings=bytes_saved,
       action=args.action,
       verbose=args.verbose,
       cross_fs_count=cross_fs_count
   )
   for line in footer_lines:
       print(line)
   ```

6. Keep existing summary mode behavior when `--dry-run` is NOT set (backward compatibility).

7. When `--dry-run --summary` is used together, show ONLY statistics (no file listing), but still show the dry-run banner.
  </action>
  <verify>
Run these tests:
```bash
# Dry-run with action
python3 file_matcher.py test_dir1 test_dir2 --master test_dir1 --dry-run --action hardlink

# Dry-run without action (should show [DUP:?])
python3 file_matcher.py test_dir1 test_dir2 --master test_dir1 --dry-run

# Dry-run with summary only
python3 file_matcher.py test_dir1 test_dir2 --master test_dir1 --dry-run --summary

# Dry-run verbose
python3 file_matcher.py test_dir1 test_dir2 --master test_dir1 --dry-run -v

# All existing tests still pass
python3 run_tests.py
```
  </verify>
  <done>
Dry-run mode fully functional. Banner displays at top. Statistics footer displays at bottom. Action labels show correctly. Cross-filesystem warnings appear for hardlink action. Summary mode shows only statistics with banner.
  </done>
</task>

</tasks>

<verification>
1. `python3 file_matcher.py test_dir1 test_dir2 --dry-run` fails with "--dry-run requires --master"
2. `python3 file_matcher.py test_dir1 test_dir2 --master test_dir1 --dry-run` shows:
   - Banner at top
   - [MASTER]/[DUP:?] formatted output
   - Statistics footer at bottom
3. `python3 file_matcher.py test_dir1 test_dir2 --master test_dir1 --dry-run --action hardlink` shows [DUP:hardlink] labels
4. `python3 run_tests.py` - all tests pass
5. Original (non-dry-run) behavior unchanged
</verification>

<success_criteria>
- DRY-01: --dry-run flag exists and works
- DRY-02: Dry-run shows list of files (via [MASTER]/[DUP] format)
- DRY-03: Dry-run shows action (via [DUP:action] labels)
- DRY-04: Dry-run shows space savings (via statistics footer)
- STAT-01: Duplicate group count shown
- STAT-02: Affected file count shown
- STAT-03: Space to be reclaimed shown
- Cross-filesystem warnings for hardlink action
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-dry-run-preview/02-03-SUMMARY.md`
</output>
