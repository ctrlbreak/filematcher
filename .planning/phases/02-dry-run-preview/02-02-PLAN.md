---
phase: 02-dry-run-preview
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "Space savings correctly calculated as sum of duplicate file sizes"
    - "Cross-filesystem detection identifies files on different devices"
    - "Statistics functions work with empty input (zero duplicates)"
  artifacts:
    - path: "file_matcher.py"
      provides: "calculate_space_savings() function"
      contains: "def calculate_space_savings"
    - path: "file_matcher.py"
      provides: "get_device_id() function"
      contains: "def get_device_id"
    - path: "file_matcher.py"
      provides: "check_cross_filesystem() function"
      contains: "def check_cross_filesystem"
  key_links:
    - from: "calculate_space_savings()"
      to: "os.path.getsize()"
      via: "function call"
      pattern: "os\\.path\\.getsize"
    - from: "check_cross_filesystem()"
      to: "os.stat().st_dev"
      via: "device ID comparison"
      pattern: "st_dev"
---

<objective>
Add statistics calculation and cross-filesystem detection infrastructure

Purpose: These utility functions will be used by the dry-run mode to display space savings and warn about cross-filesystem hardlink limitations. Building them separately allows clean testing.

Output: Three new functions in file_matcher.py: calculate_space_savings(), get_device_id(), check_cross_filesystem()
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dry-run-preview/02-RESEARCH.md
@file_matcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add calculate_space_savings() function</name>
  <files>file_matcher.py</files>
  <action>
Add a new function to calculate space that would be saved by deduplication:

```python
def calculate_space_savings(
    duplicate_groups: list[tuple[str, list[str], str]]
) -> tuple[int, int, int]:
    """
    Calculate space that would be saved by deduplication.

    Args:
        duplicate_groups: List of (master_file, duplicates_list, reason) tuples
                         (matches output from select_master_file)

    Returns:
        Tuple of (total_bytes_saved, total_duplicate_count, group_count)
    """
```

Implementation details:
- Space saved = sum of all duplicate file sizes (NOT master sizes)
- All duplicates in a group have same size as master, so: `file_size * len(duplicates)`
- Handle empty duplicates list gracefully (contributes 0)
- Use `os.path.getsize(master_file)` to get the file size
- Only count groups that have at least one duplicate

Edge cases:
- Empty input list: return (0, 0, 0)
- Group with no duplicates: skip (don't count in group_count)
  </action>
  <verify>
Run:
```python
python3 -c "
from file_matcher import calculate_space_savings
# Mock test with tuples matching select_master_file output
result = calculate_space_savings([])
print(f'Empty: {result}')
assert result == (0, 0, 0), 'Empty should return zeros'
print('calculate_space_savings works correctly')
"
```
  </verify>
  <done>
calculate_space_savings() exists, correctly sums duplicate file sizes, handles empty input, and returns (bytes, count, groups) tuple.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cross-filesystem detection functions</name>
  <files>file_matcher.py</files>
  <action>
Add two functions for detecting cross-filesystem situations (important for hardlink warnings):

```python
def get_device_id(path: str) -> int:
    """
    Get the device ID for a file's filesystem.

    Args:
        path: Path to the file

    Returns:
        Device ID (st_dev from os.stat)

    Raises:
        OSError: If file cannot be accessed
    """
    return os.stat(path).st_dev


def check_cross_filesystem(master_file: str, duplicates: list[str]) -> set[str]:
    """
    Check which duplicates are on different filesystems than master.

    Returns set of duplicate paths that cannot be hardlinked to master
    (they're on a different filesystem).

    Args:
        master_file: Path to the master file
        duplicates: List of paths to check

    Returns:
        Set of duplicate paths on different filesystems
    """
```

Implementation details for check_cross_filesystem:
- Get master's device ID using get_device_id()
- For each duplicate, compare device IDs
- If different, add to result set
- On OSError (file deleted, permission denied), treat as cross-filesystem for safety
- Return empty set if no cross-filesystem duplicates found

These functions enable proactive warnings in dry-run mode when user specifies `--action hardlink` but some files are on different filesystems.
  </action>
  <verify>
Run:
```python
python3 -c "
from file_matcher import get_device_id, check_cross_filesystem
import tempfile
import os

# Test get_device_id with a known file
dev_id = get_device_id('file_matcher.py')
print(f'Device ID for file_matcher.py: {dev_id}')
assert isinstance(dev_id, int), 'Should return integer'

# Test check_cross_filesystem with files on same filesystem
with tempfile.TemporaryDirectory() as tmpdir:
    master = os.path.join(tmpdir, 'master.txt')
    dup = os.path.join(tmpdir, 'dup.txt')
    with open(master, 'w') as f: f.write('test')
    with open(dup, 'w') as f: f.write('test')

    cross_fs = check_cross_filesystem(master, [dup])
    print(f'Cross-fs files (same dir, should be empty): {cross_fs}')
    assert cross_fs == set(), 'Same dir should have no cross-fs'

print('Cross-filesystem detection works correctly')
"
```
  </verify>
  <done>
get_device_id() and check_cross_filesystem() exist and correctly identify files on different filesystems using os.stat().st_dev comparison.
  </done>
</task>

</tasks>

<verification>
1. `python3 -c "from file_matcher import calculate_space_savings, get_device_id, check_cross_filesystem; print('All functions importable')"` succeeds
2. `python3 run_tests.py` - all existing tests still pass
3. Functions handle edge cases (empty input, missing files)
</verification>

<success_criteria>
- calculate_space_savings() correctly computes (bytes, count, groups)
- get_device_id() returns integer device ID from st_dev
- check_cross_filesystem() identifies cross-filesystem files
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/02-dry-run-preview/02-02-SUMMARY.md`
</output>
