---
phase: 13-extract-filesystem-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - filematcher/filesystem.py
  - filematcher/__init__.py
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "`from filematcher.filesystem import is_hardlink_to` imports successfully"
    - "`from filematcher import is_hardlink_to` imports successfully (re-export)"
    - "`from file_matcher import is_hardlink_to` imports successfully (backward compat)"
    - "All 217 tests pass without modification"
  artifacts:
    - path: "filematcher/filesystem.py"
      provides: "Filesystem helper functions"
      exports: ["get_device_id", "is_hardlink_to", "is_symlink_to", "check_cross_filesystem", "filter_hardlinked_duplicates", "is_in_directory"]
  key_links:
    - from: "filematcher/__init__.py"
      to: "filematcher/filesystem.py"
      via: "direct import"
      pattern: "from filematcher\\.filesystem import"
    - from: "file_matcher.py"
      to: "filematcher/filesystem.py"
      via: "import statement"
      pattern: "from filematcher\\.filesystem import"
---

<objective>
Extract filesystem helper functions to filematcher/filesystem.py as a pure leaf module

Purpose: Create a standalone filesystem module with zero internal filematcher dependencies, following the established pattern from Phase 12 (hashing extraction). This improves code organization and enables better AI tooling navigation.

Output: filematcher/filesystem.py module with all filesystem helpers, updated package exports
</objective>

<execution_context>
@/Users/patrick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-extract-filesystem-actions/13-RESEARCH.md
@.planning/phases/12-extract-foundation-modules/12-02-SUMMARY.md

# Source files
@file_matcher.py
@filematcher/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create filematcher/filesystem.py with filesystem helpers</name>
  <files>filematcher/filesystem.py</files>
  <action>
Create filematcher/filesystem.py as a pure leaf module (stdlib-only dependencies).

Extract these 6 functions from file_matcher.py:
1. `get_device_id(path: str) -> int` (line 1356)
2. `check_cross_filesystem(master_file: str, duplicates: list[str]) -> set[str]` (line 1372)
3. `is_hardlink_to(file1: str, file2: str) -> bool` (line 1407)
4. `is_symlink_to(duplicate: str, master: str) -> bool` (line 1427)
5. `filter_hardlinked_duplicates(master_file: str, duplicates: list[str]) -> tuple[list[str], list[str]]` (line 1451)
6. `is_in_directory(filepath: str, directory: str) -> bool` (line 926)

Module structure:
```python
"""Filesystem helper functions for File Matcher.

This module provides utilities for detecting file relationships:
- is_hardlink_to: Check if two files share the same inode
- is_symlink_to: Check if a file is a symlink pointing to another
- check_cross_filesystem: Detect files on different filesystems
- filter_hardlinked_duplicates: Separate already-linked files
- get_device_id: Get filesystem device ID for a path
- is_in_directory: Check path containment

These functions handle OSError gracefully, returning safe defaults
rather than raising exceptions for missing files.
"""
from __future__ import annotations

import os
from pathlib import Path

# ... function definitions (copy exact implementations from file_matcher.py)
```

IMPORTANT:
- Use only stdlib imports (os, pathlib.Path)
- NO imports from filematcher or file_matcher
- Copy function implementations EXACTLY from file_matcher.py (preserve docstrings, type hints)
- Order functions so dependencies come first: get_device_id, check_cross_filesystem, is_hardlink_to, is_symlink_to, filter_hardlinked_duplicates, is_in_directory
  </action>
  <verify>
```bash
python3 -c "from filematcher.filesystem import get_device_id, is_hardlink_to, is_symlink_to, check_cross_filesystem, filter_hardlinked_duplicates, is_in_directory; print('All imports successful')"
```
  </verify>
  <done>filematcher/filesystem.py exists with all 6 functions, imports successfully</done>
</task>

<task type="auto">
  <name>Task 2: Update __init__.py and file_matcher.py imports</name>
  <files>filematcher/__init__.py, file_matcher.py</files>
  <action>
**Step 1: Update filematcher/__init__.py**

Add direct import from filesystem module (after hashing imports, before __getattr__):
```python
# Import from filesystem submodule (extracted module)
# This import is safe - filesystem.py has only stdlib dependencies
from filematcher.filesystem import (
    get_device_id,
    is_hardlink_to,
    is_symlink_to,
    check_cross_filesystem,
    filter_hardlinked_duplicates,
    is_in_directory,
)
```

Remove these 6 symbols from the `_file_matcher_attrs` dict in `__getattr__`:
- `is_hardlink_to`
- `is_symlink_to`
- `check_cross_filesystem`
- `get_device_id`
- `filter_hardlinked_duplicates`
- `is_in_directory`

(These are now directly imported, no longer need lazy loading)

**Step 2: Update file_matcher.py**

Add import from filematcher.filesystem at the top imports section (near the existing filematcher imports around line 28):
```python
from filematcher.filesystem import (
    get_device_id,
    is_hardlink_to,
    is_symlink_to,
    check_cross_filesystem,
    filter_hardlinked_duplicates,
    is_in_directory,
)
```

Delete the original function definitions from file_matcher.py:
- `is_in_directory` at line ~926
- `get_device_id` at line ~1356
- `check_cross_filesystem` at line ~1372
- `is_hardlink_to` at line ~1407
- `is_symlink_to` at line ~1427
- `filter_hardlinked_duplicates` at line ~1451

Note: After removing is_in_directory (~line 926), check that nothing in file_matcher.py between the removal point and the other functions depends on it (it's used by select_master_file which comes after).
  </action>
  <verify>
```bash
# Verify all import paths work
python3 -c "from filematcher.filesystem import is_hardlink_to; print('Direct import works')"
python3 -c "from filematcher import is_hardlink_to; print('Package re-export works')"
python3 -c "from file_matcher import is_hardlink_to; print('Backward compat works')"

# Run all tests
python3 run_tests.py
```
  </verify>
  <done>All 217 tests pass, all three import paths work for filesystem functions</done>
</task>

</tasks>

<verification>
1. Direct module import works:
   ```bash
   python3 -c "from filematcher.filesystem import is_hardlink_to, is_symlink_to, check_cross_filesystem, get_device_id, filter_hardlinked_duplicates, is_in_directory; print('OK')"
   ```

2. Package re-export works:
   ```bash
   python3 -c "from filematcher import is_hardlink_to, is_symlink_to, check_cross_filesystem, get_device_id, filter_hardlinked_duplicates, is_in_directory; print('OK')"
   ```

3. Backward compatibility works:
   ```bash
   python3 -c "from file_matcher import is_hardlink_to, is_symlink_to, check_cross_filesystem, get_device_id, filter_hardlinked_duplicates, is_in_directory; print('OK')"
   ```

4. All 217 tests pass:
   ```bash
   python3 run_tests.py
   ```
</verification>

<success_criteria>
- [ ] filematcher/filesystem.py exists with 6 functions
- [ ] filesystem.py has only stdlib imports (os, pathlib)
- [ ] All three import paths work for each function
- [ ] All 217 tests pass without modification
- [ ] Functions removed from __getattr__ lazy loader
</success_criteria>

<output>
After completion, create `.planning/phases/13-extract-filesystem-actions/13-01-SUMMARY.md`
</output>
