---
phase: 13-extract-filesystem-actions
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - filematcher/actions.py
  - filematcher/__init__.py
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "`from filematcher.actions import execute_action` imports successfully"
    - "`from filematcher import execute_action` imports successfully (re-export)"
    - "`from file_matcher import execute_action` imports successfully (backward compat)"
    - "All 217 tests pass without modification"
  artifacts:
    - path: "filematcher/actions.py"
      provides: "Action execution and audit logging"
      exports: ["safe_replace_with_link", "execute_action", "execute_all_actions", "determine_exit_code", "create_audit_logger", "write_log_header", "log_operation", "write_log_footer", "format_file_size"]
  key_links:
    - from: "filematcher/actions.py"
      to: "filematcher/filesystem.py"
      via: "import statement"
      pattern: "from filematcher\\.filesystem import"
    - from: "filematcher/__init__.py"
      to: "filematcher/actions.py"
      via: "direct import"
      pattern: "from filematcher\\.actions import"
    - from: "file_matcher.py"
      to: "filematcher/actions.py"
      via: "import statement"
      pattern: "from filematcher\\.actions import"
---

<objective>
Extract action execution and audit logging functions to filematcher/actions.py

Purpose: Create an actions module that handles all file deduplication operations (hardlink, symlink, delete) and audit logging. This module depends on filematcher/filesystem.py (extracted in Plan 01) for is_hardlink_to and is_symlink_to checks.

Output: filematcher/actions.py module with action execution and audit logging, updated package exports
</objective>

<execution_context>
@/Users/patrick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-extract-filesystem-actions/13-RESEARCH.md
@.planning/phases/13-extract-filesystem-actions/13-01-SUMMARY.md

# Source files (after Plan 01 modifications)
@file_matcher.py
@filematcher/__init__.py
@filematcher/filesystem.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create filematcher/actions.py with action execution and audit logging</name>
  <files>filematcher/actions.py</files>
  <action>
Create filematcher/actions.py as a near-leaf module that depends on filematcher.filesystem.

Extract these functions from file_matcher.py:
1. `format_file_size(size_bytes: int | float) -> str` (line ~1719) - DUPLICATE this function
2. `safe_replace_with_link(duplicate: Path, master: Path, action: str) -> tuple[bool, str]` (line ~1482)
3. `execute_action(duplicate: str, master: str, action: str, fallback_symlink: bool = False) -> tuple[bool, str, str]` (line ~1539)
4. `execute_all_actions(...)` (line ~1625) - complex signature, see file_matcher.py
5. `determine_exit_code(success_count: int, failure_count: int) -> int` (line ~1600)
6. `create_audit_logger(log_path: Path | None = None) -> tuple[logging.Logger, Path]` (line ~1744)
7. `write_log_header(...)` (line ~1781)
8. `log_operation(...)` (line ~1815)
9. `write_log_footer(...)` (line ~1854)

Module structure:
```python
"""Action execution and audit logging for File Matcher.

This module provides:
- safe_replace_with_link: Atomic replacement with rollback on failure
- execute_action: Single action dispatch with skip detection
- execute_all_actions: Batch processing with continue-on-error
- determine_exit_code: Exit code calculation per convention
- Audit logging: create_audit_logger, write_log_header, log_operation, write_log_footer
"""
from __future__ import annotations

import logging
import os
import sys
from datetime import datetime
from pathlib import Path

# Internal import from filesystem module (extracted in Plan 01)
from filematcher.filesystem import is_hardlink_to, is_symlink_to

# Module-level logger for debug messages in execute_all_actions
logger = logging.getLogger(__name__)


def format_file_size(size_bytes: int | float) -> str:
    """Convert file size in bytes to human-readable format.

    Duplicated from file_matcher.py to keep actions module self-contained.
    """
    # ... exact implementation from file_matcher.py


def safe_replace_with_link(...):
    # ... exact implementation


# ... remaining functions
```

IMPORTANT:
- Import is_hardlink_to, is_symlink_to from filematcher.filesystem (NOT file_matcher)
- Duplicate format_file_size in this module (used by log_operation and write_log_footer)
- Create module-level logger: `logger = logging.getLogger(__name__)`
- execute_all_actions uses: os, sys.stderr, logger, execute_action, log_operation
- Copy function implementations EXACTLY from file_matcher.py (preserve docstrings, type hints)
- Order functions logically: format_file_size, safe_replace_with_link, execute_action, determine_exit_code, execute_all_actions, then audit logging functions
  </action>
  <verify>
```bash
python3 -c "from filematcher.actions import safe_replace_with_link, execute_action, execute_all_actions, determine_exit_code, create_audit_logger, write_log_header, log_operation, write_log_footer, format_file_size; print('All imports successful')"
```
  </verify>
  <done>filematcher/actions.py exists with all 9 functions, imports successfully</done>
</task>

<task type="auto">
  <name>Task 2: Update __init__.py and file_matcher.py imports</name>
  <files>filematcher/__init__.py, file_matcher.py</files>
  <action>
**Step 1: Update filematcher/__init__.py**

Add direct import from actions module (after filesystem imports, before __getattr__):
```python
# Import from actions submodule (extracted module)
# This import is safe - actions.py depends only on filesystem.py and stdlib
from filematcher.actions import (
    format_file_size,
    safe_replace_with_link,
    execute_action,
    execute_all_actions,
    determine_exit_code,
    create_audit_logger,
    write_log_header,
    log_operation,
    write_log_footer,
)
```

Remove these symbols from the `_file_matcher_attrs` dict in `__getattr__`:
- `execute_action`
- `safe_replace_with_link`
- `execute_all_actions`
- `determine_exit_code`
- `create_audit_logger`
- `log_operation`
- `write_log_header`
- `write_log_footer`
- `format_file_size`

(These are now directly imported, no longer need lazy loading)

**Step 2: Update file_matcher.py**

Add import from filematcher.actions at the top imports section (near the existing filematcher imports):
```python
from filematcher.actions import (
    format_file_size,
    safe_replace_with_link,
    execute_action,
    execute_all_actions,
    determine_exit_code,
    create_audit_logger,
    write_log_header,
    log_operation,
    write_log_footer,
)
```

Delete the original function definitions from file_matcher.py:
- `safe_replace_with_link` at line ~1482
- `execute_action` at line ~1539
- `determine_exit_code` at line ~1600
- `execute_all_actions` at line ~1625
- `format_file_size` at line ~1719
- `create_audit_logger` at line ~1744
- `write_log_header` at line ~1781
- `log_operation` at line ~1815
- `write_log_footer` at line ~1854

Note: format_file_size is still used by other parts of file_matcher.py (calculate_space_savings, format_statistics_footer) - the import will provide it.
  </action>
  <verify>
```bash
# Verify all import paths work
python3 -c "from filematcher.actions import execute_action; print('Direct import works')"
python3 -c "from filematcher import execute_action; print('Package re-export works')"
python3 -c "from file_matcher import execute_action; print('Backward compat works')"

# Run all tests
python3 run_tests.py
```
  </verify>
  <done>All 217 tests pass, all three import paths work for action functions</done>
</task>

</tasks>

<verification>
1. Direct module import works:
   ```bash
   python3 -c "from filematcher.actions import safe_replace_with_link, execute_action, execute_all_actions, determine_exit_code, create_audit_logger, write_log_header, log_operation, write_log_footer, format_file_size; print('OK')"
   ```

2. Package re-export works:
   ```bash
   python3 -c "from filematcher import safe_replace_with_link, execute_action, execute_all_actions, determine_exit_code, create_audit_logger, write_log_header, log_operation, write_log_footer, format_file_size; print('OK')"
   ```

3. Backward compatibility works:
   ```bash
   python3 -c "from file_matcher import safe_replace_with_link, execute_action, execute_all_actions, determine_exit_code, create_audit_logger, write_log_header, log_operation, write_log_footer, format_file_size; print('OK')"
   ```

4. All 217 tests pass:
   ```bash
   python3 run_tests.py
   ```

5. Verify actions.py imports from filesystem (not file_matcher):
   ```bash
   grep "from filematcher.filesystem import" filematcher/actions.py
   # Should show: from filematcher.filesystem import is_hardlink_to, is_symlink_to
   ```
</verification>

<success_criteria>
- [ ] filematcher/actions.py exists with 9 functions
- [ ] actions.py imports from filematcher.filesystem (not file_matcher)
- [ ] format_file_size is duplicated in actions.py (self-contained)
- [ ] All three import paths work for each function
- [ ] All 217 tests pass without modification
- [ ] Functions removed from __getattr__ lazy loader
</success_criteria>

<output>
After completion, create `.planning/phases/13-extract-filesystem-actions/13-02-SUMMARY.md`
</output>
