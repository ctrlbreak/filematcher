---
phase: 05-formatter-abstraction
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - file_matcher.py
autonomous: true

must_haves:
  truths:
    - "Action mode output routes through TextActionFormatter"
    - "Output is byte-identical to current implementation"
    - "All existing tests pass without modification"
    - "Preview mode and execute mode both use formatter"
    - "Duplicate groups are sorted alphabetically by master file path"
  artifacts:
    - path: "file_matcher.py"
      provides: "Wired action formatter in main()"
      contains: "TextActionFormatter("
  key_links:
    - from: "main() action mode branches"
      to: "TextActionFormatter"
      via: "formatter instantiation and method calls"
      pattern: "formatter\\.format_(banner|duplicate_group|statistics)"
---

<objective>
Wire TextActionFormatter into main() to handle all action mode output (preview and execute), ensuring byte-identical output.

Purpose: Replace direct print() calls in action mode with formatter method calls, preparing for JSON output in Phase 6. This plan focuses on action mode only - it's the more complex path with preview/execute branches.

Output: main() action mode uses TextActionFormatter, all tests still passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-formatter-abstraction/05-CONTEXT.md
@.planning/phases/05-formatter-abstraction/05-RESEARCH.md
@.planning/phases/05-formatter-abstraction/05-01-SUMMARY.md
@file_matcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire TextActionFormatter into preview mode</name>
  <files>file_matcher.py</files>
  <action>
In main(), locate the print_preview_output() helper function (~lines 1078-1151).

Replace this entire helper function with formatter-based output:

1. BEFORE the preview_mode/execute_mode branching (~line 1074), instantiate the formatter:
```python
# Create formatter for action mode
action_formatter = TextActionFormatter(verbose=args.verbose, preview_mode=not args.execute)
```

2. Replace the print_preview_output() helper function with a version that uses the formatter:

```python
def print_preview_output(formatter: ActionFormatter, show_banner: bool = True) -> None:
    if show_banner:
        formatter.format_banner()

    if args.summary:
        # Summary mode: show only statistics (no file listing)
        bytes_saved, dup_count, grp_count = calculate_space_savings(master_results)
        cross_fs_count = len(cross_fs_files) if args.action == 'hardlink' else 0
        formatter.format_statistics(
            group_count=grp_count,
            duplicate_count=dup_count,
            master_count=len(master_results),
            space_savings=bytes_saved,
            action=args.action,
            cross_fs_count=cross_fs_count
        )
    else:
        # Detailed output
        if not matches:
            print("No duplicates found.")
        else:
            # Print warnings first
            formatter.format_warnings(warnings)

            # Sort master_results by master file path (alphabetical) for determinism (OUT-04)
            sorted_results = sorted(master_results, key=lambda x: x[0])

            for i, (master_file, duplicates, reason) in enumerate(sorted_results):
                # Build file_sizes dict for verbose mode
                file_sizes = None
                if args.verbose:
                    all_paths = [master_file] + duplicates
                    file_sizes = {p: os.path.getsize(p) for p in all_paths}

                # Format group
                cross_fs_to_show = cross_fs_files if args.action == 'hardlink' else None
                formatter.format_duplicate_group(
                    master_file, duplicates,
                    action=args.action,
                    file_sizes=file_sizes,
                    cross_fs_files=cross_fs_to_show
                )

                # Print blank line between groups (but not after the last one)
                if i < len(sorted_results) - 1:
                    print()

            # Print statistics footer
            bytes_saved, dup_count, grp_count = calculate_space_savings(master_results)
            cross_fs_count = len(cross_fs_files) if args.action == 'hardlink' else 0
            formatter.format_statistics(
                group_count=grp_count,
                duplicate_count=dup_count,
                master_count=len(master_results),
                space_savings=bytes_saved,
                action=args.action,
                cross_fs_count=cross_fs_count
            )
```

3. Update the preview_mode call (~line 1154-1155):
```python
if preview_mode:
    print_preview_output(action_formatter, show_banner=True)
```

CRITICAL:
- The "No duplicates found." case and blank lines between groups remain as direct print() calls (intentional to minimize refactoring scope)
- master_results MUST be sorted by master file path for determinism (OUT-04)
  </action>
  <verify>
```bash
# Test preview mode output
cd /Users/patrick/dev/cursor_projects/filematcher && python3 -c "
import sys
sys.argv = ['filematcher', 'test_dir1', 'test_dir2', '--action', 'hardlink']
from file_matcher import main
main()
" 2>&1 | head -20
```
Should show PREVIEW banner and duplicate groups.
  </verify>
  <done>Preview mode output routes through TextActionFormatter with sorted master_results</done>
</task>

<task type="auto">
  <name>Task 2: Wire TextActionFormatter into execute mode</name>
  <files>file_matcher.py</files>
  <action>
In main(), locate the execute_mode branch (~lines 1157-1226).

Update execute mode to use the formatter:

1. The execute mode first shows preview (already using formatter from Task 1):
```python
elif execute_mode:
    # First show preview so user sees what will happen
    print_preview_output(action_formatter, show_banner=True)
    print()
```

2. For the execute banner, use a second formatter instance with preview_mode=False:
```python
    # Then show execute banner and prompt for confirmation
    execute_formatter = TextActionFormatter(verbose=args.verbose, preview_mode=False)
    execute_formatter.format_banner()  # This prints "=== EXECUTING ==="
```
Wait - actually the execute_formatter should just call format_execute_banner() directly since we don't want a blank line after.

Actually, looking at the current code more carefully:
- Line 1164: `print(format_execute_banner())`
- There's NO blank line after the execute banner before the confirmation prompt

Keep the direct print call for the execute banner since the formatter's format_banner() adds a blank line:
```python
    # Then show execute banner and prompt for confirmation
    print(format_execute_banner())
```

3. Replace the execution summary output (lines 1211-1223) with formatter call:
```python
    # Print execution summary via formatter
    action_formatter_exec = TextActionFormatter(verbose=args.verbose, preview_mode=False)
    action_formatter_exec.format_execution_summary(
        success_count=success_count,
        failure_count=failure_count,
        skipped_count=skipped_count,
        space_saved=space_saved,
        log_path=str(actual_log_path),
        failed_list=failed_list
    )
```

CRITICAL: Preserve exact output format. The execute banner should NOT have a trailing blank line before the confirmation prompt.
  </action>
  <verify>
```bash
# Test execute mode output (with --yes to skip confirmation)
cd /Users/patrick/dev/cursor_projects/filematcher && python3 -c "
import sys
import tempfile
import shutil
import os

# Create temp dirs with duplicates
tmpdir = tempfile.mkdtemp()
dir1 = os.path.join(tmpdir, 'dir1')
dir2 = os.path.join(tmpdir, 'dir2')
os.makedirs(dir1)
os.makedirs(dir2)

# Create matching files
with open(os.path.join(dir1, 'master.txt'), 'w') as f:
    f.write('test content')
with open(os.path.join(dir2, 'dup.txt'), 'w') as f:
    f.write('test content')

sys.argv = ['filematcher', dir1, dir2, '--action', 'hardlink', '--execute', '--yes']
from file_matcher import main
exit_code = main()
print(f'Exit code: {exit_code}')

# Cleanup
shutil.rmtree(tmpdir)
"
```
Should show PREVIEW, then EXECUTING, then execution summary.
  </verify>
  <done>Execute mode output routes through TextActionFormatter</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run full test suite:
```bash
cd /Users/patrick/dev/cursor_projects/filematcher && python3 run_tests.py
```
All tests must pass - output should be byte-identical to before.

2. Manual verification of preview mode:
```bash
cd /Users/patrick/dev/cursor_projects/filematcher && python3 file_matcher.py test_dir1 test_dir2 --action hardlink
```
Should show PREVIEW banner, [WOULD HARDLINK] labels, and statistics footer.

3. Manual verification of summary mode:
```bash
cd /Users/patrick/dev/cursor_projects/filematcher && python3 file_matcher.py test_dir1 test_dir2 --action hardlink --summary
```
Should show PREVIEW banner and statistics only (no file listing).

4. Verify formatter is being used (add debug if needed):
The tests should pass, which validates the output is correct.
</verification>

<success_criteria>
1. Preview mode uses TextActionFormatter for output
2. Execute mode uses TextActionFormatter for execution summary
3. All existing CLI tests pass without modification
4. Output is byte-identical to previous implementation
5. Banner, groups, statistics, and execution summary all route through formatter
6. master_results sorted by master file path for deterministic output (OUT-04)
</success_criteria>

<output>
After completion, create `.planning/phases/05-formatter-abstraction/05-02-SUMMARY.md`
</output>
