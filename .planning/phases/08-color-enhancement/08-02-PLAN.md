---
phase: 08-color-enhancement
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified: [file_matcher.py]
autonomous: true

must_haves:
  truths:
    - "--color flag forces color output (even when piped)"
    - "--no-color flag disables color output"
    - "Last flag wins when both --color and --no-color specified"
    - "Color automatically enabled on TTY, disabled when piped (AUTO mode)"
    - "Master file paths shown in green"
    - "Duplicate file paths shown in yellow"
    - "PREVIEW MODE banner shown in bold yellow"
    - "Statistics header shown in cyan"
    - "Hash values shown dimmed"
    - "JSON output NEVER has ANSI codes (--json implies no color)"
  artifacts:
    - path: "file_matcher.py"
      provides: "--color and --no-color CLI flags, colored formatter output"
      contains: "add_argument.*--color"
  key_links:
    - from: "main() argument parsing"
      to: "ColorConfig initialization"
      via: "args.color_mode determines ColorMode"
    - from: "TextCompareFormatter"
      to: "ColorConfig"
      via: "constructor parameter color_config"
    - from: "TextActionFormatter"
      to: "ColorConfig"
      via: "constructor parameter color_config"
---

<objective>
Add --color/--no-color CLI flags and integrate color into Text formatters

Purpose: Enable TTY-aware color highlighting in CLI output. Users see colored output automatically on terminals (green masters, yellow duplicates, cyan stats). Colors disabled when piped or redirected. Explicit --color/--no-color flags override auto-detection.

Output: Modified file_matcher.py with --color/--no-color flags and colored text output
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-color-enhancement/08-CONTEXT.md
@.planning/phases/08-color-enhancement/08-RESEARCH.md
@.planning/phases/08-color-enhancement/08-01-SUMMARY.md
@file_matcher.py (lines 288-377 for TextCompareFormatter, lines 750-1050 for TextActionFormatter, lines 1820-1900 for argparse setup)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --color and --no-color CLI flags</name>
  <files>file_matcher.py</files>
  <action>
  Add --color and --no-color arguments to argparse in main(). Place them after --quiet (around line 1850, in the output control section).

  Use store_const pattern with last-wins semantics per CONTEXT.md:

  ```python
  # Color output control
  parser.add_argument('--color', dest='color_mode', action='store_const',
                      const='always',
                      help='Force color output (even when piped)')
  parser.add_argument('--no-color', dest='color_mode', action='store_const',
                      const='never',
                      help='Disable color output')
  # Default is None (auto mode - color on TTY, no color when piped)
  ```

  Then add a helper function to determine ColorMode from args (place after argument parsing, before directory validation):

  ```python
  def determine_color_mode(args) -> ColorMode:
      """Determine color mode from CLI arguments.

      Args:
          args: Parsed command-line arguments

      Returns:
          ColorMode based on flags (AUTO if no flags, ALWAYS for --color, NEVER for --no-color)
      """
      # --json implies no color (JSON must never have ANSI codes)
      if args.json:
          return ColorMode.NEVER

      # Explicit flag takes precedence
      if args.color_mode == 'always':
          return ColorMode.ALWAYS
      elif args.color_mode == 'never':
          return ColorMode.NEVER

      # Default to AUTO (TTY detection)
      return ColorMode.AUTO
  ```

  Note: This function should be defined inside main() or as a nested function, since it's only used there. Alternatively, define it at module level after the ColorConfig class.
  </action>
  <verify>
  Run: `python3 file_matcher.py --help | grep -E "(--color|--no-color)"`
  Expected: Shows both --color and --no-color with help text

  Run: `python3 -c "import file_matcher"`
  Expected: No import errors
  </verify>
  <done>
  --color and --no-color flags added to argparse. determine_color_mode helper function implemented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TextCompareFormatter to accept and use ColorConfig</name>
  <files>file_matcher.py</files>
  <action>
  Modify TextCompareFormatter to accept a ColorConfig parameter and apply colors to output.

  **Update constructor** (around line 288):

  ```python
  class TextCompareFormatter(CompareFormatter):
      """Text output formatter for compare mode (no action specified)."""

      def __init__(
          self,
          verbose: bool = False,
          dir1_name: str = "dir1",
          dir2_name: str = "dir2",
          color_config: ColorConfig | None = None
      ):
          """Initialize the formatter with configuration.

          Args:
              verbose: If True, show additional details in output
              dir1_name: Label for first directory
              dir2_name: Label for second directory
              color_config: Color configuration (default: no color)
          """
          super().__init__(verbose, dir1_name, dir2_name)
          self.cc = color_config or ColorConfig(mode=ColorMode.NEVER)
  ```

  **Update format_header** (around line 295):
  ```python
  def format_header(self, dir1: str, dir2: str, hash_algo: str) -> None:
      """Format comparison header showing mode and directories."""
      header = f"Compare mode: {dir1} vs {dir2}"
      print(cyan(header, self.cc))
  ```

  **Update format_summary_line** (around line 300):
  ```python
  def format_summary_line(self, group_count: int, duplicate_count: int, space_savings: int) -> None:
      """Format one-liner summary after header."""
      space_str = format_file_size(space_savings)
      summary = f"Found {group_count} duplicate groups ({duplicate_count} files, {space_str} reclaimable)"
      print(cyan(summary, self.cc))
      print()  # Blank line after summary
  ```

  **Update format_match_group** (around line 305):
  ```python
  def format_match_group(self, file_hash: str, files_dir1: list[str], files_dir2: list[str]) -> None:
      """Format a group of matching files."""
      # Hash in dim
      print(dim(f"Hash: {file_hash[:10]}...", self.cc))

      # Dir1 files - use default color (or could use green for "first" directory)
      print(f"  Files in {self.dir1_name}:")
      for f in sorted(files_dir1):
          print(f"    {f}")

      # Dir2 files - use default color
      print(f"  Files in {self.dir2_name}:")
      for f in sorted(files_dir2):
          print(f"    {f}")
      print()
  ```

  Note: In compare mode, files are not explicitly master/duplicate, so we don't color them green/yellow. Only action mode has that semantic distinction.

  **Update format_statistics** (around line 352):
  ```python
  def format_statistics(self, group_count: int, file_count: int, space_savings: int) -> None:
      """Format statistics footer matching action mode format."""
      print()
      print(cyan("--- Statistics ---", self.cc))
      print(f"Duplicate groups: {group_count}")
      print(f"Total files with matches: {file_count}")
      if space_savings > 0:
          print(f"Space reclaimable: {format_file_size(space_savings)}")
      else:
          print("Space reclaimable: (run with --action to calculate)")
  ```
  </action>
  <verify>
  Run: `python3 -c "from file_matcher import TextCompareFormatter, ColorConfig, ColorMode; f = TextCompareFormatter(color_config=ColorConfig(ColorMode.ALWAYS)); f.format_header('dir1', 'dir2', 'md5')" 2>/dev/null`
  Expected: Colored output (cyan header)

  Run: `python3 -c "import file_matcher"`
  Expected: No import errors
  </verify>
  <done>
  TextCompareFormatter accepts ColorConfig and applies cyan to headers/statistics, dim to hash values.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update TextActionFormatter to accept and use ColorConfig</name>
  <files>file_matcher.py</files>
  <action>
  Modify TextActionFormatter to accept ColorConfig and apply semantic colors (green for masters, yellow for duplicates, bold yellow for PREVIEW banner).

  **Update constructor** (around line 750):

  ```python
  class TextActionFormatter(ActionFormatter):
      """Text output formatter for action mode (preview/execute)."""

      def __init__(
          self,
          verbose: bool = False,
          preview_mode: bool = True,
          color_config: ColorConfig | None = None
      ):
          """Initialize the formatter with configuration.

          Args:
              verbose: If True, show additional details in output
              preview_mode: If True, format for preview; if False, format for execution
              color_config: Color configuration (default: no color)
          """
          super().__init__(verbose, preview_mode)
          self.cc = color_config or ColorConfig(mode=ColorMode.NEVER)
  ```

  **Update format_banner** (PREVIEW MODE banner):
  ```python
  def format_banner(self) -> None:
      """Format and output the mode banner (PREVIEW or EXECUTE)."""
      banner_line = "=" * 60
      if self.preview_mode:
          text = "=== PREVIEW MODE - No changes will be made ==="
          print(bold_yellow(banner_line, self.cc))
          print(bold_yellow(text, self.cc))
          print(bold_yellow(banner_line, self.cc))
      else:
          text = "=== EXECUTING - Changes will be made ==="
          print(banner_line)
          print(text)
          print(banner_line)
  ```

  **Update format_unified_header**:
  ```python
  def format_unified_header(self, action: str, dir1: str, dir2: str) -> None:
      """Format unified header showing mode, state, action and directories."""
      state = "PREVIEW" if self.preview_mode else "EXECUTING"
      header = f"Action mode ({state}): {action} {dir1} vs {dir2}"
      print(cyan(header, self.cc))
  ```

  **Update format_summary_line**:
  ```python
  def format_summary_line(self, group_count: int, duplicate_count: int, space_savings: int) -> None:
      """Format one-liner summary after header."""
      space_str = format_file_size(space_savings)
      summary = f"Found {group_count} duplicate groups ({duplicate_count} files, {space_str} reclaimable)"
      print(cyan(summary, self.cc))
      print()
  ```

  **Update format_duplicate_group** - this is where green/yellow coloring is key:
  The existing implementation likely calls format_duplicate_group_preview or similar. Find the code that prints "MASTER:" and duplicate paths. Apply:
  - Green to master file path
  - Yellow to duplicate file paths

  Look for patterns like:
  ```python
  # Before:
  print(f"  MASTER: {master_file}")
  print(f"    {dup}")

  # After:
  print(f"  MASTER: {green(master_file, self.cc)}")
  print(f"    {yellow(dup, self.cc)}")
  ```

  Find the actual format_duplicate_group implementation and update it. It should color:
  - Master file path: green
  - Duplicate file paths: yellow
  - Cross-filesystem warnings: red

  **Update format_statistics**:
  ```python
  def format_statistics(self, group_count: int, duplicate_count: int, master_count: int,
                        space_savings: int, action: str, cross_fs_count: int = 0) -> None:
      """Format statistics footer."""
      print()
      print(cyan("--- Statistics ---", self.cc))
      print(f"Duplicate groups: {group_count}")
      # ... rest of statistics output
  ```

  **Update format_warnings** - warnings in red:
  ```python
  def format_warnings(self, warnings: list[str]) -> None:
      """Format and output warnings."""
      for warning in warnings:
          print(red(f"Warning: {warning}", self.cc))
  ```
  </action>
  <verify>
  Run: `python3 file_matcher.py test_dir1 test_dir2 --action hardlink --color 2>/dev/null | head -10`
  Expected: Colored output with cyan header, bold yellow PREVIEW banner

  Run: `python3 file_matcher.py test_dir1 test_dir2 --action hardlink --no-color 2>/dev/null | head -10`
  Expected: No ANSI codes in output

  Run: `python3 -c "import file_matcher"`
  Expected: No import errors
  </verify>
  <done>
  TextActionFormatter applies semantic colors: green masters, yellow duplicates, bold yellow PREVIEW banner, cyan headers/stats, red warnings.
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire ColorConfig into main() formatter instantiation</name>
  <files>file_matcher.py</files>
  <action>
  Update main() to create ColorConfig and pass it to Text formatters.

  **After argument parsing and determine_color_mode**, create ColorConfig:
  ```python
  # Determine color mode and create color config
  color_mode = determine_color_mode(args)
  color_config = ColorConfig(mode=color_mode, stream=sys.stdout)
  ```

  **Update TextCompareFormatter instantiation** (compare mode section):
  Find where TextCompareFormatter is created and add color_config:
  ```python
  # Before:
  compare_formatter = TextCompareFormatter(
      verbose=args.verbose,
      dir1_name=args.dir1,
      dir2_name=args.dir2
  )

  # After:
  compare_formatter = TextCompareFormatter(
      verbose=args.verbose,
      dir1_name=args.dir1,
      dir2_name=args.dir2,
      color_config=color_config
  )
  ```

  **Update TextActionFormatter instantiation** (action mode section):
  Find where TextActionFormatter is created and add color_config:
  ```python
  # Before:
  formatter = TextActionFormatter(verbose=args.verbose, preview_mode=True)

  # After:
  formatter = TextActionFormatter(
      verbose=args.verbose,
      preview_mode=True,
      color_config=color_config
  )
  ```

  There may be multiple places where formatters are created (preview mode, execute mode). Update all instances.

  **JSON formatters remain unchanged** - they don't use ColorConfig since JSON must never have ANSI codes.
  </action>
  <verify>
  Run: `python3 file_matcher.py test_dir1 test_dir2 --color 2>/dev/null | head -5`
  Expected: Colored output (cyan "Compare mode:" header)

  Run: `python3 file_matcher.py test_dir1 test_dir2 --no-color 2>/dev/null | head -5`
  Expected: Plain text, no ANSI codes

  Run: `python3 file_matcher.py test_dir1 test_dir2 --json 2>/dev/null | python3 -c "import sys; print('\\033[' not in sys.stdin.read())"`
  Expected: True (JSON has no ANSI codes)

  Run: `python3 file_matcher.py test_dir1 test_dir2 --json --color 2>/dev/null | python3 -c "import sys; print('\\033[' not in sys.stdin.read())"`
  Expected: True (--json overrides --color, no ANSI in JSON)

  Run: `python3 run_tests.py`
  Expected: All tests pass
  </verify>
  <done>
  ColorConfig created in main() based on args and passed to all TextCompareFormatter and TextActionFormatter instantiations. JSON formatters unaffected. All tests pass.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:

1. --color flag works:
   - `python3 file_matcher.py test_dir1 test_dir2 --color | cat -v | grep -c '\^\[\['` > 0
   - (cat -v shows escape codes as ^[[ )

2. --no-color flag works:
   - `python3 file_matcher.py test_dir1 test_dir2 --no-color | cat -v | grep -c '\^\[\['` = 0

3. Auto mode works (TTY detection):
   - `python3 file_matcher.py test_dir1 test_dir2 | cat -v | grep -c '\^\[\['` = 0 (piped, no color)

4. JSON never colored:
   - `python3 file_matcher.py test_dir1 test_dir2 --json --color 2>/dev/null | grep -c '\033'` = 0

5. Semantic colors correct:
   - Masters in green, duplicates in yellow (action mode)
   - PREVIEW banner in bold yellow
   - Statistics header in cyan
   - Hash values dimmed

6. All tests pass:
   - `python3 run_tests.py`
</verification>

<success_criteria>
- --color flag forces color output (even when piped)
- --no-color flag disables color output
- Last flag wins when both specified
- Color auto-enabled on TTY, auto-disabled when piped
- Master file paths shown in green (action mode)
- Duplicate file paths shown in yellow (action mode)
- PREVIEW MODE banner shown in bold yellow
- Statistics headers shown in cyan
- Hash values shown dimmed
- JSON output NEVER has ANSI codes (--json implies no color)
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-color-enhancement/08-02-SUMMARY.md`
</output>
