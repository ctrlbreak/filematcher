---
phase: 08-color-enhancement
plan: 03
type: execute
wave: 3
depends_on: [08-01, 08-02]
files_modified: [tests/test_color_output.py, README.md]
autonomous: true

must_haves:
  truths:
    - "Tests verify --color forces color output"
    - "Tests verify --no-color disables color output"
    - "Tests verify NO_COLOR environment variable disables color"
    - "Tests verify JSON output never contains ANSI codes"
    - "Tests verify text content identical with and without color (only ANSI codes differ)"
    - "README documents --color and --no-color flags"
    - "README documents NO_COLOR environment variable support"
  artifacts:
    - path: "tests/test_color_output.py"
      provides: "Test coverage for Phase 8 color features"
      min_lines: 80
    - path: "README.md"
      provides: "Documentation for color flags and NO_COLOR"
      contains: "--color"
  key_links:
    - from: "test_color_output.py"
      to: "file_matcher.py"
      via: "subprocess.run testing CLI color behavior"
---

<objective>
Add comprehensive tests for color output features and document in README

Purpose: Ensure color features (--color, --no-color, NO_COLOR, TTY detection) are thoroughly tested and documented. Critical test: content is identical with/without color (success criteria UX-03 equivalent).

Output: New test file tests/test_color_output.py and updated README.md
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-color-enhancement/08-CONTEXT.md
@.planning/phases/08-color-enhancement/08-RESEARCH.md
@.planning/phases/08-color-enhancement/08-01-SUMMARY.md
@.planning/phases/08-color-enhancement/08-02-SUMMARY.md
@tests/test_base.py (for test patterns)
@tests/test_output_unification.py (for subprocess test patterns)
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_color_output.py with color feature tests</name>
  <files>tests/test_color_output.py</files>
  <action>
  Create a new test file with comprehensive tests for color output features. Follow patterns from test_output_unification.py for subprocess-based testing.

  ```python
  """Tests for Phase 8: Color Enhancement features.

  Tests cover:
  - --color flag (force color on)
  - --no-color flag (force color off)
  - NO_COLOR environment variable
  - FORCE_COLOR environment variable
  - JSON output never colored
  - Text content identical with/without color
  """
  from __future__ import annotations

  import os
  import re
  import subprocess
  import sys
  import unittest
  from pathlib import Path

  # Regex to match ANSI escape codes
  ANSI_ESCAPE = re.compile(r'\x1b\[[0-9;]*m')


  def strip_ansi(text: str) -> str:
      """Remove ANSI escape codes from text."""
      return ANSI_ESCAPE.sub('', text)


  class TestColorFlag(unittest.TestCase):
      """Tests for --color flag."""

      def setUp(self):
          """Set up test directories."""
          self.test_dir1 = str(Path(__file__).parent.parent / "test_dir1")
          self.test_dir2 = str(Path(__file__).parent.parent / "test_dir2")

      def test_color_flag_forces_color(self):
          """--color flag should force color output even when piped."""
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2, "--color"],
              capture_output=True,
              text=True
          )
          # Should have ANSI codes in output
          self.assertIn('\033[', result.stdout)

      def test_color_flag_long_form(self):
          """--color flag should work."""
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2, "--color"],
              capture_output=True,
              text=True
          )
          self.assertIn('\033[', result.stdout)


  class TestNoColorFlag(unittest.TestCase):
      """Tests for --no-color flag."""

      def setUp(self):
          """Set up test directories."""
          self.test_dir1 = str(Path(__file__).parent.parent / "test_dir1")
          self.test_dir2 = str(Path(__file__).parent.parent / "test_dir2")

      def test_no_color_flag_disables_color(self):
          """--no-color flag should disable color output."""
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2, "--no-color"],
              capture_output=True,
              text=True
          )
          # Should NOT have ANSI codes in output
          self.assertNotIn('\033[', result.stdout)
          self.assertNotIn('\033[', result.stderr)

      def test_no_color_overrides_color_when_last(self):
          """--no-color should win when specified after --color (last wins)."""
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2,
               "--color", "--no-color"],
              capture_output=True,
              text=True
          )
          self.assertNotIn('\033[', result.stdout)

      def test_color_overrides_no_color_when_last(self):
          """--color should win when specified after --no-color (last wins)."""
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2,
               "--no-color", "--color"],
              capture_output=True,
              text=True
          )
          self.assertIn('\033[', result.stdout)


  class TestNoColorEnvironment(unittest.TestCase):
      """Tests for NO_COLOR environment variable."""

      def setUp(self):
          """Set up test directories."""
          self.test_dir1 = str(Path(__file__).parent.parent / "test_dir1")
          self.test_dir2 = str(Path(__file__).parent.parent / "test_dir2")

      def test_no_color_env_disables_color(self):
          """NO_COLOR environment variable should disable color."""
          env = os.environ.copy()
          env['NO_COLOR'] = '1'
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2],
              capture_output=True,
              text=True,
              env=env
          )
          self.assertNotIn('\033[', result.stdout)

      def test_color_flag_overrides_no_color_env(self):
          """--color flag should override NO_COLOR environment variable."""
          env = os.environ.copy()
          env['NO_COLOR'] = '1'
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2, "--color"],
              capture_output=True,
              text=True,
              env=env
          )
          # --color should win over NO_COLOR env
          self.assertIn('\033[', result.stdout)


  class TestForceColorEnvironment(unittest.TestCase):
      """Tests for FORCE_COLOR environment variable."""

      def setUp(self):
          """Set up test directories."""
          self.test_dir1 = str(Path(__file__).parent.parent / "test_dir1")
          self.test_dir2 = str(Path(__file__).parent.parent / "test_dir2")

      def test_force_color_env_enables_color(self):
          """FORCE_COLOR environment variable should enable color in pipes."""
          env = os.environ.copy()
          env['FORCE_COLOR'] = '1'
          # Remove NO_COLOR if present
          env.pop('NO_COLOR', None)
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2],
              capture_output=True,
              text=True,
              env=env
          )
          self.assertIn('\033[', result.stdout)

      def test_no_color_env_takes_precedence_over_force_color(self):
          """NO_COLOR should take precedence over FORCE_COLOR."""
          env = os.environ.copy()
          env['NO_COLOR'] = '1'
          env['FORCE_COLOR'] = '1'
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2],
              capture_output=True,
              text=True,
              env=env
          )
          self.assertNotIn('\033[', result.stdout)


  class TestJsonNeverColored(unittest.TestCase):
      """Tests that JSON output is never colored."""

      def setUp(self):
          """Set up test directories."""
          self.test_dir1 = str(Path(__file__).parent.parent / "test_dir1")
          self.test_dir2 = str(Path(__file__).parent.parent / "test_dir2")

      def test_json_no_color(self):
          """JSON output should never have ANSI codes."""
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2, "--json"],
              capture_output=True,
              text=True
          )
          self.assertNotIn('\033[', result.stdout)

      def test_json_with_color_flag_still_no_color(self):
          """--json --color should still produce JSON without ANSI codes."""
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2,
               "--json", "--color"],
              capture_output=True,
              text=True
          )
          self.assertNotIn('\033[', result.stdout)

      def test_json_with_force_color_env_still_no_color(self):
          """--json with FORCE_COLOR should still produce JSON without ANSI codes."""
          env = os.environ.copy()
          env['FORCE_COLOR'] = '1'
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2, "--json"],
              capture_output=True,
              text=True,
              env=env
          )
          self.assertNotIn('\033[', result.stdout)


  class TestContentIdentical(unittest.TestCase):
      """Tests that text content is identical with and without color."""

      def setUp(self):
          """Set up test directories."""
          self.test_dir1 = str(Path(__file__).parent.parent / "test_dir1")
          self.test_dir2 = str(Path(__file__).parent.parent / "test_dir2")

      def test_compare_mode_content_identical(self):
          """Compare mode: content should be identical with/without color."""
          # Get colored output
          colored = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2, "--color"],
              capture_output=True,
              text=True
          )
          # Get plain output
          plain = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2, "--no-color"],
              capture_output=True,
              text=True
          )
          # Strip ANSI and compare
          self.assertEqual(strip_ansi(colored.stdout), plain.stdout)

      def test_action_mode_content_identical(self):
          """Action mode: content should be identical with/without color."""
          # Get colored output
          colored = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2,
               "--action", "hardlink", "--color"],
              capture_output=True,
              text=True
          )
          # Get plain output
          plain = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2,
               "--action", "hardlink", "--no-color"],
              capture_output=True,
              text=True
          )
          # Strip ANSI and compare
          self.assertEqual(strip_ansi(colored.stdout), plain.stdout)


  class TestAutoModeNoColorInPipes(unittest.TestCase):
      """Tests that auto mode disables color when piped (no TTY)."""

      def setUp(self):
          """Set up test directories."""
          self.test_dir1 = str(Path(__file__).parent.parent / "test_dir1")
          self.test_dir2 = str(Path(__file__).parent.parent / "test_dir2")

      def test_auto_mode_no_color_when_piped(self):
          """Auto mode (default) should not use color when stdout is piped."""
          # subprocess.run with capture_output=True means stdout is not a TTY
          # So auto mode should disable color
          env = os.environ.copy()
          # Remove any color-forcing env vars
          env.pop('NO_COLOR', None)
          env.pop('FORCE_COLOR', None)
          result = subprocess.run(
              [sys.executable, "file_matcher.py", self.test_dir1, self.test_dir2],
              capture_output=True,
              text=True,
              env=env
          )
          # Should NOT have color (piped, not TTY)
          self.assertNotIn('\033[', result.stdout)


  if __name__ == "__main__":
      unittest.main()
  ```

  This test file covers all the success criteria for Phase 8:
  - UX-01: Color auto-enabled on TTY, auto-disabled when piped
  - UX-02: --color flag, --no-color flag
  - UX-03: NO_COLOR environment variable
  - Text content identical with/without color
  </action>
  <verify>
  Run: `python3 -m tests.test_color_output`
  Expected: All tests pass (assuming plans 01-02 implemented correctly)
  </verify>
  <done>
  test_color_output.py exists with comprehensive tests for --color, --no-color, NO_COLOR, FORCE_COLOR, JSON never colored, and content identity.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update README with color documentation</name>
  <files>README.md</files>
  <action>
  Update README.md to document color output features. Find the Options or CLI Arguments section.

  **Add to Output Control section** (after --quiet documentation):

  ```markdown
  ### Color Output

  File Matcher supports colored output to highlight key information:
  - **Green**: Master files (protected, preserved)
  - **Yellow**: Duplicate files (candidates for action)
  - **Cyan**: Headers and statistics
  - **Bold Yellow**: PREVIEW MODE banner

  Color behavior:
  - **Automatic**: Color enabled when output is a terminal (TTY), disabled when piped
  - `--color` - Force color output (useful for `less -R` or colored logs)
  - `--no-color` - Disable color output

  Environment variables:
  - `NO_COLOR` - Set to any value to disable color (standard: https://no-color.org/)
  - `FORCE_COLOR` - Set to any value to enable color in non-TTY contexts (CI systems)

  Flag precedence (last wins):
  ```bash
  # --no-color wins (specified last)
  filematcher dir1 dir2 --color --no-color

  # --color wins (specified last)
  filematcher dir1 dir2 --no-color --color
  ```

  Note: JSON output (`--json`) never includes color codes regardless of flags.
  ```

  Place this after the existing `--quiet` documentation (added in Phase 7) and before any other sections.
  </action>
  <verify>
  Run: `grep -A5 -- "--color" README.md`
  Expected: Shows --color documentation

  Run: `grep "NO_COLOR" README.md`
  Expected: Shows NO_COLOR documentation
  </verify>
  <done>
  README.md documents --color, --no-color flags, NO_COLOR/FORCE_COLOR environment variables, and color behavior.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify all tests pass</name>
  <files>run_tests.py</files>
  <action>
  Run the complete test suite including the new color output tests.

  Check if run_tests.py uses test discovery or needs explicit module listing. If explicit, add:
  ```python
  'tests.test_color_output',
  ```

  Run all tests:
  ```bash
  python3 run_tests.py
  ```

  Verify:
  - All existing tests pass (no regressions)
  - New color output tests pass
  - Total test count increased by ~12-15 tests
  </action>
  <verify>
  Run: `python3 run_tests.py`
  Expected: All tests pass, including new test_color_output tests

  Run: `python3 run_tests.py 2>&1 | grep -E "^(Ran|OK|FAILED)"`
  Expected: Shows "Ran N tests" with OK status
  </verify>
  <done>
  Full test suite passes including new color output tests. Test count reflects new coverage.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:

1. New tests exist and pass:
   - `python3 -m tests.test_color_output` shows all tests passing
   - Tests cover: --color, --no-color, NO_COLOR, FORCE_COLOR, JSON, content identity

2. Full test suite passes:
   - `python3 run_tests.py` exits 0
   - No regressions in existing tests

3. README updated:
   - --color and --no-color flags documented
   - NO_COLOR environment variable documented
   - Color semantics explained (green=master, yellow=duplicate)

4. Test coverage meaningful:
   - Tests use subprocess for true CLI behavior
   - Tests verify ANSI code presence/absence
   - Tests verify content identity (strip_ansi comparison)
</verification>

<success_criteria>
- tests/test_color_output.py exists with 12+ tests
- Tests cover --color flag (force color on)
- Tests cover --no-color flag (force color off)
- Tests cover NO_COLOR environment variable
- Tests cover FORCE_COLOR environment variable
- Tests cover JSON never colored
- Tests verify content identical with/without color
- README documents --color and --no-color flags
- README documents NO_COLOR environment variable
- README explains color semantics (green=master, yellow=duplicate)
- All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/08-color-enhancement/08-03-SUMMARY.md`
</output>
