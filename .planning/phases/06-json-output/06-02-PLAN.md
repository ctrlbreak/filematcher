---
phase: 06-json-output
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified: [file_matcher.py]
autonomous: true

must_haves:
  truths:
    - "User can run `filematcher dir1 dir2 --json` and receive valid JSON output"
    - "`--json` with `--action` produces JSON showing planned/executed actions"
    - "`--json --execute` requires `--yes` flag (no interactive prompts)"
    - "`--json --summary` outputs only summary section, no file lists"
    - "Text output remains unchanged when --json is not specified"
  artifacts:
    - path: "file_matcher.py"
      provides: "--json CLI argument"
      contains: "parser.add_argument.*--json"
    - path: "file_matcher.py"
      provides: "Formatter selection logic"
      contains: "JsonCompareFormatter\\("
  key_links:
    - from: "main()"
      to: "JsonCompareFormatter"
      via: "conditional instantiation when args.json"
      pattern: "if args\\.json.*JsonCompareFormatter"
    - from: "main()"
      to: "JsonActionFormatter"
      via: "conditional instantiation when args.json"
      pattern: "if args\\.json.*JsonActionFormatter"
---

<objective>
Add --json CLI flag and wire JsonCompareFormatter/JsonActionFormatter into main() with proper flag interaction handling.

Purpose: Enable users to get machine-readable JSON output by adding `--json` to any command.

Output: Working `--json` flag that produces valid JSON in both compare mode and action mode, with correct handling of all flag combinations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-json-output/06-CONTEXT.md
@.planning/phases/06-json-output/06-01-SUMMARY.md
@file_matcher.py (lines 1355-1385 for argparse, lines 1460-1640 for main() logic)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --json CLI argument</name>
  <files>file_matcher.py</files>
  <action>
Add `--json` argument to the argparse parser.

**Location:** In the argument parsing section (around line 1361-1381), add after existing flags:

```python
parser.add_argument('--json', '-j', action='store_true',
                    help='Output results in JSON format for scripting')
```

**Validation rule:** Add validation after parse_args() to enforce `--json --execute` requires `--yes`:

```python
if args.json and args.execute and not args.yes:
    parser.error("--json with --execute requires --yes flag to confirm (no interactive prompts in JSON mode)")
```

This prevents interactive confirmation prompts when outputting JSON, per CONTEXT.md decision.
  </action>
  <verify>
Run `python3 file_matcher.py --help | grep -A1 '\-\-json'` - should show the --json flag help text.
Run `python3 file_matcher.py test_dir1 test_dir2 --json --action hardlink --execute 2>&1 | grep -i "requires --yes"` - should show the validation error.
  </verify>
  <done>
--json flag accepted by CLI, and --json --execute without --yes produces clear error message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire JSON formatters into main()</name>
  <files>file_matcher.py</files>
  <action>
Modify main() to use JSON formatters when --json flag is present.

**Compare mode (no --action):**

Find where TextCompareFormatter is instantiated (around line 1598):
```python
compare_formatter = TextCompareFormatter(...)
```

Replace with conditional:
```python
if args.json:
    compare_formatter = JsonCompareFormatter(
        verbose=args.verbose,
        dir1_name=args.dir1,
        dir2_name=args.dir2
    )
else:
    compare_formatter = TextCompareFormatter(
        verbose=args.verbose,
        dir1_name=args.dir1,
        dir2_name=args.dir2
    )
```

**Action mode (--action specified):**

Find where TextActionFormatter is instantiated (around line 1462):
```python
action_formatter = TextActionFormatter(verbose=args.verbose, preview_mode=True)
```

Replace with conditional:
```python
if args.json:
    action_formatter = JsonActionFormatter(
        verbose=args.verbose,
        preview_mode=not args.execute
    )
else:
    action_formatter = TextActionFormatter(
        verbose=args.verbose,
        preview_mode=not args.execute
    )
```

**Important considerations:**

1. **Timestamp:** Set timestamp in formatter at start of execution:
   - Add method or set attribute after instantiation
   - Use `datetime.now(timezone.utc).isoformat()` for RFC 3339

2. **Directories metadata:** Pass master/duplicate dirs to JsonActionFormatter:
   - Add `master_dir` and `duplicate_dir` parameters to constructor OR
   - Add a `set_directories()` method to call after instantiation

3. **Hash algorithm:** Pass hash algorithm to compare formatter:
   - Already available from `args.hash`

4. **Summary-only mode:** When `--json --summary`, skip match group output:
   - In compare mode, check `args.summary` and skip format_match_group calls
   - The formatter still needs to know counts for summary
   - Can set a flag `formatter.summary_only = args.summary`

5. **Errors in JSON:** When operation fails, ensure error info goes to both stderr AND is captured in JSON output (if possible - may need error handling wrapper).
  </action>
  <verify>
Run these commands and verify JSON output:

1. Compare mode basic:
   `python3 file_matcher.py test_dir1 test_dir2 --json | python3 -m json.tool` - should be valid JSON

2. Compare mode with summary:
   `python3 file_matcher.py test_dir1 test_dir2 --json --summary | python3 -m json.tool` - valid JSON with summary only

3. Action mode preview:
   `python3 file_matcher.py test_dir1 test_dir2 --action hardlink --json | python3 -m json.tool` - valid JSON with action info

4. All existing tests still pass:
   `python3 run_tests.py`
  </verify>
  <done>
- `filematcher dir1 dir2 --json` produces valid JSON output in compare mode
- `filematcher dir1 dir2 --action hardlink --json` produces valid JSON output in action mode
- All existing tests pass (text output behavior unchanged)
  </done>
</task>

<task type="auto">
  <name>Task 3: Handle --json flag interactions</name>
  <files>file_matcher.py</files>
  <action>
Ensure all flag combinations work correctly with --json.

**Flag interaction matrix to implement:**

| Combination | Behavior |
|-------------|----------|
| `--json` | JSON output in compare mode |
| `--json --summary` | JSON with only summary, no match details |
| `--json --verbose` | JSON with per-file metadata (size, mtime) |
| `--json --show-unmatched` | JSON includes unmatchedDir1/unmatchedDir2 arrays |
| `--json --action X` | JSON with action mode output |
| `--json --action X --execute --yes` | JSON with execution results |
| `--json --fast` | No change to JSON structure (fast mode is internal) |
| `--json --hash sha256` | hashAlgorithm field shows "sha256" |
| `--json --different-names-only` | Filters results before JSON output (existing logic) |

**Implementation notes:**

1. **--summary handling:**
   - Check `args.summary` before calling `format_match_group()`
   - Pass file counts to `format_summary()` as usual
   - Result: JSON has summary stats but empty/missing matches array

2. **--verbose handling:**
   - Already passed to formatter constructor
   - JsonCompareFormatter includes metadata when verbose=True
   - JsonActionFormatter includes file sizes in all modes (needed for calculations)

3. **--show-unmatched handling:**
   - Check `args.show_unmatched` before calling `format_unmatched()`
   - If not specified, unmatchedDir1/unmatchedDir2 arrays are empty or omitted

4. **Progress messages:**
   - Logger already goes to stderr (no change needed)
   - With --json, stdout contains ONLY the JSON object
   - Consider suppressing verbose progress when --json is used (or let it go to stderr)

5. **Error handling:**
   - Errors should go to stderr as text (current behavior)
   - If possible, also include error info in JSON under an "errors" field
   - Exit code still indicates success/failure

**Suppress confirmation prompt:**
Already handled by --yes requirement validation in Task 1.
  </action>
  <verify>
Test each flag combination:

```bash
# Summary only
python3 file_matcher.py test_dir1 test_dir2 --json --summary | python3 -c "import sys,json; d=json.load(sys.stdin); print('matches' not in d or len(d.get('matches',[])) == 0)"

# Verbose includes metadata
python3 file_matcher.py test_dir1 test_dir2 --json --verbose | python3 -c "import sys,json; d=json.load(sys.stdin); print('metadata' in str(d))"

# Unmatched files
python3 file_matcher.py test_dir1 test_dir2 --json --show-unmatched | python3 -c "import sys,json; d=json.load(sys.stdin); print('unmatchedDir1' in d or 'unmatchedDir2' in d)"

# Different hash
python3 file_matcher.py test_dir1 test_dir2 --json --hash sha256 | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('hashAlgorithm') == 'sha256')"
```

All should print True.
  </verify>
  <done>
- All flag combinations produce valid JSON
- --summary produces JSON with only statistics
- --verbose includes per-file metadata in JSON
- --show-unmatched includes unmatched arrays
- Progress/errors go to stderr, JSON to stdout
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `python3 file_matcher.py test_dir1 test_dir2 --json | python3 -m json.tool` produces valid, formatted JSON
2. `python3 file_matcher.py test_dir1 test_dir2 --action hardlink --json | python3 -m json.tool` produces valid JSON
3. `python3 file_matcher.py test_dir1 test_dir2 --json --execute` without --yes shows validation error
4. `python3 run_tests.py` - all existing tests pass (text output unchanged)
5. JSON contains expected fields: timestamp, directories, hashAlgorithm, matches/duplicateGroups, summary/statistics
</verification>

<success_criteria>
- --json flag works in both compare mode and action mode
- All flag combinations produce valid JSON output
- --json --execute requires --yes (no interactive prompts)
- --json --summary produces minimal JSON with only statistics
- Text output is completely unchanged when --json is not used
- All 110 existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-json-output/06-02-SUMMARY.md`
</output>
