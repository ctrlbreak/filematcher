---
phase: 20.1-json-header-object-format
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - filematcher/formatters.py
  - tests/test_json_output.py
autonomous: true

must_haves:
  truths:
    - "JSON output has a header object containing all metadata"
    - "Header contains name, version, timestamp, mode, hashAlgorithm, directories"
    - "Compare mode uses master/duplicate directory keys, not dir1/dir2"
    - "Unmatched arrays use unmatchedMaster/unmatchedDuplicate naming"
    - "Data arrays remain at root level (matches, duplicateGroups)"
    - "All 40 JSON tests pass with new structure"
  artifacts:
    - path: "filematcher/formatters.py"
      provides: "JsonActionFormatter with header object"
      contains: '"header"'
    - path: "tests/test_json_output.py"
      provides: "Updated JSON tests for header structure"
      contains: "header"
  key_links:
    - from: "filematcher/formatters.py"
      to: "tests/test_json_output.py"
      via: "JSON structure contract"
      pattern: "header.*name.*filematcher"
---

<objective>
Restructure JSON output with unified header object for better machine parsing

Purpose: Current JSON has metadata scattered at root level with inconsistent naming between compare/action modes. This restructuring consolidates metadata into a header object with consistent directory naming, enabling better schema evolution and machine consumption.

Output: Updated JsonActionFormatter that produces header-based JSON structure and updated test suite validating the new schema.
</objective>

<execution_context>
@/Users/patrick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20.1-json-header-object-format/20.1-RESEARCH.md
@filematcher/formatters.py
@tests/test_json_output.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update JsonActionFormatter for header object structure</name>
  <files>filematcher/formatters.py</files>
  <action>
Modify JsonActionFormatter class to produce header-based JSON structure:

1. Add a helper method `_build_header()` that constructs:
   ```python
   {
       "name": "filematcher",
       "version": "2.0",
       "timestamp": datetime.now(timezone.utc).isoformat(),
       "mode": mode,  # "compare", "preview", or "execute"
       "hashAlgorithm": self._hash_algorithm,
       "directories": {
           "master": ...,
           "duplicate": ...
       }
   }
   ```
   Include "action" field only for non-compare modes.

2. Update `finalize()` method for compare mode (lines 454-502):
   - Build header with mode="compare"
   - Change directory keys from "dir1"/"dir2" to "master"/"duplicate"
   - Change "unmatchedDir1"/"unmatchedDir2" to "unmatchedMaster"/"unmatchedDuplicate"
   - Output format:
     ```json
     {
       "header": {...},
       "matches": [...],
       "unmatchedMaster": [],
       "unmatchedDuplicate": [],
       "summary": {...},
       "statistics": {...},
       "metadata": {...}  // if verbose
     }
     ```

3. Update `finalize()` method for action modes (lines 504-508):
   - Build header with mode="preview" or "execute", include "action" field
   - Action mode finalize() already outputs directories.master/duplicate via set_directories(), so header should use those existing values
   - Restructure output to include header:
     ```json
     {
       "header": {...},
       "warnings": [],
       "duplicateGroups": [...],
       "statistics": {...},
       "execution": {...}  // if execute mode
     }
     ```

4. Update `format_unmatched_section()` method (lines 398-410):
   - Change internal storage keys from "unmatchedDir1"/"unmatchedDir2" to "unmatchedMaster"/"unmatchedDuplicate"
   - Update summary field names accordingly
   - Note: Compare mode finalize() (lines 481-482) reads these keys to build output, so ensure both storage AND output use the new names

5. Remove redundant top-level fields from `_data` initialization (lines 243-254):
   - "timestamp", "mode", "action", "directories" move to header construction in finalize()
   - Keep "warnings", "duplicateGroups", "statistics" at root

Key implementation notes:
- The header is constructed fresh in finalize() with current timestamp
- Version "2.0" indicates breaking schema change from implicit v1
- Keep metadata at root level (per-file data, not run metadata)
- Maintain existing sorting for determinism
  </action>
  <verify>
Run targeted test that validates JSON structure, then run full test suite:
```bash
python3 -c "
from filematcher.formatters import JsonActionFormatter
from contextlib import redirect_stdout
import io
import json

# Test compare mode
f = JsonActionFormatter(verbose=False, preview_mode=True, action='compare')
f.set_directories('/test/master', '/test/dup')
f.set_hash_algorithm('md5')
f.format_statistics(0, 0, 0, 0, 'compare')
out = io.StringIO()
with redirect_stdout(out):
    f.finalize()
data = json.loads(out.getvalue())
assert 'header' in data, 'Missing header object'
assert data['header']['name'] == 'filematcher', 'Missing name field'
assert data['header']['version'] == '2.0', 'Wrong version'
assert 'master' in data['header']['directories'], 'Missing master dir'
assert 'duplicate' in data['header']['directories'], 'Missing duplicate dir'
print('Compare mode header: OK')

# Test action mode
f2 = JsonActionFormatter(verbose=False, preview_mode=True, action='hardlink')
f2.set_directories('/test/master', '/test/dup')
f2.set_hash_algorithm('md5')
f2.format_statistics(0, 0, 0, 0, 'hardlink')
out2 = io.StringIO()
with redirect_stdout(out2):
    f2.finalize()
data2 = json.loads(out2.getvalue())
assert 'header' in data2, 'Missing header object in action mode'
assert data2['header']['action'] == 'hardlink', 'Missing action field'
print('Action mode header: OK')
"

# Run full test suite to verify no regressions
python3 run_tests.py
```
  </verify>
  <done>
JsonActionFormatter produces JSON with header object containing name, version, timestamp, mode, hashAlgorithm, directories. Compare mode uses master/duplicate keys. Action modes include action field in header. Full test suite passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update JSON tests for new header structure</name>
  <files>tests/test_json_output.py</files>
  <action>
Update test_json_output.py to validate new header-based JSON structure:

1. Update `test_json_has_required_fields()` (line 74):
   - Check for 'header' at top level
   - Check header contains: name, version, timestamp, mode, hashAlgorithm, directories
   - Check data arrays at root: matches, summary, statistics

2. Update `test_json_timestamp_format()` (line 83):
   - Access timestamp via `data['header']['timestamp']` not `data['timestamp']`

3. Update `test_json_directories_absolute_paths()` (line 100):
   - Access directories via `data['header']['directories']`
   - Change keys from 'dir1'/'dir2' to 'master'/'duplicate'

4. Update `test_json_unmatched_with_flag()` (line 133):
   - Change 'unmatchedDir1'/'unmatchedDir2' to 'unmatchedMaster'/'unmatchedDuplicate'

5. Update `test_json_unmatched_without_flag()` (line 149):
   - Change field names to unmatchedMaster/unmatchedDuplicate

6. Update `test_json_action_directories()` (line 243):
   - Access via `data['header']['directories']`

7. Update `test_json_output_deterministic()` (line 269):
   - Remove timestamp from `data['header']` not root level

8. Update `test_json_camel_case_fields()` (line 326):
   - Update expected fields list to include 'header'
   - Change unmatchedDir1/Dir2 to unmatchedMaster/unmatchedDuplicate

9. Add new test `test_json_header_structure()`:
   ```python
   def test_json_header_structure(self):
       """Header object contains all required metadata fields."""
       data, stderr, exit_code = self.run_main_with_json()
       self.assertEqual(exit_code, 0)

       self.assertIn('header', data)
       header = data['header']

       # Required header fields
       self.assertEqual(header['name'], 'filematcher')
       self.assertEqual(header['version'], '2.0')
       self.assertIn('timestamp', header)
       self.assertEqual(header['mode'], 'compare')
       self.assertIn('hashAlgorithm', header)
       self.assertIn('directories', header)
       self.assertIn('master', header['directories'])
       self.assertIn('duplicate', header['directories'])
   ```

10. Add new test `test_json_action_header_has_action_field()`:
    ```python
    def test_json_action_header_has_action_field(self):
        """Action mode header includes action field."""
        data, stderr, exit_code = self.run_main_with_json(['--action', 'hardlink'])
        self.assertEqual(exit_code, 0)

        header = data['header']
        self.assertIn('action', header)
        self.assertEqual(header['action'], 'hardlink')
    ```

11. Update `test_json_action_mode_structure()` (line 192):
    - Check mode/action in header, not at root
    - Keep duplicateGroups check at root

12. Update all `test_json_action_*` tests that check mode/action fields to access via header

13. Update `TestJsonOutputMocked` tests (line 576+):
    - Update assertions to check header structure

14. Update `TestJsonOutputSubprocess` test (line 702+):
    - Update jq-pattern test to access header fields

Key changes summary:
- data['timestamp'] -> data['header']['timestamp']
- data['directories']['dir1'] -> data['header']['directories']['master']
- data['directories']['dir2'] -> data['header']['directories']['duplicate']
- data['unmatchedDir1'] -> data['unmatchedMaster']
- data['unmatchedDir2'] -> data['unmatchedDuplicate']
- data['mode'] -> data['header']['mode'] (action modes)
- data['action'] -> data['header']['action'] (action modes)
  </action>
  <verify>
Run the full JSON test suite:
```bash
python3 -m tests.test_json_output
```
All 40 tests should pass (40 existing tests, plus 2 new tests = 42 total after this task).
  </verify>
  <done>
All JSON tests updated to validate header-based structure. Tests verify header contains name, version, timestamp, mode, hashAlgorithm, directories with master/duplicate keys. Unmatched field names updated to unmatchedMaster/unmatchedDuplicate.
  </done>
</task>

</tasks>

<verification>
1. Run full JSON test suite: `python3 -m tests.test_json_output` - all 42+ tests pass
2. Run full test suite: `python3 run_tests.py` - all tests pass (no regressions)
3. Manual verification of JSON output structure:
   ```bash
   # Compare mode
   python3 file_matcher.py test_dir1 test_dir2 --json | python3 -c "import sys,json; d=json.load(sys.stdin); print('header:', 'name' in d.get('header',{}))"

   # Action mode
   python3 file_matcher.py test_dir1 test_dir2 --json --action hardlink | python3 -c "import sys,json; d=json.load(sys.stdin); print('header.action:', d.get('header',{}).get('action'))"
   ```
</verification>

<success_criteria>
1. JSON output has `header` object at top level in both compare and action modes
2. Header contains: name="filematcher", version="2.0", timestamp, mode, hashAlgorithm, directories
3. Header.directories uses master/duplicate keys (not dir1/dir2)
4. Action modes include action field in header
5. Unmatched arrays renamed to unmatchedMaster/unmatchedDuplicate
6. All JSON tests pass (42+ tests after adding new tests)
7. Full test suite passes (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/20.1-json-header-object-format/20.1-01-SUMMARY.md`
</output>
