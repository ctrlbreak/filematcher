---
phase: 07-output-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [file_matcher.py]
autonomous: true

must_haves:
  truths:
    - "Logger output goes to stderr in all modes (not just JSON)"
    - "--quiet/-q flag suppresses progress, warnings, and headers"
    - "Data output (match groups, statistics) still goes to stdout"
    - "Errors still display even with --quiet"
  artifacts:
    - path: "file_matcher.py"
      provides: "--quiet/-q CLI flag and stderr routing"
      contains: "add_argument.*--quiet"
  key_links:
    - from: "main() logging setup"
      to: "sys.stderr"
      via: "logging.StreamHandler"
      pattern: "StreamHandler.*stderr"
---

<objective>
Implement stream separation (stdout/stderr) and add --quiet flag for text mode

Purpose: Foundational work for OUT-03 requirement. Route all logger output to stderr (currently only JSON mode does this) and add --quiet flag to suppress non-data output. This enables clean piping (`filematcher dir1 dir2 | grep pattern`).

Output: Modified file_matcher.py with stderr routing for all modes and --quiet flag support
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-output-unification/07-CONTEXT.md
@.planning/phases/07-output-unification/07-RESEARCH.md
@file_matcher.py (lines 1720-1728 for current logging setup)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Route logger to stderr for all modes</name>
  <files>file_matcher.py</files>
  <action>
  Modify the logging configuration in main() (around line 1720-1728) to ALWAYS route logger output to stderr, not just when --json is used.

  Current code:
  ```python
  log_stream = sys.stderr if args.json else sys.stdout
  ```

  Change to:
  ```python
  log_stream = sys.stderr  # Always stderr for progress/status (Unix convention)
  ```

  This aligns text mode with JSON mode behavior. The logger output includes:
  - "Using MD5/SHA256 hashing algorithm"
  - "Fast mode enabled..."
  - "Verbose mode enabled..."
  - "Indexing directory..."
  - Per-file progress in verbose mode

  All these are status messages and belong on stderr per Unix convention.
  </action>
  <verify>
  Run: `python3 file_matcher.py test_dir1 test_dir2 2>/dev/null | head -5`
  Expected: Output shows only data (hash groups), no "Using MD5..." message

  Run: `python3 file_matcher.py test_dir1 test_dir2 2>&1 >/dev/null | head -3`
  Expected: Shows "Using MD5..." on stderr
  </verify>
  <done>
  Logger output goes to stderr in all modes, not just --json mode. Data output (match groups) remains on stdout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --quiet/-q CLI flag</name>
  <files>file_matcher.py</files>
  <action>
  Add --quiet/-q argument to argparse in main() (after the --json argument, around line 1695):

  ```python
  parser.add_argument('--quiet', '-q', action='store_true',
                      help='Suppress progress, warnings, and headers - only output data')
  ```

  Then modify the logging configuration to respect --quiet:

  ```python
  # Configure logging based on verbosity and quiet mode
  # --quiet suppresses all status messages (only errors get through)
  if args.quiet:
      log_level = logging.ERROR
  elif args.verbose:
      log_level = logging.DEBUG
  else:
      log_level = logging.INFO

  log_stream = sys.stderr  # Always stderr for progress/status (Unix convention)
  handler = logging.StreamHandler(log_stream)
  handler.setFormatter(logging.Formatter('%(message)s'))
  logger.handlers = [handler]
  logger.setLevel(log_level)
  ```

  This ensures:
  - --quiet sets log level to ERROR (only errors get through)
  - --verbose still works (DEBUG level) when not --quiet
  - Default is INFO level

  Note: --quiet only affects logger output for now. Header/summary suppression will be added in plan 07-02 when unified headers are implemented.
  </action>
  <verify>
  Run: `python3 file_matcher.py test_dir1 test_dir2 --quiet 2>&1 | head -5`
  Expected: No "Using MD5..." line, only data output

  Run: `python3 file_matcher.py test_dir1 test_dir2 --quiet --verbose 2>&1 | head -3`
  Expected: --quiet takes precedence, no verbose output (ERROR level only)

  Run: `python3 file_matcher.py --help | grep -A1 -- --quiet`
  Expected: Shows --quiet, -q and help text
  </verify>
  <done>
  --quiet/-q flag exists, suppresses logger output (progress/status), but errors still display. Data output (match groups, statistics) still appears on stdout.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify existing tests pass</name>
  <files>run_tests.py, tests/*.py</files>
  <action>
  Run the full test suite to verify no regressions.

  The changes may cause test failures in tests that:
  1. Capture stdout and expect logger messages (these now go to stderr)
  2. Parse combined stdout/stderr output

  If tests fail:
  - For tests using `redirect_stdout`, update to capture both streams or adjust assertions
  - Tests checking for "Using MD5..." in stdout need to check stderr instead
  - Use `subprocess.run(capture_output=True)` tests as reference - they already capture both streams

  Common patterns that may need updating:
  - `with redirect_stdout(captured):` - may need `redirect_stderr` addition
  - `mock.patch('sys.stdout')` - may need `sys.stderr` patch addition
  - Assertions checking `captured.getvalue()` for logger messages
  </action>
  <verify>
  Run: `python3 run_tests.py`
  Expected: All tests pass (adjust tests if needed, but preserve test intent)
  </verify>
  <done>
  All existing tests pass. Any tests updated to account for stderr routing preserve their original test intent (verifying the same behaviors, just checking different streams).
  </done>
</task>

</tasks>

<verification>
Overall phase checks:

1. Stream separation working:
   - `python3 file_matcher.py test_dir1 test_dir2 2>/dev/null` shows only data
   - `python3 file_matcher.py test_dir1 test_dir2 >/dev/null` shows only status messages

2. --quiet flag working:
   - `python3 file_matcher.py test_dir1 test_dir2 --quiet` suppresses progress
   - `python3 file_matcher.py nonexistent nothere --quiet` still shows error

3. All tests pass:
   - `python3 run_tests.py` exits 0

4. JSON mode unchanged:
   - `python3 file_matcher.py test_dir1 test_dir2 --json` still works correctly
</verification>

<success_criteria>
- Logger output goes to stderr in ALL modes (compare and action), not just --json
- --quiet/-q flag suppresses progress/status messages (log level ERROR)
- Data output (match groups, statistics) remains on stdout
- Error messages still display even with --quiet
- All 114+ existing tests pass (with any necessary test adjustments)
- JSON mode behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/07-output-unification/07-01-SUMMARY.md`
</output>
