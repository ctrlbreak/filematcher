---
phase: 07-output-unification
plan: 03
type: execute
wave: 2
depends_on: [07-01]
files_modified: [file_matcher.py]
autonomous: true

must_haves:
  truths:
    - "Compare mode shows statistics footer after match groups"
    - "Statistics footer shows: duplicate groups count, file counts, space reclaimable"
    - "Compare mode and action mode use same statistics format (consistent structure)"
    - "Statistics appear in both summary mode (--summary) and detailed mode"
  artifacts:
    - path: "file_matcher.py"
      provides: "Statistics footer in compare mode via TextCompareFormatter"
      contains: "format_statistics"
  key_links:
    - from: "main() compare mode"
      to: "formatter.format_statistics()"
      via: "method call after match groups"
---

<objective>
Add statistics footer to compare mode for consistent output structure with action mode

Purpose: OUT-02 requires statistics footer in all modes. Currently only action mode shows statistics. This plan adds statistics footer to compare mode using the same format as action mode, ensuring consistent output structure (OUT-01).

Output: Modified file_matcher.py with statistics footer in compare mode
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-output-unification/07-CONTEXT.md
@.planning/phases/07-output-unification/07-RESEARCH.md
@.planning/phases/07-output-unification/07-01-SUMMARY.md
@file_matcher.py (lines 252-266 for TextCompareFormatter.format_summary, lines 2026-2071 for compare mode in main())
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add format_statistics method to CompareFormatter ABC</name>
  <files>file_matcher.py</files>
  <action>
  Add a new abstract method to CompareFormatter ABC for statistics footer (around line 83, after format_summary):

  ```python
  @abstractmethod
  def format_statistics(
      self,
      group_count: int,
      file_count: int,
      space_savings: int
  ) -> None:
      """Format and output the statistics footer.

      Args:
          group_count: Number of unique content hashes with matches
          file_count: Total number of files involved in matches
          space_savings: Bytes potentially reclaimable (0 if not computed)
      """
      pass
  ```

  Note: This method is distinct from format_summary (which shows summary stats in a different format). format_statistics creates the footer block similar to action mode's "--- Statistics ---" section.
  </action>
  <verify>
  Run: `python3 -c "import file_matcher"` - will fail until implementations added
  </verify>
  <done>
  CompareFormatter ABC has format_statistics abstract method.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement format_statistics in TextCompareFormatter and JsonCompareFormatter</name>
  <files>file_matcher.py</files>
  <action>
  **TextCompareFormatter** (around line 267, after format_summary):

  ```python
  def format_statistics(self, group_count: int, file_count: int, space_savings: int) -> None:
      """Format statistics footer matching action mode format."""
      print()
      print("--- Statistics ---")
      print(f"Duplicate groups: {group_count}")
      print(f"Total files with matches: {file_count}")
      if space_savings > 0:
          print(f"Space reclaimable: {format_file_size(space_savings)}")
      else:
          print("Space reclaimable: (run with --action to calculate)")
  ```

  Note: In compare mode, we don't compute exact space savings because we don't determine master/duplicate relationships. The message guides users to action mode for this.

  **JsonCompareFormatter** (around line 400, before finalize):

  ```python
  def format_statistics(self, group_count: int, file_count: int, space_savings: int) -> None:
      """Store statistics data for JSON output."""
      self._statistics = {
          "duplicateGroups": group_count,
          "totalFilesWithMatches": file_count,
          "spaceReclaimable": space_savings,
          "spaceReclaimableFormatted": format_file_size(space_savings) if space_savings > 0 else None
      }
  ```

  Also update JsonCompareFormatter.finalize() to include statistics in output if set.
  </action>
  <verify>
  Run: `python3 -c "import file_matcher; print('OK')"`
  Expected: No import errors
  </verify>
  <done>
  Both TextCompareFormatter and JsonCompareFormatter have format_statistics implemented with consistent data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire statistics footer into compare mode in main()</name>
  <files>file_matcher.py</files>
  <action>
  Update the compare mode section in main() (around line 2040-2071) to call format_statistics after match groups are output.

  In the detailed output section (when not args.summary), after the match group loop and unmatched files section:

  ```python
  # ... existing match group loop ...

  # Optionally display unmatched files (detailed mode)
  if args.show_unmatched:
      if not args.json:
          print("\nFiles with no content matches:")
          print("==============================")
      compare_formatter.format_unmatched(args.dir1, unmatched1)
      compare_formatter.format_unmatched(args.dir2, unmatched2)

  # NEW: Add statistics footer (before finalize)
  if not args.summary:  # Summary mode has its own stats display
      compare_formatter.format_statistics(
          group_count=len(matches),
          file_count=matched_files1 + matched_files2,
          space_savings=0  # Compare mode doesn't compute this
      )

  # Always call format_summary for JSON to ensure summary field is populated
  if args.json:
      compare_formatter.format_summary(...)
  ```

  Also verify that the summary mode (args.summary) section doesn't need modification - it already shows statistics in a different format.

  For JSON mode, ensure format_statistics is called so the statistics object is included in output.
  </action>
  <verify>
  Run: `python3 file_matcher.py test_dir1 test_dir2 2>/dev/null | tail -10`
  Expected: Shows "--- Statistics ---" footer with group count, file count

  Run: `python3 file_matcher.py test_dir1 test_dir2 --summary 2>/dev/null`
  Expected: Summary mode still works (shows summary stats, not footer)

  Run: `python3 file_matcher.py test_dir1 test_dir2 --json 2>/dev/null | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('statistics', 'NO STATS'))"`
  Expected: Shows statistics object

  Run: `python3 run_tests.py`
  Expected: All tests pass
  </verify>
  <done>
  Compare mode shows statistics footer after match groups. Both text and JSON modes include statistics. All tests pass.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:

1. Compare mode statistics footer:
   - `python3 file_matcher.py dir1 dir2` shows "--- Statistics ---" at bottom
   - Shows duplicate groups count and file count
   - Shows "(run with --action to calculate)" for space savings

2. Summary mode unchanged:
   - `python3 file_matcher.py dir1 dir2 --summary` works as before

3. Action mode statistics unchanged:
   - `python3 file_matcher.py dir1 dir2 --action hardlink` still shows its statistics

4. Consistent structure:
   - Both modes have header, data, statistics footer (same ordering)

5. JSON includes statistics:
   - `python3 file_matcher.py dir1 dir2 --json` includes statistics field

6. All tests pass:
   - `python3 run_tests.py` exits 0
</verification>

<success_criteria>
- Compare mode shows "--- Statistics ---" footer after match groups
- Statistics footer shows: duplicate groups count, total files with matches
- Space reclaimable shows helpful message directing to --action mode
- Summary mode (--summary) continues to work unchanged
- Action mode statistics unchanged
- JSON output includes statistics object in compare mode
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-output-unification/07-03-SUMMARY.md`
</output>
