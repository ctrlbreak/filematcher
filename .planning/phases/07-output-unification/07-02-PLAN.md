---
phase: 07-output-unification
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified: [file_matcher.py]
autonomous: true

must_haves:
  truths:
    - "Compare mode shows unified header: 'Compare mode: dir1 vs dir2'"
    - "Action mode shows unified header with state: 'Action mode (PREVIEW): hardlink dir1 vs dir2'"
    - "Action mode execute shows: 'Action mode (EXECUTING): hardlink dir1 vs dir2'"
    - "Summary one-liner appears after header: 'Found N duplicate groups (M files, X reclaimable)'"
    - "--quiet suppresses header and summary line, but data sections still appear"
  artifacts:
    - path: "file_matcher.py"
      provides: "Unified header format methods in formatters"
      contains: "def format_header"
  key_links:
    - from: "main() compare mode"
      to: "formatter.format_header()"
      via: "method call before data output"
    - from: "main() action mode"
      to: "formatter.format_header()"
      via: "method call before data output"
---

<objective>
Implement unified header format and summary line for both compare and action modes

Purpose: OUT-01 requires consistent output structure. This plan adds mode-explicit headers that clearly distinguish compare mode, action preview mode, and action execute mode. Also adds summary one-liner after header showing key statistics at a glance.

Output: Modified file_matcher.py with unified header/summary formatting across all modes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-output-unification/07-CONTEXT.md
@.planning/phases/07-output-unification/07-RESEARCH.md
@.planning/phases/07-output-unification/07-01-SUMMARY.md
@file_matcher.py (lines 32-200 for formatter ABCs, lines 1667-2076 for main())
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CompareFormatter ABC with header methods</name>
  <files>file_matcher.py</files>
  <action>
  The CompareFormatter ABC already has a format_header method (line 51), but TextCompareFormatter's implementation is a no-op. Update to support unified header format.

  In CompareFormatter ABC, the existing format_header signature is:
  ```python
  def format_header(self, dir1: str, dir2: str, hash_algo: str) -> None:
  ```

  Add a new method to CompareFormatter ABC for the summary line:
  ```python
  @abstractmethod
  def format_summary_line(self, group_count: int, duplicate_count: int, space_savings: int) -> None:
      """Format and output the one-liner summary after header.

      Args:
          group_count: Number of duplicate groups found
          duplicate_count: Total number of duplicate files
          space_savings: Bytes reclaimable
      """
      pass
  ```

  Note: This adds a new abstract method. All CompareFormatter subclasses (TextCompareFormatter, JsonCompareFormatter) must implement it.
  </action>
  <verify>
  Check syntax: `python3 -c "import file_matcher"`
  Expected: No import errors (will fail until implementations added in next task)
  </verify>
  <done>
  CompareFormatter ABC has format_summary_line abstract method alongside existing format_header.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement unified header/summary in TextCompareFormatter and TextActionFormatter</name>
  <files>file_matcher.py</files>
  <action>
  **TextCompareFormatter** (around line 205):

  Update format_header implementation:
  ```python
  def format_header(self, dir1: str, dir2: str, hash_algo: str) -> None:
      """Format comparison header showing mode and directories."""
      print(f"Compare mode: {dir1} vs {dir2}")
  ```

  Add format_summary_line implementation:
  ```python
  def format_summary_line(self, group_count: int, duplicate_count: int, space_savings: int) -> None:
      """Format one-liner summary after header."""
      from file_matcher import format_file_size  # Import if needed
      space_str = format_file_size(space_savings)
      print(f"Found {group_count} duplicate groups ({duplicate_count} files, {space_str} reclaimable)")
      print()  # Blank line after summary
  ```

  **TextActionFormatter** (around line 583):

  The ActionFormatter ABC doesn't have format_header - it has format_banner. We need to:
  1. Keep format_banner for backward compatibility (tests may use it)
  2. Update format_banner to output the unified header format

  Update format_banner in TextActionFormatter:
  ```python
  def format_banner(self) -> None:
      """Format and output the unified mode header."""
      # Get directories and action from instance - need to add these
      state = "PREVIEW" if self.preview_mode else "EXECUTING"
      # Note: action and directories need to be passed to formatter
      # For now, use existing banner format but with clearer state indicator
      if self.preview_mode:
          print("=" * 60)
          print("=== PREVIEW MODE - No changes will be made ===")
          print("=" * 60)
      else:
          print("=" * 60)
          print("=== EXECUTING - Changes will be made ===")
          print("=" * 60)
  ```

  Actually, better approach: Add a new method format_unified_header to ActionFormatter that takes the action and directories, and update main() to call it. Keep format_banner for the prominent warning banner.

  Add to ActionFormatter ABC (around line 117):
  ```python
  @abstractmethod
  def format_unified_header(self, action: str, dir1: str, dir2: str) -> None:
      """Format and output the unified mode header with directories.

      Args:
          action: Action type (hardlink, symlink, delete)
          dir1: Master directory path
          dir2: Duplicate directory path
      """
      pass
  ```

  Add to ActionFormatter ABC:
  ```python
  @abstractmethod
  def format_summary_line(self, group_count: int, duplicate_count: int, space_savings: int) -> None:
      """Format and output the one-liner summary after header.

      Args:
          group_count: Number of duplicate groups found
          duplicate_count: Total number of duplicate files
          space_savings: Bytes reclaimable
      """
      pass
  ```

  Implement in TextActionFormatter:
  ```python
  def format_unified_header(self, action: str, dir1: str, dir2: str) -> None:
      """Format unified header showing mode, state, action and directories."""
      state = "PREVIEW" if self.preview_mode else "EXECUTING"
      print(f"Action mode ({state}): {action} {dir1} vs {dir2}")

  def format_summary_line(self, group_count: int, duplicate_count: int, space_savings: int) -> None:
      """Format one-liner summary after header."""
      space_str = format_file_size(space_savings)
      print(f"Found {group_count} duplicate groups ({duplicate_count} files, {space_str} reclaimable)")
      print()  # Blank line after summary
  ```

  **JsonCompareFormatter** (around line 272):

  Implement format_summary_line (may already have similar logic - integrate):
  ```python
  def format_summary_line(self, group_count: int, duplicate_count: int, space_savings: int) -> None:
      """Store summary line data for JSON output."""
      # JSON formatter already accumulates - this ensures data is captured
      # The finalize() method will include this in output
      self._summary_line = {
          "duplicateGroups": group_count,
          "duplicateFiles": duplicate_count,
          "spaceReclaimable": space_savings
      }
  ```

  **JsonActionFormatter** (around line 407):

  Implement format_unified_header and format_summary_line:
  ```python
  def format_unified_header(self, action: str, dir1: str, dir2: str) -> None:
      """Store header data for JSON output."""
      # Already have set_directories, this adds action context
      self._action = action

  def format_summary_line(self, group_count: int, duplicate_count: int, space_savings: int) -> None:
      """Store summary line data for JSON output."""
      self._summary_line = {
          "duplicateGroups": group_count,
          "duplicateFiles": duplicate_count,
          "spaceReclaimable": space_savings
      }
  ```
  </action>
  <verify>
  Run: `python3 -c "import file_matcher; print('OK')"`
  Expected: No import errors

  Run: `python3 file_matcher.py test_dir1 test_dir2 2>/dev/null | head -3`
  Expected: Shows "Compare mode: test_dir1 vs test_dir2" followed by summary line

  Run: `python3 file_matcher.py test_dir1 test_dir2 --action hardlink 2>/dev/null | head -3`
  Expected: Shows "Action mode (PREVIEW): hardlink test_dir1 vs test_dir2"
  </verify>
  <done>
  All formatter classes have format_header (or format_unified_header for action) and format_summary_line methods implemented.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire unified headers into main() and implement --quiet header suppression</name>
  <files>file_matcher.py</files>
  <action>
  Update main() to call the new header/summary methods.

  **Compare mode section** (around line 2010-2071):

  Before the existing output logic, add header and summary calls:
  ```python
  else:
      # Original output format (no master mode / compare mode)
      if args.json:
          compare_formatter = JsonCompareFormatter(...)
          compare_formatter.format_header(args.dir1, args.dir2, hash_algo)
      else:
          compare_formatter = TextCompareFormatter(...)
          # Output unified header (unless --quiet)
          if not args.quiet:
              compare_formatter.format_header(args.dir1, args.dir2, hash_algo)

      # Calculate summary stats for header summary line
      # Need to compute space savings - similar to action mode
      total_duplicate_count = matched_files1 + matched_files2 - len(matches)  # Approx
      # For accurate space savings, need to compute file sizes
      # Simplified: use matched_files as proxy
      space_savings = 0  # Will be computed properly after match processing

      # ... rest of compare mode logic ...
  ```

  Actually, to compute space savings in compare mode, we need file sizes. The current compare mode doesn't track this. For simplicity, the summary line can show "0 B" or we can defer space savings to action mode only.

  Better approach: Show count-only summary in compare mode:
  ```python
  if not args.quiet and not args.summary:
      compare_formatter.format_summary_line(
          group_count=len(matches),
          duplicate_count=matched_files1 + matched_files2,
          space_savings=0  # Space savings only meaningful in action mode
      )
  ```

  Or modify format_summary_line to be optional for space savings display.

  **Action mode section** (around line 1749-2009):

  In print_preview_output helper (line 1792), add unified header call:
  ```python
  def print_preview_output(formatter: ActionFormatter, show_banner: bool = True) -> None:
      # Add unified header before banner (unless --quiet)
      if not args.quiet and not args.json:
          formatter.format_unified_header(args.action, args.dir1, args.dir2)

          # Calculate space savings for summary line
          bytes_saved, dup_count, grp_count = calculate_space_savings(master_results)
          formatter.format_summary_line(grp_count, dup_count, bytes_saved)

      if show_banner:
          formatter.format_banner()
      # ... rest of function
  ```

  Note: The format_banner() call should come AFTER the unified header but is still useful for the prominent "=== PREVIEW MODE ===" warning in text mode. Keep both.

  For JSON mode, the header data is accumulated and output in finalize(). Make sure format_unified_header is called for JSON too.
  </action>
  <verify>
  Run: `python3 file_matcher.py test_dir1 test_dir2 2>/dev/null | head -5`
  Expected: Shows unified header and summary line

  Run: `python3 file_matcher.py test_dir1 test_dir2 --quiet 2>/dev/null | head -5`
  Expected: No header, just data

  Run: `python3 file_matcher.py test_dir1 test_dir2 --action hardlink 2>/dev/null | head -7`
  Expected: Shows "Action mode (PREVIEW)..." header, summary line, then banner

  Run: `python3 run_tests.py`
  Expected: All tests pass
  </verify>
  <done>
  Unified headers and summary lines appear in both modes. --quiet suppresses them while preserving data output. All tests pass.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:

1. Compare mode header:
   - `python3 file_matcher.py dir1 dir2` shows "Compare mode: dir1 vs dir2"
   - Followed by summary line

2. Action mode preview header:
   - `python3 file_matcher.py dir1 dir2 --action hardlink` shows "Action mode (PREVIEW): hardlink..."
   - PREVIEW state clearly indicated

3. Action mode execute header:
   - `python3 file_matcher.py dir1 dir2 --action hardlink --execute --yes` shows "Action mode (EXECUTING): hardlink..."
   - EXECUTING state clearly indicated

4. --quiet suppression:
   - `python3 file_matcher.py dir1 dir2 --quiet` shows no header but shows data
   - Data output unchanged

5. All tests pass:
   - `python3 run_tests.py` exits 0
</verification>

<success_criteria>
- Compare mode shows "Compare mode: dir1 vs dir2" header
- Action mode preview shows "Action mode (PREVIEW): action dir1 vs dir2"
- Action mode execute shows "Action mode (EXECUTING): action dir1 vs dir2"
- Summary one-liner appears after header: "Found N duplicate groups (M files, X reclaimable)"
- --quiet suppresses header and summary line
- Data sections still appear with --quiet
- JSON output includes header information in appropriate fields
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-output-unification/07-02-SUMMARY.md`
</output>
